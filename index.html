
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Naija Love Quest üíö v6</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;800&family=Nunito:wght@400;600;700;800&display=swap');

:root {
  --green:#008751; --green-light:#00b86b; --gold:#FFD700; --cream:#FFF8E7;
  --brown:#5C3317; --pink:#FF6B9D; --blue:#4A90E2; --red:#E74C3C;
  --purple:#9B59B6; --dark:#1a1a2e; --card:rgba(255,255,255,0.97);
  --orange:#FF6B35; --teal:#00BCD4;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;height:100dvh;overflow:hidden;touch-action:manipulation;}
body{font-family:'Nunito',sans-serif;background:#000;display:flex;justify-content:center;align-items:stretch;}
#app{width:100%;max-width:430px;height:100%;height:100dvh;position:relative;background:linear-gradient(160deg,#0f3460 0%,#1a1a2e 50%,#16213e 100%);overflow:hidden;display:flex;flex-direction:column;}

/* ====== NEW FEATURE STYLES v4 ====== */

/* CUTSCENE */
.cutscene-overlay{position:absolute;inset:0;background:#000;z-index:300;display:none;flex-direction:column;justify-content:center;align-items:center;padding:24px;text-align:center;}
.cutscene-overlay.show{display:flex;}
.cutscene-emoji{font-size:72px;margin-bottom:16px;animation:pop-in .5s cubic-bezier(.34,1.56,.64,1);}
.cutscene-title{font-family:'Baloo 2',cursive;font-size:26px;font-weight:800;color:var(--gold);margin-bottom:10px;}
.cutscene-text{color:rgba(255,255,255,.85);font-size:14px;line-height:1.7;margin-bottom:20px;max-width:320px;}
.cutscene-sub{font-size:11px;color:rgba(255,215,0,.6);margin-bottom:20px;font-style:italic;}

/* JEALOUSY WARNING */
.jealousy-bar{background:rgba(231,76,60,.15);border:1px solid rgba(231,76,60,.4);border-radius:10px;padding:10px 14px;margin:8px 0;display:none;}
.jealousy-bar.show{display:block;}
.jealousy-bar-text{color:#ff6b6b;font-size:11px;font-weight:800;}

/* MEET FAMILY SCREEN */
#family-screen{background:linear-gradient(160deg,#1a3a1a,#0f2010);}
.family-member{background:rgba(255,255,255,.07);border:2px solid rgba(255,255,255,.12);border-radius:14px;padding:14px;margin-bottom:10px;cursor:pointer;transition:all .2s;}
.family-member:active{transform:scale(.97);}
.family-member.approved{border-color:var(--green);}
.family-member.skeptical{border-color:var(--gold);}
.family-member.hostile{border-color:var(--red);}
.fm-row{display:flex;align-items:center;gap:12px;}
.fm-emoji{font-size:36px;flex-shrink:0;}
.fm-name{font-family:'Baloo 2',cursive;font-size:15px;color:white;font-weight:800;}
.fm-role{font-size:11px;color:rgba(255,255,255,.5);margin-top:2px;}
.fm-attitude{font-size:11px;margin-top:6px;padding:3px 8px;border-radius:8px;display:inline-block;font-weight:800;}
.fm-attitude.good{background:rgba(0,135,81,.2);color:var(--green-light);}
.fm-attitude.neutral{background:rgba(255,215,0,.2);color:var(--gold);}
.fm-attitude.bad{background:rgba(231,76,60,.2);color:#ff6b6b;}

/* NPC INITIATED TEXT */
.npc-text-popup{position:absolute;bottom:80px;left:12px;right:12px;background:linear-gradient(135deg,#1a1a3e,#0f3460);border:2px solid var(--green);border-radius:16px;padding:14px;z-index:100;animation:slideUp .4s cubic-bezier(.34,1.56,.64,1);display:none;}
.npc-text-popup.show{display:flex;gap:10px;align-items:flex-start;}
@keyframes slideUp{from{transform:translateY(80px);opacity:0;}to{transform:translateY(0);opacity:1;}}
.npc-text-avatar{width:40px;height:40px;border-radius:50%;overflow:hidden;flex-shrink:0;}
.npc-text-content{flex:1;}
.npc-text-name{font-family:'Baloo 2',cursive;font-size:13px;color:var(--green-light);font-weight:800;margin-bottom:3px;}
.npc-text-msg{font-size:12px;color:white;line-height:1.4;}
.npc-text-close{background:none;border:none;color:rgba(255,255,255,.4);font-size:18px;cursor:pointer;flex-shrink:0;}

/* ANNIVERSARY BADGE */
.anniversary-badge{background:linear-gradient(135deg,var(--gold),#ff6b35);color:#1a1a2e;border-radius:12px;padding:8px 12px;margin-bottom:10px;font-size:12px;font-weight:800;text-align:center;display:none;}
.anniversary-badge.show{display:block;}

/* MILESTONE TRACK */
.milestone-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px;}
.milestone-pip{width:28px;height:28px;border-radius:50%;background:rgba(255,255,255,.1);border:2px solid rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:13px;transition:all .3s;}
.milestone-pip.done{background:linear-gradient(135deg,var(--gold),#ff6b35);border-color:var(--gold);}

/* ====== MINI-GAMES v4 ====== */

/* RHYTHM GAME (Suya/Dance) */
.rhythm-game{position:absolute;inset:0;background:rgba(10,5,30,.97);z-index:250;display:none;flex-direction:column;align-items:center;justify-content:flex-start;padding-top:30px;}
.rhythm-game.show{display:flex;}
.rhythm-title{font-family:'Baloo 2',cursive;font-size:22px;color:var(--gold);font-weight:800;margin-bottom:6px;text-align:center;}
.rhythm-sub{font-size:12px;color:rgba(255,255,255,.6);margin-bottom:16px;text-align:center;}
.rhythm-track{width:100%;max-width:380px;height:320px;position:relative;background:rgba(255,255,255,.03);border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,.1);}
.rhythm-lanes{display:flex;width:100%;height:100%;}
.rhythm-lane{flex:1;border-right:1px solid rgba(255,255,255,.08);position:relative;display:flex;flex-direction:column;justify-content:flex-end;align-items:center;padding-bottom:12px;cursor:pointer;-webkit-tap-highlight-color:transparent;}
.rhythm-lane:last-child{border-right:none;}
.rhythm-hit-zone{width:44px;height:44px;border-radius:50%;border:3px solid rgba(255,255,255,.3);display:flex;align-items:center;justify-content:center;font-size:20px;transition:transform .1s;}
.rhythm-hit-zone.flash{transform:scale(1.3);border-color:var(--gold);}
.rhythm-note{position:absolute;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;animation:notefall linear forwards;}
@keyframes notefall{from{top:-40px;}to{top:100%;}}
.rhythm-score-bar{display:flex;align-items:center;gap:10px;margin-bottom:10px;width:100%;max-width:380px;padding:0 4px;}
.rhythm-combo{font-family:'Baloo 2',cursive;font-size:18px;color:var(--gold);font-weight:800;min-width:60px;}
.rhythm-accuracy{flex:1;height:8px;background:rgba(255,255,255,.1);border-radius:10px;overflow:hidden;}
.rhythm-accuracy-fill{height:100%;background:linear-gradient(90deg,var(--green),var(--gold));transition:width .3s;}
.rhythm-feedback{position:absolute;left:50%;transform:translateX(-50%);font-family:'Baloo 2',cursive;font-size:18px;font-weight:800;pointer-events:none;transition:all .3s;opacity:0;}
.rhythm-feedback.show{animation:feedbackPop .6s ease forwards;}
@keyframes feedbackPop{0%{opacity:1;transform:translateX(-50%) translateY(0) scale(1);}60%{opacity:1;transform:translateX(-50%) translateY(-30px) scale(1.3);}100%{opacity:0;transform:translateX(-50%) translateY(-60px) scale(.8);}}

/* JOLLOF COOK-OFF */
.cookoff-game{position:absolute;inset:0;background:rgba(10,5,30,.97);z-index:250;display:none;flex-direction:column;align-items:center;padding:20px;}
.cookoff-game.show{display:flex;}
.cookoff-title{font-family:'Baloo 2',cursive;font-size:20px;color:var(--gold);font-weight:800;margin-bottom:4px;text-align:center;}
.cookoff-steps{display:flex;flex-direction:column;gap:10px;width:100%;max-width:360px;margin-top:12px;flex:1;overflow-y:auto;}
.cookoff-step{background:rgba(255,255,255,.06);border:2px solid rgba(255,255,255,.1);border-radius:14px;padding:12px;cursor:pointer;transition:all .2s;}
.cookoff-step:active{transform:scale(.97);}
.cookoff-step.correct{border-color:var(--green);background:rgba(0,135,81,.2);}
.cookoff-step.wrong{border-color:var(--red);background:rgba(231,76,60,.15);}
.cookoff-step.completed{opacity:.5;pointer-events:none;}
.cookoff-emoji{font-size:28px;margin-bottom:4px;}
.cookoff-text{font-size:13px;color:white;font-weight:700;}
.cookoff-progress{display:flex;gap:6px;margin-bottom:12px;}
.cookoff-pip{width:20px;height:6px;border-radius:3px;background:rgba(255,255,255,.15);}
.cookoff-pip.done{background:var(--green);}

/* PHOTO GAME */
.photo-game{position:absolute;inset:0;background:rgba(5,10,25,.97);z-index:250;display:none;flex-direction:column;align-items:center;padding:20px;}
.photo-game.show{display:flex;}
.photo-viewfinder{width:260px;height:260px;border-radius:12px;border:3px solid var(--gold);position:relative;overflow:hidden;background:rgba(255,255,255,.03);margin:12px 0;cursor:crosshair;}
.photo-subject{position:absolute;font-size:40px;transition:all .3s;pointer-events:none;}
.photo-reticle{position:absolute;width:60px;height:60px;border:2px solid rgba(255,215,0,.7);border-radius:8px;pointer-events:none;transition:all .1s;}
.photo-snap-btn{width:64px;height:64px;border-radius:50%;background:white;border:4px solid var(--gold);font-size:28px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 15px rgba(255,215,0,.4);transition:transform .1s;margin-top:8px;}
.photo-snap-btn:active{transform:scale(.9);}
.photo-score-row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:10px;}
.photo-criteria{background:rgba(255,255,255,.07);border-radius:8px;padding:5px 10px;font-size:11px;color:rgba(255,255,255,.6);}
.photo-criteria.met{background:rgba(0,135,81,.2);color:var(--green-light);font-weight:800;}

/* CHESS GAME */
.chess-game{position:absolute;inset:0;background:rgba(5,10,25,.97);z-index:250;display:none;flex-direction:column;align-items:center;padding:16px;}
.chess-game.show{display:flex;}
.chess-board{display:grid;grid-template-columns:repeat(8,1fr);width:280px;height:280px;border:2px solid var(--gold);border-radius:4px;overflow:hidden;margin:10px 0;}
.chess-cell{display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;transition:all .2s;}
.chess-cell.light{background:#f0d9b5;}
.chess-cell.dark{background:#b58863;}
.chess-cell.selected{background:rgba(255,215,0,.5)!important;}
.chess-cell.possible-move{background:rgba(0,135,81,.5)!important;}
.chess-cell.last-move{background:rgba(74,144,226,.35)!important;}
.chess-status{font-family:'Baloo 2',cursive;font-size:13px;color:white;font-weight:700;text-align:center;margin-bottom:6px;min-height:20px;}
.chess-captures{display:flex;gap:4px;flex-wrap:wrap;min-height:20px;margin-bottom:4px;}

/* LEGAL DEBATE */
.debate-game{position:absolute;inset:0;background:rgba(5,5,20,.97);z-index:250;display:none;flex-direction:column;padding:20px;}
.debate-game.show{display:flex;}
.debate-case{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:14px;margin-bottom:14px;font-size:13px;color:rgba(255,255,255,.9);line-height:1.6;}
.debate-case-title{font-family:'Baloo 2',cursive;font-size:14px;color:var(--gold);font-weight:800;margin-bottom:6px;}
.debate-args{display:flex;flex-direction:column;gap:8px;flex:1;overflow-y:auto;}
.debate-arg{background:rgba(255,255,255,.06);border:2px solid rgba(255,255,255,.12);border-radius:12px;padding:11px;cursor:pointer;transition:all .2s;font-size:12px;color:rgba(255,255,255,.85);font-weight:600;line-height:1.4;}
.debate-arg:active{transform:scale(.98);}
.debate-arg.strong{border-color:rgba(0,135,81,.5);}
.debate-arg.weak{border-color:rgba(231,76,60,.4);}
.debate-arg.selected-good{border-color:var(--green);background:rgba(0,135,81,.2);}
.debate-arg.selected-bad{border-color:var(--red);background:rgba(231,76,60,.2);}
.debate-score-row{display:flex;gap:8px;margin-bottom:10px;}
.debate-score-box{flex:1;background:rgba(255,255,255,.07);border-radius:10px;padding:8px;text-align:center;}
.debate-score-label{font-size:9px;color:rgba(255,255,255,.5);text-transform:uppercase;font-weight:800;}
.debate-score-val{font-family:'Baloo 2',cursive;font-size:20px;color:var(--gold);font-weight:800;}

/* BREAKUP/RECONCILIATION */
.breakup-overlay{position:absolute;inset:0;background:rgba(0,0,0,.95);z-index:280;display:none;flex-direction:column;justify-content:center;align-items:center;padding:24px;text-align:center;}
.breakup-overlay.show{display:flex;}
.breakup-options{display:flex;flex-direction:column;gap:8px;width:100%;margin-top:14px;}

/* STARS */
.stars{position:absolute;inset:0;pointer-events:none;z-index:0;}
.star{position:absolute;width:3px;height:3px;background:white;border-radius:50%;animation:twinkle 2s infinite alternate;}
@keyframes twinkle{from{opacity:.2;transform:scale(1);}to{opacity:1;transform:scale(1.5);}}

/* SCREENS */
.screen{position:absolute;inset:0;display:none;flex-direction:column;z-index:1;}
.screen.active{display:flex;}
@keyframes fadeInUp{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
.fade-in{animation:fadeInUp .35s ease;}

/* TOAST */
.toast{position:absolute;top:70px;left:50%;transform:translateX(-50%) translateY(-120px);background:rgba(20,20,40,.97);border:2px solid var(--gold);color:white;padding:10px 20px;border-radius:20px;font-size:13px;font-weight:700;z-index:200;transition:transform .4s cubic-bezier(.34,1.56,.64,1);white-space:nowrap;pointer-events:none;box-shadow:0 4px 20px rgba(0,0,0,.5);}
.toast.show{transform:translateX(-50%) translateY(0);}

/* MODAL OVERLAY */
.modal-overlay{position:absolute;inset:0;background:rgba(0,0,0,.85);z-index:150;display:none;justify-content:center;align-items:flex-end;padding-bottom:0;}
.modal-overlay.show{display:flex;}
.modal-sheet{background:linear-gradient(160deg,#1a1a2e,#0f3460);border-radius:24px 24px 0 0;width:100%;max-height:85vh;overflow-y:auto;padding:20px;border-top:3px solid var(--gold);}
.modal-handle{width:40px;height:4px;background:rgba(255,255,255,.3);border-radius:2px;margin:0 auto 16px;}

/* BUTTONS */
.btn-primary{background:linear-gradient(135deg,var(--green),var(--green-light));color:white;border:none;padding:14px 32px;border-radius:50px;font-family:'Baloo 2',cursive;font-size:17px;font-weight:600;cursor:pointer;box-shadow:0 6px 20px rgba(0,135,81,.5);transition:all .2s;width:100%;max-width:280px;display:block;margin:8px auto;}
.btn-primary:active{transform:scale(.97);}
.btn-secondary{background:rgba(255,255,255,.1);color:white;border:2px solid rgba(255,255,255,.3);padding:11px 28px;border-radius:50px;font-family:'Baloo 2',cursive;font-size:15px;cursor:pointer;transition:all .2s;width:100%;max-width:280px;display:block;margin:6px auto;}
.btn-secondary:active{background:rgba(255,255,255,.2);}
.btn-gold{background:linear-gradient(135deg,var(--gold),#ffaa00);color:#1a1a2e;border:none;padding:12px 28px;border-radius:50px;font-family:'Baloo 2',cursive;font-size:15px;font-weight:800;cursor:pointer;transition:all .2s;display:block;margin:6px auto;}
.btn-gold:active{transform:scale(.97);}

/* STATS BAR */
.stats-bar{background:rgba(0,0,0,.5);padding:8px 10px;display:flex;gap:6px;align-items:center;border-bottom:1px solid rgba(255,255,255,.1);flex-shrink:0;position:relative;z-index:5;}
.stat-item{display:flex;align-items:center;gap:3px;flex:1;min-width:0;}
.stat-icon{font-size:11px;flex-shrink:0;}
.stat-bar-wrap{flex:1;height:5px;background:rgba(255,255,255,.15);border-radius:10px;overflow:hidden;min-width:20px;}
.stat-fill{height:100%;border-radius:10px;transition:width .6s ease;}
.stat-fill.charm{background:linear-gradient(90deg,#FF6B9D,#ff9a9e);}
.stat-fill.money{background:linear-gradient(90deg,var(--gold),#ffcc02);}
.stat-fill.confidence{background:linear-gradient(90deg,var(--blue),#74b9ff);}
.stat-fill.intelligence{background:linear-gradient(90deg,var(--purple),#a29bfe);}
.stat-val{color:white;font-size:9px;font-weight:800;min-width:18px;}
.day-badge{background:var(--gold);color:#1a1a2e;font-size:10px;font-weight:800;padding:2px 6px;border-radius:10px;font-family:'Baloo 2',cursive;flex-shrink:0;white-space:nowrap;}

/* ====== TITLE SCREEN ====== */
#title-screen{justify-content:center;align-items:center;padding:16px 20px;text-align:center;overflow-y:auto;}
.title-logo{font-family:'Baloo 2',cursive;font-size:clamp(28px,8vw,40px);font-weight:800;background:linear-gradient(135deg,var(--gold),#ff6b35,var(--green-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1.1;margin-bottom:4px;animation:pulse-title 3s ease-in-out infinite;}
@keyframes pulse-title{0%,100%{transform:scale(1);}50%{transform:scale(1.03);}}
.title-sub{color:rgba(255,255,255,.7);font-size:12px;margin-bottom:14px;}
.flag-wrap{display:flex;justify-content:center;gap:0;margin-bottom:12px;}
.fs{width:18px;height:36px;}
.fs.g{background:var(--green);border-radius:4px 0 0 4px;}
.fs.w{background:white;}
.fs.g2{background:var(--green);border-radius:0 4px 4px 0;}
.char-preview{width:clamp(100px,30vw,140px);height:clamp(100px,30vw,140px);margin:0 auto 14px;animation:float 3s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-8px);}}
.version-badge{background:rgba(255,255,255,.1);color:rgba(255,255,255,.6);font-size:10px;padding:3px 10px;border-radius:20px;margin-bottom:12px;display:inline-block;}

/* ====== SETUP SCREEN ====== */
#setup-screen{overflow-y:auto;padding:16px;}
.screen-header{text-align:center;padding:16px 0 12px;}
.screen-title{font-family:'Baloo 2',cursive;font-size:22px;font-weight:800;color:var(--gold);margin-bottom:4px;}
.screen-sub{color:rgba(255,255,255,.6);font-size:12px;}
.setup-card{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:16px;margin-bottom:12px;}
.setup-label{font-weight:800;color:var(--gold);font-size:11px;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;}
.name-input{width:100%;padding:12px 16px;border:2px solid rgba(255,255,255,.2);border-radius:12px;font-family:'Nunito',sans-serif;font-size:16px;outline:none;transition:border .2s;background:rgba(255,255,255,.08);color:white;}
.name-input::placeholder{color:rgba(255,255,255,.4);}
.name-input:focus{border-color:var(--green);}
.avatar-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;}
.avatar-option{aspect-ratio:1;border-radius:12px;border:3px solid transparent;cursor:pointer;overflow:hidden;transition:all .2s;background:rgba(255,255,255,.05);display:flex;align-items:center;justify-content:center;}
.avatar-option.selected{border-color:var(--green);transform:scale(1.05);box-shadow:0 0 12px rgba(0,135,81,.5);}
.avatar-option svg{width:100%;height:100%;}
.trait-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.trait-btn{padding:10px;border-radius:10px;border:2px solid rgba(255,255,255,.2);background:rgba(255,255,255,.05);font-family:'Nunito',sans-serif;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s;text-align:center;color:rgba(255,255,255,.8);}
.trait-btn.selected{border-color:var(--green);background:rgba(0,135,81,.2);color:var(--green-light);}
.lang-toggle{display:flex;gap:8px;}
.lang-btn{flex:1;padding:10px;border-radius:10px;border:2px solid rgba(255,255,255,.2);background:rgba(255,255,255,.05);font-family:'Nunito',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;color:rgba(255,255,255,.8);}
.lang-btn.selected{border-color:var(--gold);background:rgba(255,215,0,.15);color:var(--gold);}

/* ====== MAP SCREEN ====== */
#map-screen{overflow:hidden;}
.map-container{flex:1;position:relative;overflow:hidden;}
.map-bg-img{position:absolute;inset:0;background:linear-gradient(180deg,#87CEEB 0%,#B8E4F7 20%,#98D8A0 55%,#5D8A5E 100%);}
.map-title{position:absolute;top:12px;left:50%;transform:translateX(-50%);font-family:'Baloo 2',cursive;font-size:16px;font-weight:800;color:var(--dark);background:rgba(255,255,255,.92);padding:5px 18px;border-radius:20px;white-space:nowrap;z-index:5;box-shadow:0 2px 10px rgba(0,0,0,.2);}
.location-pin{position:absolute;display:flex;flex-direction:column;align-items:center;cursor:pointer;z-index:4;transition:transform .2s;}
.location-pin:active{transform:scale(.92)!important;}
.pin-icon{width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:0 4px 15px rgba(0,0,0,.35);border:3px solid white;transition:all .2s;}
.pin-label{background:rgba(0,0,0,.78);color:white;font-size:10px;font-weight:800;padding:3px 8px;border-radius:10px;margin-top:3px;white-space:nowrap;}
.pin-hearts{font-size:10px;background:rgba(0,0,0,.6);color:white;padding:2px 6px;border-radius:8px;margin-top:2px;}
.player-lvl{position:absolute;top:12px;right:12px;background:linear-gradient(135deg,var(--gold),#ffaa00);color:#1a1a2e;font-family:'Baloo 2',cursive;font-weight:800;font-size:13px;padding:5px 12px;border-radius:20px;z-index:5;box-shadow:0 2px 10px rgba(255,165,0,.4);}
.event-banner{position:absolute;bottom:12px;left:12px;right:12px;background:linear-gradient(135deg,var(--green),var(--green-light));color:white;border-radius:14px;padding:10px 14px;font-size:12px;font-weight:700;text-align:center;z-index:5;cursor:pointer;box-shadow:0 4px 15px rgba(0,135,81,.4);}

/* ====== BOTTOM NAV ====== */
.bottom-nav{display:flex;background:rgba(0,0,0,.85);border-top:1px solid rgba(255,255,255,.1);padding:4px 0;padding-bottom:calc(4px + env(safe-area-inset-bottom));flex-shrink:0;z-index:20;}
.nav-btn{flex:1;min-width:0;padding:6px 0;background:none;border:none;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:1px;transition:all .2s;}
.nav-btn .ni{font-size:clamp(14px,4vw,20px);transition:transform .2s;line-height:1;}
.nav-btn .nl{font-size:clamp(7px,2vw,9px);color:rgba(255,255,255,.4);font-family:'Nunito',sans-serif;font-weight:800;letter-spacing:.3px;white-space:nowrap;}
.nav-btn.active .nl{color:var(--gold);}
.nav-btn.active .ni{transform:scale(1.15);}

/* ====== SCENE SCREEN ====== */
#scene-screen{background:#1a1a2e;}
.scene-bg-layer{flex:1;position:relative;overflow:hidden;}
.npc-profile-card{background:white;border-radius:16px;overflow:hidden;margin:10px 12px 8px;box-shadow:0 6px 24px rgba(0,0,0,.25);flex-shrink:0;position:relative;z-index:5;}
.npc-profile-header{padding:12px;display:flex;align-items:center;gap:10px;background:linear-gradient(135deg,var(--green),var(--green-light));}
.npc-av{width:54px;height:54px;border-radius:50%;border:3px solid white;flex-shrink:0;overflow:hidden;}
.npc-av svg{width:100%;height:100%;}
.npc-name{font-family:'Baloo 2',cursive;font-size:17px;font-weight:800;color:white;}
.npc-det{color:rgba(255,255,255,.85);font-size:11px;margin-top:1px;}
.npc-mood{font-size:20px;margin-left:auto;}
.npc-interest{text-align:right;}
.npc-hearts{font-size:16px;letter-spacing:-2px;}
.npc-il{font-size:9px;color:rgba(255,255,255,.8);}
.npc-tags{display:flex;gap:5px;padding:8px 12px;flex-wrap:wrap;}
.npc-tag{background:#f0f7f4;color:var(--green);border:1px solid #c8e6c9;padding:3px 8px;border-radius:20px;font-size:10px;font-weight:800;}
.npc-stage-tag{background:#fff3cd;color:#856404;border:1px solid #ffd700;padding:3px 8px;border-radius:20px;font-size:10px;font-weight:800;}
.char-stage{position:absolute;bottom:0;left:0;right:0;display:flex;justify-content:space-around;align-items:flex-end;padding:0 20px;z-index:2;}
.npc-char{animation:char-idle 3s ease-in-out infinite;}
@keyframes char-idle{0%,100%{transform:rotate(-1deg);}50%{transform:rotate(1deg);}}
.npc-char.happy{animation:char-happy 1s ease-in-out 3;}
@keyframes char-happy{0%{transform:translateY(0);}50%{transform:translateY(-15px);}100%{transform:translateY(0);}}
.npc-char.sad{animation:char-sad 0.5s ease-in-out 3;}
@keyframes char-sad{0%,100%{transform:rotate(0);}50%{transform:rotate(-5deg);}75%{transform:rotate(3deg);}}
.rival-char{position:absolute;right:10px;bottom:0;opacity:.6;animation:char-idle 2.5s ease-in-out infinite;animation-delay:.5s;}

/* DIALOGUE BOX */
.dialogue-box{position:relative;background:rgba(15,20,40,.97);border-top:3px solid var(--gold);padding:14px 14px 10px;z-index:10;flex-shrink:0;}
.dialogue-name-row{display:flex;align-items:center;gap:8px;margin-bottom:6px;}
.dialogue-name{font-family:'Baloo 2',cursive;font-size:15px;font-weight:800;color:var(--gold);}
.dialogue-mood-label{font-size:11px;color:rgba(255,255,255,.5);margin-left:auto;}
.dialogue-text{color:white;font-size:13px;line-height:1.55;margin-bottom:12px;min-height:38px;}
.typewriter-cursor{display:inline-block;width:2px;height:13px;background:var(--gold);animation:blink .7s infinite;vertical-align:middle;margin-left:2px;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:0;}}
.choices-container{display:flex;flex-direction:column;gap:7px;}
.choice-btn{background:rgba(255,255,255,.08);border:2px solid rgba(255,255,255,.15);color:white;padding:9px 12px;border-radius:11px;font-family:'Nunito',sans-serif;font-size:12px;font-weight:700;cursor:pointer;text-align:left;transition:all .2s;display:flex;align-items:center;gap:7px;line-height:1.4;}
.choice-btn:active{transform:scale(.98);background:rgba(255,255,255,.18);}
.choice-btn.good{border-color:rgba(0,184,107,.5);}
.choice-btn.bad{border-color:rgba(231,76,60,.5);}
.choice-btn.neutral{border-color:rgba(74,144,226,.5);}
.choice-btn.pidgin{border-color:rgba(255,215,0,.5);}
.ct{font-size:9px;padding:2px 5px;border-radius:5px;font-weight:800;text-transform:uppercase;flex-shrink:0;}
.ct.good{background:var(--green);}
.ct.bad{background:var(--red);}
.ct.neutral{background:var(--blue);}
.ct.pidgin{background:var(--gold);color:#1a1a2e;}

/* RESULT PANEL */
.result-panel{position:absolute;inset:0;background:rgba(0,0,0,.9);display:none;flex-direction:column;justify-content:center;align-items:center;z-index:20;padding:24px;text-align:center;}
.result-panel.show{display:flex;}
.result-emoji{font-size:60px;margin-bottom:12px;animation:pop-in .4s cubic-bezier(.34,1.56,.64,1);}
@keyframes pop-in{from{transform:scale(0) rotate(-20deg);}to{transform:scale(1) rotate(0);}}
.result-title{font-family:'Baloo 2',cursive;font-size:26px;font-weight:800;color:white;margin-bottom:8px;}
.result-msg{color:rgba(255,255,255,.8);font-size:13px;line-height:1.6;margin-bottom:14px;}
.result-xp{font-family:'Baloo 2',cursive;font-size:18px;color:var(--gold);margin-bottom:8px;}
.debrief-section{background:rgba(255,255,255,.06);border-radius:12px;padding:12px;margin-bottom:12px;text-align:left;width:100%;}
.debrief-title{color:var(--gold);font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;}
.debrief-item{display:flex;align-items:flex-start;gap:8px;margin-bottom:6px;font-size:12px;color:rgba(255,255,255,.8);line-height:1.4;}

/* ACHIEVEMENTS */
.achievement-pop{position:absolute;top:80px;right:12px;background:linear-gradient(135deg,var(--gold),#ffaa00);color:#1a1a2e;border-radius:14px;padding:10px 14px;z-index:180;transform:translateX(200px);transition:transform .5s cubic-bezier(.34,1.56,.64,1);max-width:200px;}
.achievement-pop.show{transform:translateX(0);}
.ach-title{font-family:'Baloo 2',cursive;font-size:13px;font-weight:800;}
.ach-name{font-size:11px;margin-top:2px;}

/* ====== SKILL TREE ====== */
#skills-screen{overflow:hidden;}
.skill-section{margin-bottom:16px;}
.skill-section-title{font-family:'Baloo 2',cursive;font-size:16px;color:var(--gold);font-weight:800;margin-bottom:10px;padding-left:4px;}
.skill-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.skill-card{background:rgba(255,255,255,.06);border:2px solid rgba(255,255,255,.12);border-radius:14px;padding:12px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden;}
.skill-card.unlocked{border-color:var(--green);background:rgba(0,135,81,.12);}
.skill-card.locked{opacity:.5;}
.skill-card.locked::after{content:'üîí';position:absolute;top:8px;right:8px;font-size:14px;}
.skill-card:active{transform:scale(.97);}
.skill-icon{font-size:28px;margin-bottom:6px;}
.skill-name{font-family:'Baloo 2',cursive;font-size:13px;color:white;font-weight:700;margin-bottom:3px;}
.skill-desc{font-size:11px;color:rgba(255,255,255,.6);line-height:1.3;}
.skill-cost{font-size:10px;color:var(--gold);font-weight:800;margin-top:5px;}

/* ====== PHONE/TEXT SCREEN ====== */
#phone-screen{background:#1a1a2e;overflow:hidden;}
.phone-contacts{overflow-y:auto;flex:1;}
.contact-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.07);cursor:pointer;transition:background .2s;}
.contact-item:active{background:rgba(255,255,255,.07);}
.contact-av{width:48px;height:48px;border-radius:50%;overflow:hidden;flex-shrink:0;}
.contact-av svg{width:100%;height:100%;}
.contact-name{font-weight:800;color:white;font-size:14px;}
.contact-preview{font-size:12px;color:rgba(255,255,255,.5);margin-top:2px;}
.contact-time{font-size:10px;color:rgba(255,255,255,.4);margin-left:auto;flex-shrink:0;}
.unread-dot{width:10px;height:10px;border-radius:50%;background:var(--green);margin-left:8px;}
#chat-screen{background:#0a0a1a;overflow:hidden;}
.chat-header{background:rgba(0,0,0,.6);padding:12px 16px;display:flex;align-items:center;gap:10px;flex-shrink:0;border-bottom:1px solid rgba(255,255,255,.1);}
.chat-back{background:none;border:none;color:var(--gold);font-size:24px;cursor:pointer;padding:0 4px;}
.chat-name{font-family:'Baloo 2',cursive;font-size:17px;color:white;font-weight:700;}
.chat-status{font-size:11px;color:var(--green-light);}
.chat-messages{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:8px;}
.msg{max-width:75%;padding:10px 12px;border-radius:16px;font-size:13px;line-height:1.45;position:relative;}
.msg.received{background:rgba(255,255,255,.1);color:white;align-self:flex-start;border-bottom-left-radius:4px;}
.msg.sent{background:linear-gradient(135deg,var(--green),var(--green-light));color:white;align-self:flex-end;border-bottom-right-radius:4px;}
.msg-time{font-size:9px;opacity:.6;margin-top:3px;}
.chat-input-area{background:rgba(0,0,0,.5);padding:10px 12px;display:flex;gap:8px;align-items:center;flex-shrink:0;border-top:1px solid rgba(255,255,255,.1);}
.chat-replies{flex:1;display:flex;flex-direction:column;gap:6px;}
.reply-opt{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);color:white;padding:8px 12px;border-radius:20px;font-size:12px;cursor:pointer;text-align:left;transition:all .2s;}
.reply-opt:active{background:rgba(255,255,255,.18);}

/* ====== SHOP SCREEN ====== */
#shop-screen{overflow-y:auto;padding:12px;}
.shop-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;padding:12px 0;}
.shop-balance{font-family:'Baloo 2',cursive;font-size:20px;color:var(--gold);font-weight:800;}
.gift-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px;}
.gift-card{background:rgba(255,255,255,.06);border:2px solid rgba(255,255,255,.12);border-radius:14px;padding:12px 8px;text-align:center;cursor:pointer;transition:all .2s;}
.gift-card:active{transform:scale(.95);}
.gift-card.owned{border-color:var(--gold);}
.gift-emoji{font-size:32px;margin-bottom:6px;}
.gift-name{font-size:11px;color:white;font-weight:700;margin-bottom:4px;}
.gift-price{font-size:11px;color:var(--gold);font-weight:800;}
.gift-likes{font-size:10px;color:rgba(255,255,255,.5);margin-top:2px;}
.activity-list{display:flex;flex-direction:column;gap:8px;}
.activity-card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:12px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:all .2s;}
.activity-card:active{background:rgba(255,255,255,.12);}
.act-icon{font-size:30px;flex-shrink:0;}
.act-name{font-weight:800;color:white;font-size:13px;}
.act-effect{font-size:11px;color:rgba(255,255,255,.6);margin-top:2px;}
.act-cost{font-size:11px;color:var(--gold);font-weight:800;margin-left:auto;flex-shrink:0;}

/* ====== DATE PLANNING ====== */
.date-planner{background:rgba(255,255,255,.06);border-radius:16px;padding:16px;margin-bottom:12px;}
.date-option-row{display:flex;gap:8px;overflow-x:auto;padding-bottom:8px;margin-bottom:12px;-ms-overflow-style:none;scrollbar-width:none;}
.date-option-row::-webkit-scrollbar{display:none;}
.date-opt{flex-shrink:0;background:rgba(255,255,255,.08);border:2px solid rgba(255,255,255,.15);border-radius:12px;padding:10px 14px;cursor:pointer;transition:all .2s;text-align:center;}
.date-opt.sel{border-color:var(--gold);background:rgba(255,215,0,.12);}
.date-opt-emoji{font-size:24px;display:block;margin-bottom:4px;}
.date-opt-label{font-size:11px;color:white;font-weight:700;}

/* ====== JOURNAL ====== */
#journal-screen{overflow-y:auto;padding:12px;background:linear-gradient(160deg,#1a1a2e,#0f3460);}
.journal-header{text-align:center;padding:12px 0 16px;}
.npc-journal-card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:12px;margin-bottom:10px;cursor:pointer;transition:all .2s;}
.npc-journal-card:active{background:rgba(255,255,255,.1);}
.njc-row{display:flex;gap:12px;align-items:center;}
.njc-av{width:54px;height:54px;border-radius:50%;overflow:hidden;flex-shrink:0;}
.njc-av svg{width:100%;height:100%;}
.njc-name{font-family:'Baloo 2',cursive;font-size:15px;color:white;font-weight:700;}
.njc-status{font-size:11px;color:rgba(255,255,255,.55);margin-top:2px;}
.njc-stage{font-size:10px;padding:2px 8px;border-radius:10px;font-weight:800;margin-top:4px;display:inline-block;}
.stage-stranger{background:rgba(255,255,255,.15);color:rgba(255,255,255,.7);}
.stage-friend{background:rgba(74,144,226,.3);color:#74b9ff;}
.stage-crush{background:rgba(255,107,157,.3);color:#ff6b9d;}
.stage-partner{background:rgba(255,215,0,.3);color:var(--gold);}
.love-bar-wrap{height:7px;background:rgba(255,255,255,.1);border-radius:10px;margin-top:8px;overflow:hidden;}
.love-bar-fill{height:100%;background:linear-gradient(90deg,var(--pink),var(--red));border-radius:10px;transition:width .6s;}
.njc-memory{font-size:11px;color:rgba(255,255,255,.45);margin-top:8px;font-style:italic;border-left:2px solid rgba(255,215,0,.3);padding-left:8px;}

/* ====== ACHIEVEMENTS SCREEN ====== */
#achievements-screen{overflow-y:auto;padding:12px;}
.ach-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.ach-card{background:rgba(255,255,255,.05);border:2px solid rgba(255,255,255,.1);border-radius:14px;padding:12px;text-align:center;transition:all .3s;}
.ach-card.earned{border-color:var(--gold);background:rgba(255,215,0,.1);}
.ach-card.locked-ach{filter:grayscale(.8);opacity:.5;}
.ach-badge{font-size:36px;margin-bottom:6px;}
.ach-title{font-family:'Baloo 2',cursive;font-size:12px;color:white;font-weight:700;margin-bottom:3px;}
.ach-desc{font-size:10px;color:rgba(255,255,255,.5);line-height:1.3;}

/* ====== TRIVIA ====== */
.trivia-panel{position:absolute;inset:0;background:linear-gradient(160deg,#1a1a2e,#0f3460);z-index:30;display:none;flex-direction:column;padding:20px;}
.trivia-panel.show{display:flex;}
.trivia-q{font-family:'Baloo 2',cursive;font-size:18px;color:white;font-weight:700;text-align:center;margin:20px 0;line-height:1.4;}
.trivia-opts{display:flex;flex-direction:column;gap:10px;flex:1;}
.trivia-opt{background:rgba(255,255,255,.08);border:2px solid rgba(255,255,255,.2);color:white;padding:14px 16px;border-radius:14px;font-family:'Nunito',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all .2s;}
.trivia-opt.correct{border-color:var(--green);background:rgba(0,135,81,.25);}
.trivia-opt.wrong{border-color:var(--red);background:rgba(231,76,60,.25);}
.trivia-score{text-align:center;font-family:'Baloo 2',cursive;font-size:16px;color:var(--gold);margin-bottom:16px;}

/* ====== MINIGAME PANEL ====== */
.minigame-panel{position:absolute;inset:0;background:linear-gradient(160deg,#1a1a2e,#0f3460);z-index:15;display:none;flex-direction:column;padding:20px;}
.minigame-panel.show{display:flex;}
.mg-title{font-family:'Baloo 2',cursive;font-size:20px;font-weight:800;color:var(--gold);text-align:center;margin-bottom:4px;}
.mg-sub{color:rgba(255,255,255,.65);font-size:12px;text-align:center;margin-bottom:18px;line-height:1.4;}
.mg-timer{text-align:center;font-family:'Baloo 2',cursive;font-size:28px;color:white;font-weight:800;margin-bottom:12px;}
.mg-timer.urgent{color:var(--red);animation:pulse-red .5s infinite alternate;}
@keyframes pulse-red{from{transform:scale(1);}to{transform:scale(1.1);}}
.compliment-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;flex:1;}
.comp-card{background:rgba(255,255,255,.07);border:2px solid rgba(255,255,255,.15);border-radius:16px;padding:14px;cursor:pointer;transition:all .2s;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;gap:7px;}
.comp-card:active{transform:scale(.95);}
.comp-card.correct{border-color:var(--green);background:rgba(0,135,81,.2);}
.comp-card.wrong{border-color:var(--red);background:rgba(231,76,60,.2);}
.comp-emoji{font-size:30px;}
.comp-text{color:white;font-size:11px;font-weight:700;line-height:1.3;}

/* ====== EVENT SCREEN ====== */
#event-screen{overflow-y:auto;padding:16px;}
.event-card{background:linear-gradient(135deg,var(--green),var(--green-light));border-radius:20px;padding:20px;margin-bottom:16px;color:white;text-align:center;cursor:pointer;}
.event-emoji{font-size:48px;margin-bottom:12px;}
.event-title{font-family:'Baloo 2',cursive;font-size:22px;font-weight:800;margin-bottom:8px;}
.event-desc{font-size:13px;opacity:.9;line-height:1.5;margin-bottom:16px;}

/* ====== TIPS SCREEN ====== */
#tips-screen{overflow-y:auto;padding:12px;}
.tip-card{background:rgba(255,255,255,.06);border-left:4px solid var(--green);border-radius:12px;padding:14px;margin-bottom:12px;}
.tip-header{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
.tip-icon-big{font-size:26px;}
.tip-title{font-family:'Baloo 2',cursive;font-size:15px;font-weight:800;color:white;}
.tip-body{color:rgba(255,255,255,.7);font-size:12px;line-height:1.6;}

/* RIVAL */
.rival-event{position:absolute;inset:0;background:rgba(0,0,0,.85);z-index:25;display:none;flex-direction:column;justify-content:center;align-items:center;padding:24px;text-align:center;}
.rival-event.show{display:flex;}
.rival-title{font-family:'Baloo 2',cursive;font-size:24px;color:var(--red);font-weight:800;margin-bottom:12px;}
.rival-msg{color:rgba(255,255,255,.85);font-size:14px;line-height:1.6;margin-bottom:20px;}

/* SCROLLBAR */
::-webkit-scrollbar{width:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15);border-radius:3px;}

/* ====== V5 NEW FEATURE STYLES ====== */

/* SCENE TRANSITIONS */
.screen-transition-overlay{position:absolute;inset:0;z-index:500;pointer-events:none;display:none;}
.screen-transition-overlay.sliding{display:block;animation:slideWipe .4s ease forwards;}
.screen-transition-overlay.fading{display:block;animation:fadeWipe .35s ease forwards;}
.screen-transition-overlay.curtain{display:block;animation:curtainWipe .45s ease forwards;}
@keyframes slideWipe{from{transform:translateX(-100%);background:#000;opacity:1;}to{transform:translateX(100%);background:#000;opacity:0;}}
@keyframes fadeWipe{from{opacity:1;background:#000;}to{opacity:0;background:#000;}}
@keyframes curtainWipe{from{clip-path:inset(0 0 0 0);background:#1a1a2e;opacity:1;}to{clip-path:inset(0 0 100% 0);background:#1a1a2e;opacity:0;}}

/* PARTICLE EFFECTS */
.particle-container{position:absolute;inset:0;pointer-events:none;z-index:400;overflow:hidden;}
.particle{position:absolute;pointer-events:none;animation:particleFly 1.2s ease-out forwards;}
@keyframes particleFly{0%{opacity:1;transform:translate(0,0) scale(1);}100%{opacity:0;transform:translate(var(--dx),var(--dy)) scale(0);}}

/* NPC ANIMATED EXPRESSIONS */
.npc-expression{position:absolute;top:-20px;right:-10px;font-size:26px;animation:expressionPop .4s cubic-bezier(.34,1.56,.64,1);z-index:10;}
@keyframes expressionPop{from{transform:scale(0) rotate(-20deg);}to{transform:scale(1) rotate(0);}}
.expression-blush::after{content:'üòä';position:absolute;top:-18px;right:-6px;font-size:22px;}
.expression-laugh::after{content:'üòÇ';position:absolute;top:-18px;right:-6px;font-size:22px;}
.expression-frown::after{content:'üò§';position:absolute;top:-18px;right:-6px;font-size:22px;}

/* DAY/NIGHT COLOR CYCLE */
body.time-morning #app{filter:none;}
body.time-afternoon #app{filter:none;}
body.time-evening #app{filter:sepia(0.15) saturate(1.2);}
body.time-night #app{filter:brightness(0.85) saturate(0.9) hue-rotate(10deg);}

/* AMBIENT SOUND BUTTON */
.ambient-btn{position:absolute;top:12px;right:54px;z-index:10;background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.2);color:white;border-radius:10px;font-size:11px;font-weight:800;padding:4px 8px;cursor:pointer;}

/* STATS ANALYTICS SCREEN */
#analytics-screen{background:linear-gradient(160deg,#0a0a1a,#1a1a2e);overflow-y:auto;padding:12px;}
.analytics-section{margin-bottom:16px;}
.analytics-title{font-family:'Baloo 2',cursive;font-size:15px;color:var(--gold);font-weight:800;margin-bottom:10px;display:flex;align-items:center;gap:8px;}
.compat-card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:12px;margin-bottom:8px;}
.compat-row{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
.compat-bar-wrap{flex:1;height:8px;background:rgba(255,255,255,.1);border-radius:10px;overflow:hidden;}
.compat-bar-fill{height:100%;border-radius:10px;background:linear-gradient(90deg,var(--pink),var(--gold));transition:width .8s ease;}
.compat-score{font-family:'Baloo 2',cursive;font-size:18px;color:var(--gold);font-weight:800;min-width:40px;text-align:right;}
.breakdown-row{display:flex;gap:4px;flex-wrap:wrap;margin-top:6px;}
.breakdown-tag{background:rgba(255,255,255,.08);border-radius:8px;padding:3px 8px;font-size:10px;color:rgba(255,255,255,.7);}
.breakdown-tag.high{background:rgba(0,135,81,.2);color:var(--green-light);}
.breakdown-tag.low{background:rgba(231,76,60,.15);color:#ff6b6b;}

/* HEAT MAP */
.heatmap-container{width:100%;height:120px;background:rgba(255,255,255,.04);border-radius:12px;position:relative;overflow:hidden;border:1px solid rgba(255,255,255,.1);}
.heatmap-label{position:absolute;font-size:9px;color:rgba(255,255,255,.4);font-weight:800;}
.heatmap-dot{position:absolute;border-radius:50%;transform:translate(-50%,-50%);}
.heatmap-axis{position:absolute;background:rgba(255,255,255,.1);}

/* TIMELINE */
.timeline-wrap{padding:0 4px;}
.timeline-event{display:flex;gap:10px;margin-bottom:8px;position:relative;}
.timeline-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;margin-top:4px;z-index:1;}
.timeline-line{position:absolute;left:4px;top:14px;width:2px;height:calc(100% + 8px);background:rgba(255,255,255,.1);}
.timeline-content{flex:1;background:rgba(255,255,255,.05);border-radius:10px;padding:8px 10px;}
.timeline-day{font-size:9px;color:rgba(255,255,255,.4);font-weight:800;}
.timeline-text{font-size:11px;color:rgba(255,255,255,.8);margin-top:2px;}

/* PLAYSTYLE BADGE */
.playstyle-card{background:linear-gradient(135deg,rgba(155,89,182,.3),rgba(74,144,226,.2));border:1px solid rgba(155,89,182,.4);border-radius:14px;padding:14px;margin-bottom:10px;text-align:center;}
.playstyle-title{font-family:'Baloo 2',cursive;font-size:20px;color:var(--gold);font-weight:800;margin-bottom:4px;}
.playstyle-desc{font-size:12px;color:rgba(255,255,255,.7);line-height:1.5;}

/* WEEKLY REPORT CARD */
.report-card{background:linear-gradient(135deg,#1a2a1a,#0f3460);border:2px solid var(--gold);border-radius:18px;padding:16px;margin-bottom:12px;}
.report-grade{font-family:'Baloo 2',cursive;font-size:48px;font-weight:800;text-align:center;margin-bottom:8px;}
.report-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;font-size:12px;}
.report-label{color:rgba(255,255,255,.6);}
.report-val{font-weight:800;color:white;}

/* WINGMAN PANEL */
.wingman-panel{position:absolute;bottom:70px;left:8px;right:8px;background:linear-gradient(135deg,#0f3460,#1a1a3e);border:2px solid var(--teal);border-radius:18px;padding:14px;z-index:120;animation:slideUp .4s cubic-bezier(.34,1.56,.64,1);display:none;}
.wingman-panel.show{display:flex;gap:10px;align-items:flex-start;}
.wingman-avatar{font-size:36px;flex-shrink:0;}
.wingman-name{font-family:'Baloo 2',cursive;font-size:13px;color:var(--teal);font-weight:800;margin-bottom:3px;}
.wingman-text{font-size:12px;color:rgba(255,255,255,.85);line-height:1.4;}
.wingman-close{background:none;border:none;color:rgba(255,255,255,.4);font-size:18px;cursor:pointer;flex-shrink:0;align-self:flex-start;}

/* BESTIE SCREEN */
#bestie-screen{background:linear-gradient(160deg,#1a1a2e,#0f3460);overflow-y:auto;}
.bestie-header{padding:16px;text-align:center;border-bottom:1px solid rgba(255,255,255,.1);}
.bestie-messages{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:8px;}
.bestie-replies{padding:10px 12px;display:flex;flex-direction:column;gap:6px;border-top:1px solid rgba(255,255,255,.1);}
.bestie-reply{background:rgba(0,188,212,.1);border:1px solid rgba(0,188,212,.3);color:white;padding:8px 12px;border-radius:16px;font-size:12px;cursor:pointer;text-align:left;transition:all .2s;}
.bestie-reply:active{background:rgba(0,188,212,.2);}

/* GOSSIP BUBBLE */
.gossip-popup{position:absolute;top:70px;left:12px;right:12px;background:linear-gradient(135deg,#2C1810,#3a1a00);border:2px solid var(--orange);border-radius:16px;padding:14px;z-index:110;animation:slideUp .4s cubic-bezier(.34,1.56,.64,1);display:none;}
.gossip-popup.show{display:flex;gap:10px;align-items:flex-start;}
.gossip-title{font-family:'Baloo 2',cursive;font-size:12px;color:var(--orange);font-weight:800;margin-bottom:3px;}
.gossip-text{font-size:12px;color:rgba(255,255,255,.85);line-height:1.4;}
.gossip-source{font-size:10px;color:rgba(255,165,0,.6);margin-top:4px;font-style:italic;}

/* LEADERBOARD */
#leaderboard-screen{background:linear-gradient(160deg,#1a1a2e,#0f3460);overflow-y:auto;padding:12px;}
.lb-entry{background:rgba(255,255,255,.06);border-radius:12px;padding:10px 12px;display:flex;align-items:center;gap:10px;margin-bottom:6px;}
.lb-rank{font-family:'Baloo 2',cursive;font-size:18px;font-weight:800;min-width:30px;color:var(--gold);}
.lb-name{flex:1;font-weight:700;color:white;font-size:13px;}
.lb-score{font-family:'Baloo 2',cursive;font-size:16px;color:var(--pink);font-weight:800;}
.lb-you{border:2px solid var(--gold);background:rgba(255,215,0,.08);}

/* DAILY CHALLENGE */
.daily-challenge-bar{background:linear-gradient(135deg,rgba(255,107,157,.2),rgba(255,107,53,.2));border:1px solid rgba(255,107,157,.4);border-radius:12px;padding:10px 12px;margin:8px 0;cursor:pointer;transition:all .2s;}
.daily-challenge-bar:active{transform:scale(.98);}
.daily-ch-title{font-family:'Baloo 2',cursive;font-size:12px;color:var(--pink);font-weight:800;}
.daily-ch-desc{font-size:11px;color:rgba(255,255,255,.7);margin-top:2px;}
.daily-ch-progress{height:4px;background:rgba(255,255,255,.1);border-radius:4px;margin-top:6px;overflow:hidden;}
.daily-ch-fill{height:100%;background:linear-gradient(90deg,var(--pink),var(--orange));border-radius:4px;transition:width .5s;}

/* SHAREABLE REPORT */
.share-card{background:linear-gradient(135deg,#1a3a1a,#0f2a3a);border:3px solid var(--gold);border-radius:20px;padding:20px;text-align:center;margin-bottom:14px;position:relative;overflow:hidden;}
.share-watermark{position:absolute;bottom:8px;right:12px;font-size:10px;color:rgba(255,215,0,.3);font-weight:800;}

/* CUTSCENE MILESTONE PANELS */
.milestone-cutscene{position:absolute;inset:0;background:#000;z-index:350;display:none;flex-direction:column;overflow:hidden;}
.milestone-cutscene.show{display:flex;}
.milestone-panel-row{display:flex;flex:1;}
.milestone-panel{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px;border:1px solid rgba(255,215,0,.2);}
.milestone-panel-emoji{font-size:48px;margin-bottom:10px;}
.milestone-panel-text{color:white;font-size:12px;text-align:center;line-height:1.5;}

/* NPC AVATAR EXPRESSION STATE */
.npc-scene-wrap{position:relative;display:inline-block;}
.npc-mood-bubble{position:absolute;top:-10px;right:-15px;background:rgba(0,0,0,.7);border:2px solid rgba(255,215,0,.5);border-radius:12px;padding:3px 8px;font-size:16px;animation:moodPop .3s cubic-bezier(.34,1.56,.64,1);}
@keyframes moodPop{from{transform:scale(0);}to{transform:scale(1);}}


/* NOTIFICATION DOT */
.notif-dot{position:absolute;top:4px;right:20%;width:8px;height:8px;background:var(--red);border-radius:50%;display:none;}
.notif-dot.show{display:block;}

/* ====== ENERGY SYSTEM ====== */
.energy-bar-wrap{flex:1;height:6px;background:rgba(255,255,255,.15);border-radius:10px;overflow:hidden;}
.energy-fill{height:100%;background:linear-gradient(90deg,#FF6B35,#FFD700);border-radius:10px;transition:width .6s ease;}
.energy-label{color:rgba(255,255,255,.7);font-size:10px;font-weight:800;min-width:30px;}
.energy-depleted-overlay{position:absolute;inset:0;background:rgba(0,0,0,.88);z-index:60;display:none;flex-direction:column;justify-content:center;align-items:center;padding:32px;text-align:center;}
.energy-depleted-overlay.show{display:flex;}

/* ====== TIME OF DAY ====== */
.time-of-day-badge{position:absolute;top:12px;left:12px;background:rgba(0,0,0,.7);border:1px solid rgba(255,215,0,.4);color:var(--gold);font-family:'Baloo 2',cursive;font-size:12px;font-weight:800;padding:4px 12px;border-radius:12px;z-index:6;}
.loc-time-req{font-size:9px;color:rgba(255,165,0,.8);font-weight:700;margin-top:2px;display:block;}
.pin-locked-time{opacity:.45;pointer-events:none;}
.pin-locked-time .pin-icon::after{content:'üïê';position:absolute;top:-4px;right:-4px;font-size:13px;}

/* ====== ENDINGS SCREEN ====== */
#endings-screen{background:linear-gradient(160deg,#1a1a2e,#0f3460);overflow-y:auto;padding:14px;}
.ending-card{border-radius:18px;padding:18px;margin-bottom:14px;position:relative;overflow:hidden;cursor:pointer;transition:transform .2s;}
.ending-card:active{transform:scale(.97);}
.ending-type{font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;opacity:.8;}
.ending-title{font-family:'Baloo 2',cursive;font-size:19px;font-weight:800;color:white;margin-bottom:4px;}
.ending-desc{font-size:12px;opacity:.85;line-height:1.5;}
.ending-locked{filter:grayscale(1);opacity:.4;}
.ending-progress{height:5px;border-radius:5px;background:rgba(255,255,255,.15);margin-top:10px;overflow:hidden;}
.ending-progress-fill{height:100%;border-radius:5px;background:rgba(255,255,255,.6);transition:width .5s;}
.ending-unlocked-badge{position:absolute;top:12px;right:12px;font-size:20px;}

/* ====== WHAT IF MODE ====== */
.what-if-bar{background:linear-gradient(135deg,var(--purple),#6c3483);color:white;padding:8px 14px;display:flex;align-items:center;gap:8px;font-size:12px;font-weight:800;flex-shrink:0;z-index:10;}
.what-if-badge{background:rgba(255,255,255,.25);border-radius:8px;padding:2px 8px;font-size:10px;}

/* ====== CONSEQUENCE SYSTEM ====== */
.ripple-toast{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,var(--purple),#2980b9);color:white;border-radius:16px;padding:14px 20px;font-size:13px;font-weight:700;z-index:250;text-align:center;opacity:0;pointer-events:none;transition:opacity .4s;max-width:240px;box-shadow:0 6px 24px rgba(0,0,0,.6);}
.ripple-toast.show{opacity:1;}

/* ====== SCENE HISTORY ====== */
.scene-history-btn{position:absolute;top:8px;right:8px;z-index:10;background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.2);color:white;border-radius:10px;font-size:10px;font-weight:800;padding:4px 8px;cursor:pointer;}
.history-panel{position:absolute;inset:0;background:rgba(10,10,30,.97);z-index:35;display:none;flex-direction:column;padding:16px;overflow-y:auto;}
.history-panel.show{display:flex;}
.history-item{background:rgba(255,255,255,.06);border-left:3px solid var(--gold);border-radius:10px;padding:10px 12px;margin-bottom:8px;cursor:pointer;transition:background .2s;}
.history-item:active{background:rgba(255,255,255,.12);}
.history-item-meta{font-size:10px;color:rgba(255,255,255,.4);margin-bottom:4px;}
.history-item-text{font-size:12px;color:rgba(255,255,255,.85);line-height:1.4;}
.history-item-choice{font-size:11px;color:var(--green-light);margin-top:4px;font-weight:700;}
/* ====== V6 NEW STYLES ====== */

/* BACKSTORY / LORE */
.backstory-screen{position:absolute;inset:0;background:linear-gradient(160deg,#0a0a1a,#1a1a2e);z-index:280;display:none;flex-direction:column;overflow:hidden;}
.backstory-screen.show{display:flex;}
.backstory-chapter{background:rgba(255,255,255,.05);border-left:4px solid var(--gold);border-radius:0 14px 14px 0;padding:14px;margin-bottom:12px;}
.backstory-ch-title{font-family:'Baloo 2',cursive;font-size:14px;color:var(--gold);font-weight:800;margin-bottom:6px;}
.backstory-ch-text{font-size:12px;color:rgba(255,255,255,.8);line-height:1.7;}
.backstory-ch-locked{filter:blur(3px) brightness(.5);pointer-events:none;}
.lore-item{background:rgba(255,215,0,.06);border:1px solid rgba(255,215,0,.2);border-radius:12px;padding:10px;margin-bottom:8px;display:flex;gap:10px;align-items:flex-start;cursor:pointer;transition:all .2s;}
.lore-item:active{background:rgba(255,215,0,.12);}
.lore-item-icon{font-size:22px;flex-shrink:0;}
.lore-item-text{font-size:11px;color:rgba(255,255,255,.75);line-height:1.5;}
.lore-item-found{border-color:var(--green);background:rgba(0,135,81,.08);}

/* INNER THOUGHTS */
.inner-thoughts-bubble{background:linear-gradient(135deg,rgba(155,89,182,.25),rgba(52,31,151,.25));border:1px solid rgba(155,89,182,.4);border-radius:16px 16px 16px 4px;padding:10px 12px;margin:6px 0;font-size:12px;color:#e0c9ff;font-style:italic;line-height:1.55;animation:fadeInUp .3s ease;}
.inner-thoughts-label{font-size:9px;color:rgba(155,89,182,.8);font-weight:800;margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px;}
.inner-thoughts-btn{background:rgba(155,89,182,.2);border:1px solid rgba(155,89,182,.45);color:#d7aefb;font-size:10px;font-weight:800;padding:3px 7px;border-radius:8px;cursor:pointer;flex-shrink:0;transition:all .2s;}
.inner-thoughts-btn.locked{opacity:.35;cursor:not-allowed;}

/* NARRATOR */
.narrator-bubble{background:linear-gradient(135deg,rgba(74,144,226,.15),rgba(0,135,81,.1));border:1px solid rgba(74,144,226,.35);border-radius:12px;padding:10px 12px;margin:6px 0;font-size:12px;color:rgba(180,220,255,.9);line-height:1.55;}
.narrator-label{font-size:9px;color:rgba(74,144,226,.75);font-weight:800;margin-bottom:3px;text-transform:uppercase;letter-spacing:.5px;}

/* CROSSOVER */
.crossover-banner{background:linear-gradient(135deg,var(--pink),var(--orange));color:white;font-size:11px;font-weight:800;padding:6px 12px;text-align:center;border-radius:10px;margin-bottom:8px;animation:fadeInUp .4s ease;}
.crossover-overlay{position:absolute;inset:0;background:rgba(0,0,0,.9);z-index:60;display:none;flex-direction:column;justify-content:center;align-items:center;padding:20px;text-align:center;}
.crossover-overlay.show{display:flex;}

/* NEW GAME+ */
.ng-plus-banner{background:linear-gradient(135deg,#7c3aed,#db2777);color:white;padding:7px 14px;display:flex;align-items:center;gap:8px;font-size:11px;font-weight:800;flex-shrink:0;z-index:10;}
.ng-plus-badge{background:rgba(255,255,255,.25);border-radius:8px;padding:2px 8px;font-size:10px;}
.hard-choice-marker{font-size:9px;background:rgba(231,76,60,.3);border:1px solid rgba(231,76,60,.5);border-radius:6px;padding:1px 5px;color:#ff6b6b;margin-left:4px;font-weight:800;}
.ng-choice-extra{border:2px dashed rgba(155,89,182,.5)!important;position:relative;}
.ng-choice-extra::before{content:'NG+';position:absolute;top:-8px;left:8px;background:#7c3aed;color:white;font-size:9px;font-weight:800;padding:1px 5px;border-radius:6px;}

/* DIFFICULTY */
.difficulty-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px;}
.diff-card{background:rgba(255,255,255,.06);border:2px solid rgba(255,255,255,.12);border-radius:12px;padding:10px;cursor:pointer;text-align:center;transition:all .2s;}
.diff-card:active{transform:scale(.97);}
.diff-card.selected{border-color:var(--gold);background:rgba(255,215,0,.08);}
.diff-card-emoji{font-size:26px;margin-bottom:4px;}
.diff-card-name{font-family:'Baloo 2',cursive;font-size:13px;color:white;font-weight:800;}
.diff-card-desc{font-size:10px;color:rgba(255,255,255,.5);margin-top:3px;line-height:1.3;}

/* SETTINGS SCREEN */
#settings-screen{background:linear-gradient(160deg,#0a0a1a,#1a1a2e);overflow-y:auto;padding:12px;}
.settings-section{margin-bottom:18px;}
.settings-section-title{font-family:'Baloo 2',cursive;font-size:14px;color:var(--gold);font-weight:800;margin-bottom:10px;padding-bottom:4px;border-bottom:1px solid rgba(255,215,0,.2);}
.settings-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.06);}
.settings-label{font-size:13px;color:white;font-weight:700;}
.settings-sublabel{font-size:10px;color:rgba(255,255,255,.4);margin-top:2px;}
.toggle-switch{width:44px;height:24px;background:rgba(255,255,255,.15);border-radius:12px;position:relative;cursor:pointer;transition:background .3s;flex-shrink:0;}
.toggle-switch.on{background:var(--green);}
.toggle-knob{position:absolute;top:3px;left:3px;width:18px;height:18px;background:white;border-radius:50%;transition:transform .3s;box-shadow:0 1px 4px rgba(0,0,0,.3);}
.toggle-switch.on .toggle-knob{transform:translateX(20px);}
.save-code-box{background:rgba(0,0,0,.4);border:1px solid rgba(255,215,0,.3);border-radius:10px;padding:10px 12px;font-family:monospace;font-size:11px;color:var(--gold);word-break:break-all;letter-spacing:.5px;margin:8px 0;}
.settings-btn{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);color:white;padding:8px 16px;border-radius:10px;font-family:'Nunito',sans-serif;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s;}
.settings-btn:active{background:rgba(255,255,255,.16);}
.settings-btn.danger{border-color:rgba(231,76,60,.4);color:#ff6b6b;background:rgba(231,76,60,.08);}

/* TUTORIAL */
#tutorial-screen{background:linear-gradient(160deg,#1a1a2e,#0f3460);overflow:hidden;}
.tutorial-step{text-align:center;padding:20px 16px;display:none;flex:1;flex-direction:column;justify-content:center;}
.tutorial-step.active{display:flex;}
.tutorial-emoji{font-size:60px;margin-bottom:14px;animation:pop-in .5s cubic-bezier(.34,1.56,.64,1);}
.tutorial-title{font-family:'Baloo 2',cursive;font-size:21px;color:var(--gold);font-weight:800;margin-bottom:8px;}
.tutorial-body{font-size:13px;color:rgba(255,255,255,.8);line-height:1.7;margin-bottom:16px;}
.tutorial-dots{display:flex;justify-content:center;gap:6px;margin-bottom:14px;}
.tutorial-dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.2);}
.tutorial-dot.active{background:var(--gold);}
.practice-npc{background:rgba(255,255,255,.06);border:2px solid rgba(0,188,212,.3);border-radius:16px;padding:14px;margin:8px 0;}
.practice-npc-name{font-family:'Baloo 2',cursive;font-size:14px;color:var(--teal);font-weight:800;margin-bottom:3px;}
.practice-choice{background:rgba(0,188,212,.08);border:1px solid rgba(0,188,212,.25);color:white;padding:9px 12px;border-radius:12px;font-size:12px;cursor:pointer;text-align:left;margin-bottom:6px;transition:all .2s;display:block;width:100%;font-family:'Nunito',sans-serif;}
.practice-choice:active{background:rgba(0,188,212,.18);}
.practice-feedback{font-size:12px;line-height:1.5;padding:10px;border-radius:10px;margin-top:8px;display:none;}
.practice-feedback.good{background:rgba(0,135,81,.15);color:var(--green-light);display:block;}
.practice-feedback.bad{background:rgba(231,76,60,.15);color:#ff6b6b;display:block;}

/* SECRET NPC unlock */
.secret-npc-teaser{background:linear-gradient(135deg,rgba(255,215,0,.08),rgba(255,107,53,.08));border:2px dashed rgba(255,215,0,.35);border-radius:16px;padding:16px;text-align:center;margin-bottom:12px;cursor:pointer;transition:all .2s;}
.secret-npc-teaser:active{transform:scale(.98);}

/* ACCESSIBILITY CLASSES */
body.large-text .dialogue-text,body.large-text .choice-btn,body.large-text .msg{font-size:15px!important;}
body.large-text .tip-body,body.large-text .backstory-ch-text{font-size:14px!important;}
body.high-contrast #app{filter:contrast(1.35) saturate(1.15);}
body.reduce-motion *{animation-duration:.01ms!important;transition-duration:.01ms!important;}

/* ====== MOBILE FIT ‚Äî NO ZOOM, NO OVERFLOW ====== */
html {
  font-size: 16px; /* Prevents iOS auto-zoom on inputs */
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
}

/* Prevent iOS zoom on input focus */
input, select, textarea {
  font-size: max(16px, 1em) !important;
}

/* Scrollable inner areas must not overflow their container */
.screen > [style*="overflow-y:auto"],
.screen > [style*="overflow-y: auto"],
.phone-contacts,
.chat-messages {
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
}

/* Dialogue box: shrink on small screens */
.dialogue-box {
  max-height: 52vh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

/* Choices should never push off screen */
.choices-container {
  max-height: 38vh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

/* Scene bg layer takes remaining space */
.scene-bg-layer {
  flex: 1;
  min-height: 0;
}

/* Map container takes remaining space */
.map-container {
  flex: 1;
  min-height: 0;
  overflow: hidden;
}

/* Bottom nav always visible, never cut off */
.bottom-nav {
  flex-shrink: 0;
  width: 100%;
}

/* Modal sheet: never taller than screen */
.modal-sheet {
  max-height: 88dvh;
}

/* Buttons: fill width in setup/title flow */
#setup-screen .btn-primary,
#setup-screen .btn-secondary,
#title-screen .btn-primary,
#title-screen .btn-secondary {
  box-sizing: border-box;
}

/* NPC profile card: compact on short screens */
@media (max-height: 680px) {
  .npc-profile-card { margin: 6px 10px 5px; }
  .npc-profile-header { padding: 8px 10px; }
  .npc-av { width: 42px; height: 42px; }
  .npc-name { font-size: 14px; }
  .dialogue-text { font-size: 12px; min-height: 28px; margin-bottom: 8px; }
  .choice-btn { padding: 7px 10px; font-size: 11px; }
  .stats-bar { padding: 6px 8px; }
  .bottom-nav .ni { font-size: 13px; }
  .bottom-nav .nl { font-size: 7px; }
}

/* Very small screens (e.g. iPhone SE) */
@media (max-height: 580px) {
  .npc-tags { display: none; }
  .npc-profile-card { margin: 4px 8px 4px; }
  .dialogue-box { max-height: 56vh; }
}
</style>
</head>
<body>
<div id="app">
<div class="stars" id="stars"></div>
<div class="toast" id="toast"></div>
<div class="achievement-pop" id="ach-pop"><div class="ach-title">üèÜ Achievement Unlocked!</div><div class="ach-name" id="ach-pop-name"></div></div>

<!-- ===================== TITLE SCREEN ===================== -->
<div class="screen active" id="title-screen">
  <div style="overflow-y:auto;-webkit-overflow-scrolling:touch;flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:16px 20px;text-align:center;">
  <div class="flag-wrap"><div class="fs g"></div><div class="fs w"></div><div class="fs g2"></div></div>
  <svg class="char-preview" viewBox="0 0 160 160" xmlns="http://www.w3.org/2000/svg">
    <circle cx="80" cy="80" r="76" fill="#FFE5B4" stroke="#F4C542" stroke-width="3"/>
    <text x="18" y="38" font-size="18">üíö</text><text x="116" y="50" font-size="15">‚ú®</text>
    <text x="16" y="128" font-size="13">‚≠ê</text><text x="120" y="126" font-size="17">üíõ</text>
    <ellipse cx="80" cy="120" rx="30" ry="22" fill="#4A2F1A"/>
    <path d="M52 108 Q80 98 108 108 L112 130 Q80 122 48 130Z" fill="#008751"/>
    <rect x="56" y="108" width="48" height="16" rx="4" fill="#00b86b"/>
    <rect x="73" y="88" width="14" height="18" rx="7" fill="#8B5E3C"/>
    <ellipse cx="80" cy="78" rx="26" ry="28" fill="#8B5E3C"/>
    <ellipse cx="80" cy="54" rx="26" ry="12" fill="#2C1810"/>
    <ellipse cx="70" cy="74" rx="5" ry="6" fill="white"/>
    <ellipse cx="90" cy="74" rx="5" ry="6" fill="white"/>
    <circle cx="71" cy="75" r="3" fill="#2C1810"/><circle cx="91" cy="75" r="3" fill="#2C1810"/>
    <circle cx="72" cy="74" r="1" fill="white"/><circle cx="92" cy="74" r="1" fill="white"/>
    <path d="M68 87 Q80 96 92 87" stroke="#2C1810" stroke-width="2.5" stroke-linecap="round" fill="none"/>
    <path d="M72 88 Q80 93 88 88" fill="white"/>
    <path d="M64 68 Q70 64 76 68" stroke="#2C1810" stroke-width="2" stroke-linecap="round"/>
    <path d="M84 68 Q90 64 96 68" stroke="#2C1810" stroke-width="2" stroke-linecap="round"/>
    <ellipse cx="80" cy="82" rx="4" ry="3" fill="#7A4F2C"/>
  </svg>
  <div class="title-logo">Naija Love Quest</div>
  <div class="title-sub">üá≥üá¨ The Ultimate Nigerian Dating Adventure!</div>
  <div class="version-badge">‚ú® Ultimate Edition v6.0</div>
  <button class="btn-primary" onclick="goToSetup()" style="width:100%;max-width:100%;margin:6px 0;">‚ñ∂ New Game</button>
  <button class="btn-secondary" onclick="loadGame()" style="width:100%;max-width:100%;margin:4px 0;">üìÇ Continue</button>
  <button class="btn-secondary" onclick="startTutorial()" style="width:100%;max-width:100%;margin:4px 0;">üéì How to Play</button>
  <button class="btn-secondary" onclick="showSettings()" style="width:100%;max-width:100%;margin:4px 0;">‚öôÔ∏è Settings</button>
  </div>
</div>

<!-- ===================== SETUP SCREEN ===================== -->
<div class="screen" id="setup-screen">
  <div style="overflow-y:auto;padding:16px;flex:1;padding-bottom:0;">
  <div class="screen-header"><div class="screen-title">Create Your Character</div><div class="screen-sub">Who are you in this love story? üíõ</div></div>
  <div class="setup-card">
    <div class="setup-label">Your Name</div>
    <input type="text" class="name-input" id="player-name" placeholder="Enter your name..." maxlength="20">
  </div>
  <div class="setup-card">
    <div class="setup-label">Your Look</div>
    <div class="avatar-grid" id="avatar-grid"></div>
  </div>
  <div class="setup-card">
    <div class="setup-label">Your Personality</div>
    <div class="trait-grid" id="trait-grid">
      <button class="trait-btn selected" onclick="selectTrait(this,'funny')">üòÇ Funny Guy</button>
      <button class="trait-btn" onclick="selectTrait(this,'romantic')">üíï Romantic</button>
      <button class="trait-btn" onclick="selectTrait(this,'ambitious')">üöÄ Ambitious</button>
      <button class="trait-btn" onclick="selectTrait(this,'gentle')">üïäÔ∏è Gentle Soul</button>
    </div>
  </div>
  <div class="setup-card">
    <div class="setup-label">Dialogue Language</div>
    <div class="lang-toggle">
      <button class="lang-btn selected" id="lang-english" onclick="setLang('english')">üá¨üáß English</button>
      <button class="lang-btn" id="lang-pidgin" onclick="setLang('pidgin')">üá≥üá¨ Pidgin</button>
    </div>
  </div>
  </div>
  <div style="padding:12px 16px;padding-bottom:calc(12px + env(safe-area-inset-bottom));background:rgba(0,0,0,.3);flex-shrink:0;border-top:1px solid rgba(255,255,255,.08);">
    <button class="btn-primary" onclick="startGame()" style="margin:0 auto;display:block;width:100%;max-width:100%;">Let's Go! üöÄ</button>
  </div>
</div>

<!-- ===================== MAP SCREEN ===================== -->
<div class="screen" id="map-screen">
  <div class="stats-bar" id="map-stats-bar">
    <div class="stat-item"><span class="stat-icon">‚ú®</span><div class="stat-bar-wrap"><div class="stat-fill charm" id="m-charm" style="width:50%"></div></div><span class="stat-val" id="m-charm-v">50</span></div>
    <div class="stat-item"><span class="stat-icon">üí∞</span><div class="stat-bar-wrap"><div class="stat-fill money" id="m-money" style="width:60%"></div></div><span class="stat-val" id="m-money-v">60</span></div>
    <div class="stat-item"><span class="stat-icon">‚ö°</span><div class="stat-bar-wrap"><div class="energy-fill" id="energy-bar" style="width:100%"></div></div><span class="energy-label" id="energy-val">5/5</span></div>
    <div class="day-badge" id="day-badge">Day 1</div>
    <button onclick="showSettings()" style="background:none;border:none;color:rgba(255,255,255,.5);font-size:18px;cursor:pointer;padding:0 4px">‚öôÔ∏è</button>
  </div>
  <div class="map-container" id="map-container">
    <div class="map-bg-img"></div>
  </div>
  <div class="bottom-nav">
    <button class="nav-btn active" onclick="switchTab('map')"><span class="ni">üó∫Ô∏è</span><span class="nl">Map</span></button>
    <button class="nav-btn" onclick="switchTab('skills')"><span class="ni">‚ö°</span><span class="nl">Skills</span></button>
    <button class="nav-btn" onclick="switchTab('phone')"><span class="ni">üì±</span><span class="nl">Phone</span><div class="notif-dot" id="phone-notif"></div></button>
    <button class="nav-btn" onclick="switchTab('shop')"><span class="ni">üõçÔ∏è</span><span class="nl">Shop</span></button>
    <button class="nav-btn" onclick="switchTab('journal')"><span class="ni">üìî</span><span class="nl">Journal</span></button>
    <button class="nav-btn" onclick="switchTab('analytics')"><span class="ni">üìä</span><span class="nl">Stats</span></button>
    <button class="nav-btn" onclick="showLeaderboard()"><span class="ni">üèÜ</span><span class="nl">Rank</span></button>
  </div>
</div>

<!-- ===================== SCENE SCREEN ===================== -->
<div class="screen" id="scene-screen">
  <div class="stats-bar">
    <div class="stat-item"><span class="stat-icon">‚ú®</span><div class="stat-bar-wrap"><div class="stat-fill charm" id="s-charm" style="width:50%"></div></div><span class="stat-val" id="s-charm-v">50</span></div>
    <div class="stat-item"><span class="stat-icon">‚ö°</span><div class="stat-bar-wrap"><div class="energy-fill" id="s-energy-bar" style="width:100%"></div></div><span class="energy-label" id="s-energy-val">5/5</span></div>
    <button style="background:rgba(0,188,212,.2);border:1px solid rgba(0,188,212,.4);color:var(--teal);font-size:11px;font-weight:800;cursor:pointer;padding:3px 6px;border-radius:8px;margin-left:2px" onclick="callWingman()" title="Get coaching from your wingman">üï∂Ô∏è</button>
    <button style="background:rgba(155,89,182,.3);border:1px solid rgba(155,89,182,.6);color:white;font-size:11px;font-weight:800;cursor:pointer;padding:4px 8px;border-radius:8px;margin-left:2px" onclick="openWhatIfMode()">üîÆ</button>
    <button style="background:none;border:none;color:rgba(255,255,255,.7);font-size:20px;cursor:pointer;padding:4px" onclick="backToMap()">üó∫Ô∏è</button>
  </div>
  <div id="ng-plus-bar" style="display:none" class="ng-plus-banner">üåÄ <span class="ng-plus-badge">NEW GAME+</span> Harder choices ‚Äî smarter NPCs ‚Äî earned by mastery</div>
  <div id="what-if-bar" style="display:none" class="what-if-bar">üîÆ <span class="what-if-badge">WHAT IF MODE</span> Exploring alternate timeline ‚Äî changes won't be saved</div>
  <div class="npc-profile-card" id="npc-profile-card"></div>
  <div class="scene-bg-layer" id="scene-bg-layer">
    <div class="char-stage" id="char-stage"></div>
    <!-- History Panel (What If) -->
    <div class="history-panel" id="history-panel">
      <div style="font-family:'Baloo 2',cursive;font-size:18px;color:var(--gold);font-weight:800;margin-bottom:4px">üîÆ Choose a Scene to Revisit</div>
      <div style="color:rgba(255,255,255,.5);font-size:11px;margin-bottom:14px">Pick a past moment and choose differently. Changes won't affect your main save.</div>
      <div id="history-list"></div>
      <button class="btn-secondary" style="margin-top:12px" onclick="closeHistoryPanel()">‚úï Cancel</button>
    </div>
  </div>
  <div class="dialogue-box" id="dialogue-box">
    <div class="dialogue-name-row">
      <div class="dialogue-name" id="dlg-name"></div>
      <div class="dialogue-mood-label" id="dlg-mood"></div>
      <button class="inner-thoughts-btn" id="inner-thoughts-btn" onclick="showInnerThoughts()" title="What is she really thinking?">üß† Insight</button>
    </div>
    <div id="narrator-slot"></div>
    <div class="dialogue-text" id="dlg-text"></div>
    <div id="inner-thoughts-slot"></div>
    <div class="choices-container" id="choices"></div>
  </div>
  <div class="result-panel" id="result-panel">
    <div class="result-emoji" id="res-emoji">üéâ</div>
    <div class="result-title" id="res-title"></div>
    <div class="result-msg" id="res-msg"></div>
    <div class="debrief-section" id="res-debrief"></div>
    <div class="result-xp" id="res-xp"></div>
    <div id="ending-achieved-box" style="display:none;background:linear-gradient(135deg,var(--gold),#ff6b35);border-radius:14px;padding:12px;margin-bottom:12px;text-align:center">
      <div style="font-size:24px;margin-bottom:4px" id="ending-achieved-emoji">üíç</div>
      <div style="font-family:'Baloo 2',cursive;font-size:16px;font-weight:800;color:#1a1a2e" id="ending-achieved-title">Ending Unlocked!</div>
      <div style="font-size:11px;color:rgba(0,0,0,.7);margin-top:2px" id="ending-achieved-desc"></div>
    </div>
    <button class="btn-primary" style="max-width:200px" onclick="closeResult()">Continue</button>
  </div>
  <div class="minigame-panel" id="mg-panel">
    <div class="mg-title" id="mg-title">Challenge!</div>
    <div class="mg-timer" id="mg-timer">10</div>
    <div class="mg-sub" id="mg-sub"></div>
    <div class="compliment-grid" id="mg-grid"></div>
    <button class="btn-secondary" style="margin-top:12px;max-width:180px" onclick="skipMinigame()">Skip (‚àí5 Charm)</button>
  </div>
  <div class="rival-event" id="rival-event">
    <div style="font-size:48px;margin-bottom:16px">üò§</div>
    <div class="rival-title" id="rival-title">Rival Alert!</div>
    <div class="rival-msg" id="rival-msg"></div>
    <button class="btn-primary" style="max-width:200px;margin-bottom:8px" onclick="handleRival(true)">Stand Your Ground üí™</button>
    <button class="btn-secondary" style="max-width:200px" onclick="handleRival(false)">Back Off...</button>
  </div>
  <div class="trivia-panel" id="trivia-panel">
    <div style="text-align:center;font-size:32px;margin-bottom:8px">üß†</div>
    <div class="trivia-score" id="trivia-score">Cultural Trivia ‚Äî +Bonus Charm!</div>
    <div class="trivia-q" id="trivia-q"></div>
    <div class="trivia-opts" id="trivia-opts"></div>
  </div>
</div>

<!-- ===================== DATE SCENE SCREEN ===================== -->
<div class="screen" id="date-screen">
  <div class="stats-bar">
    <div class="stat-item"><span class="stat-icon">üíï</span><span style="color:white;font-family:'Baloo 2',cursive;font-size:14px;font-weight:800" id="date-screen-title">Planning a Date</span></div>
    <button style="background:none;border:none;color:rgba(255,255,255,.7);font-size:20px;cursor:pointer" onclick="backToMap()">‚úï</button>
  </div>
  <div style="overflow-y:auto;flex:1;padding:14px">
    <div class="date-planner">
      <div class="setup-label">üìç Choose Location</div>
      <div class="date-option-row" id="date-loc-row"></div>
      <div class="setup-label">üëó Your Outfit</div>
      <div class="date-option-row" id="date-outfit-row"></div>
      <div class="setup-label">üéÅ Bring a Gift</div>
      <div class="date-option-row" id="date-gift-row"></div>
      <div class="setup-label">üïê Time of Day</div>
      <div class="date-option-row" id="date-time-row"></div>
    </div>
    <div class="setup-card" id="date-preview-card" style="text-align:center;">
      <div style="color:rgba(255,255,255,.5);font-size:13px">Configure your date above üëÜ</div>
    </div>
    <button class="btn-gold" id="go-on-date-btn" onclick="goOnDate()" style="max-width:240px">üíï Go on Date!</button>
  </div>
</div>

<!-- ===================== PHONE SCREEN ===================== -->
<div class="screen" id="phone-screen">
  <div class="stats-bar">
    <div style="font-family:'Baloo 2',cursive;font-size:17px;color:var(--gold);font-weight:800;flex:1">üì± Messages</div>
    <button class="nav-btn" onclick="switchTab('map')" style="flex:none;padding:4px 8px"><span style="font-size:18px">üó∫Ô∏è</span></button>
  </div>
  <div class="phone-contacts" id="phone-contacts"></div>
  <div class="bottom-nav">
    <button class="nav-btn" onclick="switchTab('map')"><span class="ni">üó∫Ô∏è</span><span class="nl">Map</span></button>
    <button class="nav-btn" onclick="switchTab('skills')"><span class="ni">‚ö°</span><span class="nl">Skills</span></button>
    <button class="nav-btn active" onclick="switchTab('phone')"><span class="ni">üì±</span><span class="nl">Phone</span></button>
    <button class="nav-btn" onclick="switchTab('shop')"><span class="ni">üõçÔ∏è</span><span class="nl">Shop</span></button>
    <button class="nav-btn" onclick="switchTab('journal')"><span class="ni">üìî</span><span class="nl">Journal</span></button>
    <button class="nav-btn" onclick="switchTab('analytics')"><span class="ni">üìä</span><span class="nl">Stats</span></button>
    <button class="nav-btn" onclick="showLeaderboard()"><span class="ni">üèÜ</span><span class="nl">Rank</span></button>
  </div>
</div>

<!-- ===================== CHAT SCREEN ===================== -->
<div class="screen" id="chat-screen">
  <div class="chat-header">
    <button class="chat-back" onclick="showScreen('phone-screen')">‚Äπ</button>
    <div class="npc-av" id="chat-av" style="width:40px;height:40px;"></div>
    <div style="flex:1">
      <div class="chat-name" id="chat-name"></div>
      <div class="chat-status" id="chat-status">‚óè Online</div>
    </div>
    <button onclick="openDatePlanner(G.currentNPC)" style="background:none;border:none;color:var(--gold);font-size:12px;font-weight:800;cursor:pointer">üìÖ Date</button>
  </div>
  <div class="chat-messages" id="chat-messages"></div>
  <div class="chat-input-area">
    <div class="chat-replies" id="chat-replies"></div>
  </div>
</div>

<!-- ===================== SKILLS SCREEN ===================== -->
<div class="screen" id="skills-screen">
  <div class="stats-bar">
    <div style="font-family:'Baloo 2',cursive;font-size:17px;color:var(--gold);font-weight:800;flex:1">‚ö° Skill Tree</div>
    <div style="color:var(--gold);font-weight:800;font-size:13px" id="skill-points-display">SP: 0</div>
  </div>
  <div style="overflow-y:auto;flex:1;padding:12px" id="skills-content"></div>
  <div class="bottom-nav">
    <button class="nav-btn" onclick="switchTab('map')"><span class="ni">üó∫Ô∏è</span><span class="nl">Map</span></button>
    <button class="nav-btn active" onclick="switchTab('skills')"><span class="ni">‚ö°</span><span class="nl">Skills</span></button>
    <button class="nav-btn" onclick="switchTab('phone')"><span class="ni">üì±</span><span class="nl">Phone</span></button>
    <button class="nav-btn" onclick="switchTab('shop')"><span class="ni">üõçÔ∏è</span><span class="nl">Shop</span></button>
    <button class="nav-btn" onclick="switchTab('journal')"><span class="ni">üìî</span><span class="nl">Journal</span></button>
    <button class="nav-btn" onclick="switchTab('analytics')"><span class="ni">üìä</span><span class="nl">Stats</span></button>
    <button class="nav-btn" onclick="showLeaderboard()"><span class="ni">üèÜ</span><span class="nl">Rank</span></button>
  </div>
</div>

<!-- ===================== SHOP SCREEN ===================== -->
<div class="screen" id="shop-screen">
  <div class="stats-bar">
    <div style="font-family:'Baloo 2',cursive;font-size:17px;color:var(--gold);font-weight:800;flex:1">üõçÔ∏è Shop</div>
    <div style="color:var(--gold);font-weight:800;font-size:14px">üí∞ <span id="wallet-display">3000</span></div>
  </div>
  <div style="overflow-y:auto;flex:1;padding:12px">
    <div class="setup-label" style="margin-bottom:10px;padding-left:4px">üéÅ Gifts for Her</div>
    <div class="gift-grid" id="gift-grid"></div>
    <div class="setup-label" style="margin:14px 0 10px;padding-left:4px">üí™ Self-Improvement</div>
    <div class="activity-list" id="activity-list"></div>
  </div>
  <div class="bottom-nav">
    <button class="nav-btn" onclick="switchTab('map')"><span class="ni">üó∫Ô∏è</span><span class="nl">Map</span></button>
    <button class="nav-btn" onclick="switchTab('skills')"><span class="ni">‚ö°</span><span class="nl">Skills</span></button>
    <button class="nav-btn" onclick="switchTab('phone')"><span class="ni">üì±</span><span class="nl">Phone</span></button>
    <button class="nav-btn active" onclick="switchTab('shop')"><span class="ni">üõçÔ∏è</span><span class="nl">Shop</span></button>
    <button class="nav-btn" onclick="switchTab('journal')"><span class="ni">üìî</span><span class="nl">Journal</span></button>
    <button class="nav-btn" onclick="switchTab('analytics')"><span class="ni">üìä</span><span class="nl">Stats</span></button>
    <button class="nav-btn" onclick="showLeaderboard()"><span class="ni">üèÜ</span><span class="nl">Rank</span></button>
  </div>
</div>

<!-- ===================== JOURNAL SCREEN ===================== -->
<div class="screen" id="journal-screen">
  <div class="stats-bar">
    <div style="font-family:'Baloo 2',cursive;font-size:17px;color:var(--gold);font-weight:800;flex:1">üìî Relationship Journal</div>
  </div>
  <div style="overflow-y:auto;flex:1;padding:12px" id="journal-list"></div>
  <div class="bottom-nav">
    <button class="nav-btn" onclick="switchTab('map')"><span class="ni">üó∫Ô∏è</span><span class="nl">Map</span></button>
    <button class="nav-btn" onclick="switchTab('skills')"><span class="ni">‚ö°</span><span class="nl">Skills</span></button>
    <button class="nav-btn" onclick="switchTab('phone')"><span class="ni">üì±</span><span class="nl">Phone</span></button>
    <button class="nav-btn" onclick="switchTab('shop')"><span class="ni">üõçÔ∏è</span><span class="nl">Shop</span></button>
    <button class="nav-btn active" onclick="switchTab('journal')"><span class="ni">üìî</span><span class="nl">Journal</span></button>
    <button class="nav-btn" onclick="switchTab('analytics')"><span class="ni">üìä</span><span class="nl">Stats</span></button>
    <button class="nav-btn" onclick="showLeaderboard()"><span class="ni">üèÜ</span><span class="nl">Rank</span></button>
  </div>
</div>

<!-- ===================== ACHIEVEMENTS SCREEN ===================== -->
<div class="screen" id="achievements-screen">
  <div class="stats-bar">
    <div style="font-family:'Baloo 2',cursive;font-size:17px;color:var(--gold);font-weight:800;flex:1">üèÜ Achievements</div>
    <div style="color:rgba(255,255,255,.6);font-size:12px" id="ach-progress">0/0</div>
  </div>
  <div style="overflow-y:auto;flex:1;padding:12px">
    <div class="ach-grid" id="ach-grid"></div>
  </div>
  <div class="bottom-nav">
    <button class="nav-btn" onclick="switchTab('map')"><span class="ni">üó∫Ô∏è</span><span class="nl">Map</span></button>
    <button class="nav-btn" onclick="switchTab('skills')"><span class="ni">‚ö°</span><span class="nl">Skills</span></button>
    <button class="nav-btn" onclick="switchTab('phone')"><span class="ni">üì±</span><span class="nl">Phone</span></button>
    <button class="nav-btn" onclick="switchTab('shop')"><span class="ni">üõçÔ∏è</span><span class="nl">Shop</span></button>
    <button class="nav-btn" onclick="switchTab('journal')"><span class="ni">üìî</span><span class="nl">Journal</span></button>
    <button class="nav-btn" onclick="switchTab('analytics')"><span class="ni">üìä</span><span class="nl">Stats</span></button>
    <button class="nav-btn active" onclick="showLeaderboard()"><span class="ni">üèÜ</span><span class="nl">Rank</span></button>
  </div>
</div>

<!-- ===================== ANALYTICS SCREEN ===================== -->
<div class="screen" id="analytics-screen">
  <div class="stats-bar">
    <button onclick="backToMap()" style="background:none;border:none;color:var(--gold);font-size:22px;cursor:pointer">‚Äπ</button>
    <div style="font-family:'Baloo 2',cursive;font-size:17px;color:var(--gold);font-weight:800;flex:1;text-align:center">üìä Relationship Analytics</div>
    <button onclick="showShareCard()" style="background:rgba(255,215,0,.2);border:1px solid rgba(255,215,0,.4);color:var(--gold);font-size:11px;font-weight:800;padding:4px 8px;border-radius:8px;cursor:pointer">üì§ Share</button>
  </div>
  <div style="overflow-y:auto;flex:1;padding:12px" id="analytics-content"></div>
  <div class="bottom-nav">
    <button class="nav-btn" onclick="switchTab('map')"><span class="ni">üó∫Ô∏è</span><span class="nl">Map</span></button>
    <button class="nav-btn" onclick="switchTab('skills')"><span class="ni">‚ö°</span><span class="nl">Skills</span></button>
    <button class="nav-btn" onclick="switchTab('phone')"><span class="ni">üì±</span><span class="nl">Phone</span></button>
    <button class="nav-btn" onclick="switchTab('shop')"><span class="ni">üõçÔ∏è</span><span class="nl">Shop</span></button>
    <button class="nav-btn" onclick="switchTab('journal')"><span class="ni">üìî</span><span class="nl">Journal</span></button>
    <button class="nav-btn active" onclick="switchTab('analytics')"><span class="ni">üìä</span><span class="nl">Stats</span></button>
    <button class="nav-btn" onclick="showLeaderboard()"><span class="ni">üèÜ</span><span class="nl">Rank</span></button>
  </div>
</div>

<!-- ===================== BESTIE SCREEN ===================== -->
<div class="screen" id="bestie-screen">
  <div class="stats-bar">
    <button onclick="backToMap()" style="background:none;border:none;color:var(--gold);font-size:22px;cursor:pointer">‚Äπ</button>
    <div style="font-family:'Baloo 2',cursive;font-size:17px;color:var(--gold);font-weight:800;flex:1;text-align:center">üí¨ Emeka - Best Friend</div>
  </div>
  <div class="bestie-header">
    <div style="font-size:48px;margin-bottom:6px">üßëüèæ</div>
    <div style="font-family:'Baloo 2',cursive;font-size:16px;color:white;font-weight:700">Emeka Obi</div>
    <div style="font-size:11px;color:var(--teal)">Your Day-One üíØ ‚Äî Always Real With You</div>
  </div>
  <div class="bestie-messages" id="bestie-messages"></div>
  <div class="bestie-replies" id="bestie-replies"></div>
</div>

<!-- ===================== LEADERBOARD SCREEN ===================== -->
<div class="screen" id="leaderboard-screen">
  <div class="stats-bar">
    <button onclick="backToMap()" style="background:none;border:none;color:var(--gold);font-size:22px;cursor:pointer">‚Äπ</button>
    <div style="font-family:'Baloo 2',cursive;font-size:17px;color:var(--gold);font-weight:800;flex:1;text-align:center">üèÜ Community Leaderboard</div>
  </div>
  <div style="overflow-y:auto;flex:1;padding:12px">
    <div style="color:rgba(255,255,255,.4);font-size:11px;text-align:center;margin-bottom:14px">Average compatibility score across all NPCs</div>
    <div id="leaderboard-list"></div>
    <div style="background:rgba(255,255,255,.04);border-radius:12px;padding:12px;margin-top:12px;text-align:center">
      <div style="font-size:11px;color:rgba(255,255,255,.5);margin-bottom:6px">üí° Play more to climb the rankings!</div>
      <div class="daily-challenge-bar" id="daily-challenge-display" onclick="showDailyChallenge()"></div>
    </div>
  </div>
  <div class="bottom-nav">
    <button class="nav-btn" onclick="switchTab('map')"><span class="ni">üó∫Ô∏è</span><span class="nl">Map</span></button>
    <button class="nav-btn" onclick="switchTab('skills')"><span class="ni">‚ö°</span><span class="nl">Skills</span></button>
    <button class="nav-btn" onclick="switchTab('phone')"><span class="ni">üì±</span><span class="nl">Phone</span></button>
    <button class="nav-btn" onclick="switchTab('shop')"><span class="ni">üõçÔ∏è</span><span class="nl">Shop</span></button>
    <button class="nav-btn" onclick="switchTab('journal')"><span class="ni">üìî</span><span class="nl">Journal</span></button>
    <button class="nav-btn" onclick="switchTab('analytics')"><span class="ni">üìä</span><span class="nl">Stats</span></button>
    <button class="nav-btn active" onclick="showLeaderboard()"><span class="ni">üèÜ</span><span class="nl">Rank</span></button>
  </div>
</div>

<!-- ===================== SETTINGS SCREEN ===================== -->
<div class="screen" id="settings-screen">
  <div class="stats-bar">
    <button onclick="closeSettings()" style="background:none;border:none;color:var(--gold);font-size:22px;cursor:pointer">‚Äπ</button>
    <div style="font-family:'Baloo 2',cursive;font-size:17px;color:var(--gold);font-weight:800;flex:1;text-align:center">‚öôÔ∏è Settings</div>
  </div>
  <div style="overflow-y:auto;flex:1;padding:12px" id="settings-content"></div>
</div>

<!-- ===================== TUTORIAL SCREEN ===================== -->
<div class="screen" id="tutorial-screen">
  <div class="stats-bar">
    <button onclick="skipTutorial()" style="background:none;border:none;color:rgba(255,255,255,.5);font-size:13px;font-weight:800;cursor:pointer">Skip ‚Ä∫</button>
    <div style="font-family:'Baloo 2',cursive;font-size:17px;color:var(--gold);font-weight:800;flex:1;text-align:center">How to Play</div>
  </div>
  <div style="overflow-y:auto;flex:1;display:flex;flex-direction:column" id="tutorial-steps-wrap"></div>
  <div style="padding:12px 16px;display:flex;gap:8px;flex-shrink:0">
    <button class="btn-secondary" id="tut-prev-btn" onclick="tutPrev()" style="flex:1">‚Äπ Back</button>
    <button class="btn-primary" id="tut-next-btn" onclick="tutNext()" style="flex:1">Next ‚Ä∫</button>
  </div>
</div>

<!-- ===================== BACKSTORY SCREEN ===================== -->
<div class="backstory-screen" id="backstory-screen">
  <div class="stats-bar">
    <button onclick="closeBackstory()" style="background:none;border:none;color:var(--gold);font-size:22px;cursor:pointer">‚Äπ</button>
    <div style="font-family:'Baloo 2',cursive;font-size:17px;color:var(--gold);font-weight:800;flex:1;text-align:center" id="backstory-npc-name">Her Story</div>
    <div style="font-size:11px;color:rgba(255,255,255,.4)" id="backstory-unlock-hint">Interest ‚â• 40 to unlock</div>
  </div>
  <div style="overflow-y:auto;flex:1;padding:12px">
    <div id="backstory-chapters"></div>
    <div style="margin-top:14px">
      <div style="font-family:'Baloo 2',cursive;font-size:14px;color:var(--teal);font-weight:800;margin-bottom:8px">üîç Hidden Lore Items</div>
      <div id="backstory-lore"></div>
    </div>
  </div>
</div>

<!-- ===================== CROSSOVER SCENE OVERLAY ===================== -->
<div class="crossover-overlay" id="crossover-overlay">
  <div style="font-size:60px;margin-bottom:14px" id="crossover-emoji">‚ö°</div>
  <div style="font-family:'Baloo 2',cursive;font-size:22px;color:var(--gold);font-weight:800;margin-bottom:8px" id="crossover-title">Special Encounter!</div>
  <div style="font-size:13px;color:rgba(255,255,255,.8);line-height:1.6;margin-bottom:18px;max-width:320px" id="crossover-text"></div>
  <div style="display:flex;flex-direction:column;gap:8px;width:100%;max-width:320px" id="crossover-choices"></div>
  <button class="btn-secondary" style="margin-top:8px;max-width:200px" onclick="closeCrossover()">Skip Encounter</button>
</div>

<!-- TIPS SCREEN ===================== -->
<div class="screen" id="tips-screen">
  <div class="stats-bar">
    <div style="font-family:'Baloo 2',cursive;font-size:17px;color:var(--gold);font-weight:800;flex:1">üí° Dating Tips</div>
    <button onclick="backToMap()" style="background:none;border:none;color:rgba(255,255,255,.6);font-size:20px;cursor:pointer">‚úï</button>
  </div>
  <div style="overflow-y:auto;flex:1;padding:12px" id="tips-content"></div>
</div>

<!-- ===================== EVENT SCREEN ===================== -->
<div class="screen" id="event-screen">
  <div class="stats-bar">
    <div style="font-family:'Baloo 2',cursive;font-size:17px;color:var(--gold);font-weight:800;flex:1">üéâ Special Event</div>
    <button onclick="backToMap()" style="background:none;border:none;color:rgba(255,255,255,.6);font-size:20px;cursor:pointer">‚úï</button>
  </div>
  <div style="overflow-y:auto;flex:1;padding:16px" id="event-content"></div>
</div>

<!-- ===================== ENDINGS SCREEN ===================== -->
<div class="screen" id="endings-screen">
  <div class="stats-bar">
    <div style="font-family:'Baloo 2',cursive;font-size:17px;color:var(--gold);font-weight:800;flex:1">üí´ Story Endings</div>
    <button onclick="backToMap()" style="background:none;border:none;color:rgba(255,255,255,.6);font-size:20px;cursor:pointer">‚úï</button>
  </div>
  <div style="overflow-y:auto;flex:1;padding:14px">
    <div style="color:rgba(255,255,255,.5);font-size:12px;text-align:center;margin-bottom:14px">Each character has 5 unique endings based on your choices</div>
    <div id="endings-content"></div>
  </div>
</div>

<!-- ===================== ENERGY DEPLETED ===================== -->
<div class="energy-depleted-overlay" id="energy-depleted">
  <div style="font-size:56px;margin-bottom:14px">üò¥</div>
  <div style="font-family:'Baloo 2',cursive;font-size:24px;color:var(--gold);font-weight:800;margin-bottom:10px">Tired Out!</div>
  <div style="color:rgba(255,255,255,.8);font-size:14px;line-height:1.6;margin-bottom:20px">You've used all your energy for today. Rest up and come back tomorrow stronger!</div>
  <button class="btn-primary" onclick="restAndRecover()">üò¥ Rest & Recover (+3 Energy)</button>
  <button class="btn-secondary" onclick="spendToRecover()" style="margin-top:8px">‚òï Drink Energy Drink (‚Ç¶300)</button>
</div>

<!-- RIPPLE TOAST (consequence notifications) -->
<div class="ripple-toast" id="ripple-toast"></div>

<!-- PARTICLE CONTAINER -->
<div class="particle-container" id="particle-container"></div>

<!-- SCENE TRANSITION OVERLAY -->
<div class="screen-transition-overlay" id="scene-transition"></div>

<!-- WINGMAN PANEL -->
<div class="wingman-panel" id="wingman-panel">
  <div class="wingman-avatar">üï∂Ô∏è</div>
  <div style="flex:1">
    <div class="wingman-name">Chidi ‚Äî Your Wingman</div>
    <div class="wingman-text" id="wingman-text">Yo! I got eyes on the situation. Let me give you the play...</div>
  </div>
  <button class="wingman-close" onclick="closeWingman()">‚úï</button>
</div>

<!-- GOSSIP POPUP -->
<div class="gossip-popup" id="gossip-popup">
  <div style="font-size:28px;flex-shrink:0">üó£Ô∏è</div>
  <div style="flex:1">
    <div class="gossip-title">üí¨ Street Gossip</div>
    <div class="gossip-text" id="gossip-text"></div>
    <div class="gossip-source" id="gossip-source"></div>
  </div>
  <button onclick="closeGossip()" style="background:none;border:none;color:rgba(255,255,255,.4);font-size:18px;cursor:pointer;flex-shrink:0;align-self:flex-start">‚úï</button>
</div>

<!-- MILESTONE CUTSCENE -->
<div class="milestone-cutscene" id="milestone-cutscene">
  <div style="padding:20px;text-align:center;border-bottom:1px solid rgba(255,215,0,.2)">
    <div style="font-family:'Baloo 2',cursive;font-size:22px;color:var(--gold);font-weight:800" id="milestone-title">üíç Major Milestone!</div>
  </div>
  <div class="milestone-panel-row" id="milestone-panels"></div>
  <div style="padding:16px;text-align:center">
    <div style="font-size:13px;color:rgba(255,255,255,.7);margin-bottom:12px" id="milestone-text"></div>
    <button class="btn-gold" style="max-width:200px" onclick="closeMilestoneCutscene()">Continue ‚Ä∫</button>
  </div>
</div>

<!-- SHARE MODAL -->
<div class="modal-overlay" id="share-modal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div style="font-family:'Baloo 2',cursive;font-size:18px;color:var(--gold);font-weight:800;text-align:center;margin-bottom:14px">üì§ Your Relationship Report Card</div>
    <div id="share-card-preview"></div>
    <button class="btn-primary" onclick="downloadShareCard()" style="margin-top:8px">üíæ Save as Image</button>
    <button class="btn-secondary" onclick="closeShareModal()">‚úï Close</button>
  </div>
</div>

<!-- DAILY CHALLENGE MODAL -->
<div class="modal-overlay" id="daily-challenge-modal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div style="text-align:center;font-size:48px;margin-bottom:8px">üéØ</div>
    <div style="font-family:'Baloo 2',cursive;font-size:20px;color:var(--pink);font-weight:800;text-align:center;margin-bottom:8px">Daily Challenge!</div>
    <div id="daily-challenge-content"></div>
    <button class="btn-secondary" onclick="closeDailyChallengeModal()">‚úï Close</button>
  </div>
</div>

<!-- ===================== CUTSCENE OVERLAY ===================== -->
<div class="cutscene-overlay" id="cutscene-overlay">
  <div class="cutscene-emoji" id="cutscene-emoji">üíï</div>
  <div class="cutscene-title" id="cutscene-title">A Moment...</div>
  <div class="cutscene-text" id="cutscene-text"></div>
  <div class="cutscene-sub" id="cutscene-sub"></div>
  <button class="btn-gold" style="max-width:220px" onclick="closeCutscene()">Continue ‚Ä∫</button>
</div>

<!-- ===================== MEET THE FAMILY SCREEN ===================== -->
<div class="screen" id="family-screen">
  <div class="stats-bar">
    <button style="background:none;border:none;color:var(--gold);font-size:22px;cursor:pointer" onclick="backToMap()">‚Äπ</button>
    <div style="font-family:'Baloo 2',cursive;font-size:17px;color:var(--gold);font-weight:800;flex:1;text-align:center" id="family-screen-title">Meet the Family üë®‚Äçüë©‚Äçüëß</div>
  </div>
  <div style="overflow-y:auto;flex:1;padding:14px">
    <div style="color:rgba(255,255,255,.6);font-size:12px;text-align:center;margin-bottom:14px" id="family-intro"></div>
    <div id="family-members"></div>
    <div id="family-result" style="display:none;background:rgba(255,255,255,.07);border-radius:14px;padding:14px;margin-top:12px;text-align:center"></div>
    <button class="btn-secondary" style="margin-top:12px" onclick="backToMap()">‚Üê Back to Lagos</button>
  </div>
</div>

<!-- ===================== RHYTHM GAME (Suya / Dance) ===================== -->
<div class="rhythm-game" id="rhythm-game">
  <div class="rhythm-title" id="rhythm-title">üî• Suya Date!</div>
  <div class="rhythm-sub" id="rhythm-sub">Tap the lane when the note reaches the circle!</div>
  <div class="rhythm-score-bar">
    <div class="rhythm-combo" id="rhythm-combo">0x</div>
    <div class="rhythm-accuracy"><div class="rhythm-accuracy-fill" id="rhythm-acc-fill" style="width:100%"></div></div>
    <div style="font-family:'Baloo 2',cursive;font-size:16px;color:var(--gold);font-weight:800" id="rhythm-score-val">0</div>
  </div>
  <div class="rhythm-track" id="rhythm-track">
    <div class="rhythm-lanes" id="rhythm-lanes"></div>
    <div class="rhythm-feedback" id="rhythm-feedback">PERFECT!</div>
  </div>
  <div style="margin-top:12px;text-align:center;color:rgba(255,255,255,.4);font-size:11px" id="rhythm-timer-display">Get ready...</div>
  <button class="btn-secondary" style="margin-top:10px;max-width:180px" onclick="endRhythmGame(false)">Skip (‚àí5 Charm)</button>
</div>

<!-- ===================== JOLLOF COOK-OFF GAME ===================== -->
<div class="cookoff-game" id="cookoff-game">
  <div class="cookoff-title">üçö Jollof Rice Cook-Off!</div>
  <div style="color:rgba(255,255,255,.6);font-size:12px;margin-bottom:8px;text-align:center">Put the steps in the RIGHT order to cook the perfect Jollof!</div>
  <div class="cookoff-progress" id="cookoff-progress"></div>
  <div style="font-family:'Baloo 2',cursine;font-size:13px;color:rgba(255,255,255,.5);margin-bottom:8px;text-align:center" id="cookoff-instruction">Select the NEXT correct step:</div>
  <div class="cookoff-steps" id="cookoff-steps"></div>
  <button class="btn-secondary" style="margin-top:10px;max-width:180px;flex-shrink:0" onclick="endCookoff(false)">Skip (‚àí5 Charm)</button>
</div>

<!-- ===================== PHOTO COMPOSITION GAME ===================== -->
<div class="photo-game" id="photo-game">
  <div style="font-family:'Baloo 2',cursive;font-size:19px;color:var(--gold);font-weight:800;margin-bottom:3px">üì∏ Bisi's Photo Date!</div>
  <div style="color:rgba(255,255,255,.6);font-size:11px;margin-bottom:6px;text-align:center">Frame the shot perfectly ‚Äî tap the viewfinder to aim, then snap!</div>
  <div style="font-family:'Baloo 2',cursive;font-size:14px;color:white;margin-bottom:4px;text-align:center">Shots left: <span id="photo-shots">5</span></div>
  <div class="photo-viewfinder" id="photo-viewfinder">
    <div class="photo-subject" id="photo-subject">üåÜ</div>
    <div class="photo-reticle" id="photo-reticle" style="left:90px;top:90px;"></div>
  </div>
  <button class="photo-snap-btn" id="photo-snap" onclick="snapPhoto()">üì∑</button>
  <div class="photo-score-row" id="photo-criteria-row"></div>
  <div style="font-family:'Baloo 2',cursive;font-size:16px;color:var(--gold);font-weight:800;margin-top:8px">Score: <span id="photo-score-display">0</span>/100</div>
  <button class="btn-secondary" style="margin-top:8px;max-width:180px" onclick="endPhotoGame(false)">Done Shooting</button>
</div>

<!-- ===================== LEGAL DEBATE GAME ===================== -->
<div class="debate-game" id="debate-game">
  <div style="font-family:'Baloo 2',cursive;font-size:19px;color:var(--gold);font-weight:800;margin-bottom:6px;text-align:center">‚öñÔ∏è Legal Debate!</div>
  <div class="debate-score-row">
    <div class="debate-score-box"><div class="debate-score-label">You</div><div class="debate-score-val" id="debate-your-score">0</div></div>
    <div class="debate-score-box" style="background:rgba(231,76,60,.08)"><div class="debate-score-label">Amaka</div><div class="debate-score-val" id="debate-opp-score">0</div></div>
    <div class="debate-score-box"><div class="debate-score-label">Round</div><div class="debate-score-val" id="debate-round">1/3</div></div>
  </div>
  <div class="debate-case" id="debate-case"><div class="debate-case-title" id="debate-case-title">Case Loading...</div><div id="debate-case-text"></div></div>
  <div style="font-size:12px;color:rgba(255,255,255,.5);margin-bottom:8px">Choose your strongest argument:</div>
  <div class="debate-args" id="debate-args"></div>
  <button class="btn-secondary" style="margin-top:10px;max-width:180px;flex-shrink:0" onclick="endDebateGame(false)">Concede (‚àí5 Charm)</button>
</div>

<!-- ===================== CHESS GAME ===================== -->
<div class="chess-game" id="chess-game">
  <div style="font-family:'Baloo 2',cursive;font-size:19px;color:var(--gold);font-weight:800;margin-bottom:3px;text-align:center">‚ôüÔ∏è Chess with Ngozi!</div>
  <div style="color:rgba(255,255,255,.5);font-size:11px;margin-bottom:6px;text-align:center">Play smart ‚Äî she's watching how you think!</div>
  <div class="chess-status" id="chess-status">Your move (White)</div>
  <div class="chess-captures" id="chess-captures"></div>
  <div class="chess-board" id="chess-board"></div>
  <div style="display:flex;gap:10px;margin-top:10px">
    <button class="btn-secondary" style="flex:1;max-width:none" onclick="endChessGame('draw')">Offer Draw</button>
    <button class="btn-gold" style="flex:1;max-width:none" onclick="endChessGame('resign')">Resign</button>
  </div>
</div>

<!-- ===================== BREAKUP OVERLAY ===================== -->
<div class="breakup-overlay" id="breakup-overlay">
  <div style="font-size:56px;margin-bottom:12px" id="breakup-emoji">üíî</div>
  <div style="font-family:'Baloo 2',cursive;font-size:22px;color:white;font-weight:800;margin-bottom:8px" id="breakup-title">Things Got Complicated...</div>
  <div style="color:rgba(255,255,255,.75);font-size:13px;line-height:1.6;margin-bottom:16px" id="breakup-msg"></div>
  <div class="breakup-options" id="breakup-options"></div>
</div>

<!-- NPC-INITIATED TEXT POPUP -->
<div class="npc-text-popup" id="npc-text-popup">
  <div class="npc-text-avatar" id="npc-text-avatar"></div>
  <div class="npc-text-content">
    <div class="npc-text-name" id="npc-text-name"></div>
    <div class="npc-text-msg" id="npc-text-msg"></div>
  </div>
  <button class="npc-text-close" onclick="dismissNpcText()">‚úï</button>
</div>

</div><!-- end #app -->

<script>
// ============================================================
// GAME DATA & STATE
// ============================================================
const G = {
  player: { name:'', avatar:0, trait:'funny', level:1, xp:0, skillPoints:3, lang:'english' },
  gameStarted: false,
  stats: { charm:50, money:60, confidence:40, intelligence:35 },
  wallet: 3000,
  day: 1,
  timeOfDay: 'morning', // morning, afternoon, evening, night
  energy: 5,
  maxEnergy: 5,
  visitsToday: 0,
  relationships: {},
  inventory: [],
  skills: {},
  achievements: {},
  messages: {},
  completedLocations: new Set(),
  currentNPC: null,
  dialogueStep: 0,
  typingTimeout: null,
  rivalActive: false,
  datePlans: {},
  lastSave: null,
  endings: {}, // npcId -> ending type unlocked
  sceneHistory: {}, // npcId -> array of {step, dialogueText, choiceText, choiceType}
  whatIfMode: false,
  whatIfSnapshot: null, // saved state for what-if rollback
  consequences: {}, // cross-NPC choice tracking
  // v4 NEW
  anniversaries: {}, // npcId -> {firstMet: day, firstDate: day}
  milestones: {}, // npcId -> {firstLaugh:bool, firstFight:bool, firstApology:bool, metFamily:bool}
  jealousyLevel: {}, // npcId -> 0-100
  activeMinigame: null, // 'rhythm'|'cookoff'|'photo'|'debate'|'chess'
  familyVisits: {}, // npcId -> {[memberId]: attitude}
};

// ============================================================
// NPC DATA
// ============================================================
const NPCS = {
  chiamaka: {
    id:'chiamaka', name:'Chiamaka', age:24,
    location:'Buka Restaurant', job:'Nurse üè•',
    interests:['Reading üìö','Gospel Music üéµ','Cooking üç≤'],
    personality:'Gentle, smart, family-oriented',
    mood:'üòä', favGift:'flowers',
    skinTone:'#A0522D', clothColor:'#9B59B6', headwrapColor:'#E91E63',
    rival: { name:'Emeka', desc:'Emeka is also trying to talk to Chiamaka today. He brought suya...' },
    memories: [],
    dialogue: {
      english: [
        { text:"Good afternoon! Can I help you? You look a little lost...", choices:[
          { text:"I'm not lost ‚Äî I was looking for you üòä", type:'good', cd:8, st:1, lesson:"Confidence with warmth opens doors." },
          { text:"Yeah, I'm new here. Can you recommend something?", type:'neutral', cd:4, st:1, lesson:"Being genuine works too." },
          { text:"Mind your business!", type:'bad', cd:-12, st:'fail', lesson:"Rudeness never wins." },
        ]},
        { text:"Haha! Smooth talker! I'm Chiamaka. I come here every Saturday. What's your name?", choices:[
          { text:"Tell her your name and ask about her week", type:'good', cd:8, st:2, lesson:"Reciprocating shows genuine interest." },
          { text:"Just say your name", type:'neutral', cd:3, st:2, lesson:"Simple but works." },
          { text:"Ask for her number immediately", type:'bad', cd:-8, st:'tooFast', lesson:"Too soon! Build connection first." },
        ]},
        { text:"Oh wow, you're really easy to talk to! My shift ends at 5, I was going to the market after...", choices:[
          { text:"Offer to walk with her to the market", type:'good', cd:10, st:'minigame', lesson:"Taking initiative shows interest." },
          { text:"Say that sounds nice and wish her well", type:'neutral', cd:5, st:3, lesson:"Polite, but a missed opportunity." },
          { text:"Ask if she has a boyfriend first", type:'bad', cd:-5, st:3, lesson:"That question too early creates pressure." },
        ]},
        { text:"I really enjoyed today. You're different from the guys who usually approach me.", choices:[
          { text:"I'd love to know you better. Can we exchange numbers?", type:'good', cd:15, st:'success', lesson:"Clear, respectful intention." },
          { text:"Thank her and say you hope to see her again", type:'neutral', cd:8, st:'success', lesson:"Leaving things open is also fine." },
        ]},
      ],
      pidgin: [
        { text:"Good afternoon! How far? You dey find something?", choices:[
          { text:"I dey find you nah! üòä", type:'pidgin', cd:10, st:1, lesson:"Pidgin adds warmth and personality." },
          { text:"Abeg help me, I no sabi this place well", type:'neutral', cd:4, st:1, lesson:"Honesty dey work." },
          { text:"Comot for road!", type:'bad', cd:-12, st:'fail', lesson:"Disrespect no go take you anywhere." },
        ]},
        { text:"Haha! You dey do me shakara! I be Chiamaka. I dey come here every Saturday. Wetin be your name?", choices:[
          { text:"Tell am your name and ask how her week be", type:'good', cd:8, st:2, lesson:"Show interest, e dey matter." },
          { text:"Just tell am your name", type:'neutral', cd:3, st:2 },
          { text:"Abeg give me your number first", type:'bad', cd:-8, st:'tooFast', lesson:"Too fast! Make connection first." },
        ]},
        { text:"Chai! You too dey talk sweet! My shift go end 5 o'clock, I wan go market after...", choices:[
          { text:"I go follow you na, make sure you dey safe", type:'good', cd:12, st:'minigame', lesson:"Showing care na power move." },
          { text:"Okay o, greet market for me", type:'neutral', cd:4, st:3 },
          { text:"You get boyfriend?", type:'bad', cd:-5, st:3, lesson:"That question too quick." },
        ]},
        { text:"Chai, I enjoy today wella. You different from those other guys wey dey approach me.", choices:[
          { text:"I wan know you well well. We fit exchange number?", type:'pidgin', cd:15, st:'success', lesson:"Clear intention with respect." },
          { text:"E dey nice meeting you, I hope to see you again", type:'neutral', cd:8, st:'success' },
        ]},
      ],
    },
    minigame: {
      title:"Market Walk ‚ù§Ô∏è", timer:12,
      sub:"She mentions she loves gospel music. What do you say?",
      options:[
        {emoji:'üéµ',text:'Ask her favorite artist and genuinely share yours',correct:true},
        {emoji:'üòè',text:'Brag that you can sing for her tonight',correct:false},
        {emoji:'üì±',text:'Google "gospel music" to impress her',correct:false},
        {emoji:'ü§ù',text:'Admit you\'re not expert but want to learn',correct:true},
      ]
    },
    phoneConvo: [
      { from:'npc', text:"Hi! It's Chiamaka üòä I'm glad we exchanged numbers." },
      { from:'player', replies:[
        { text:"Me too! I've been thinking about you.", boost:8 },
        { text:"Same! How was your day at the hospital?", boost:12 },
        { text:"Yeah... cool.", boost:2 },
      ]},
      { from:'npc', text:"Today was long but rewarding. One patient called me his 'sunshine' üòÇ" },
      { from:'player', replies:[
        { text:"You're my sunshine too üåû", boost:10 },
        { text:"That's beautiful! You must be amazing at your job.", boost:15 },
        { text:"Aww... nice I guess.", boost:3 },
      ]},
      { from:'npc', text:"Haha stop it! But seriously... would you want to come to church with me Sunday?" },
      { from:'player', replies:[
        { text:"I'd love that. What time? üôè", boost:18 },
        { text:"I'll try to make it work!", boost:10 },
        { text:"Maybe... I'll see.", boost:2 },
      ]},
    ],
    trivia: { q:"What does 'Nne' mean in Igbo?", opts:["Sister","Mother/Dear","Friend","Wife"], correct:1 },
  },

  amaka: {
    id:'amaka', name:'Amaka', age:22,
    location:'University Campus', job:'Law Student ‚öñÔ∏è',
    interests:['Debate üó£Ô∏è','Afrobeats üé∂','Fashion üëó'],
    personality:'Confident, witty, direct',
    mood:'üò§', favGift:'perfume',
    skinTone:'#6B3A2A', clothColor:'#E91E63', headwrapColor:'#FFD700',
    rival:{ name:'Dayo', desc:'Dayo is charming and also pursuing Amaka. He just got a new car...' },
    memories:[],
    dialogue: {
      english:[
        { text:"Excuse me, you just bumped into my books! Do you always walk around like you own the place?", choices:[
          { text:"I'm so sorry! Let me help pick those up.", type:'good', cd:8, st:1, lesson:"Owning a mistake shows character." },
          { text:"My bad. You okay?", type:'neutral', cd:4, st:1 },
          { text:"Why were your books in the way?", type:'bad', cd:-12, st:'fail', lesson:"Defensiveness kills attraction." },
        ]},
        { text:"Hmm, a gentleman. Rare these days. I'm Amaka, 200 level Law.", choices:[
          { text:"No, I'm here to improve myself ‚Äî just like you", type:'good', cd:10, st:2, lesson:"Matching her ambition energy works." },
          { text:"I have my reasons for being here...", type:'neutral', cd:5, st:2 },
          { text:"What if I am? Problem?", type:'bad', cd:-6, st:2 },
        ]},
        { text:"I'm on my way to debate practice. Can you hold a real conversation?", choices:[
          { text:"Challenge accepted. What's the topic?", type:'good', cd:12, st:'minigame', lesson:"Confidence attracts confidence." },
          { text:"I try my best! What's your debate about?", type:'neutral', cd:6, st:3 },
          { text:"I don't really do debates...", type:'bad', cd:-4, st:3 },
        ]},
        { text:"You know what? You're actually interesting. Most guys get intimidated by me. Coffee sometime?", choices:[
          { text:"I'd love that. Here's my number, text me.", type:'good', cd:15, st:'success' },
          { text:"Sure! When works for you?", type:'good', cd:12, st:'success' },
        ]},
      ],
      pidgin:[
        { text:"Oga! You just scatter my books! You blind?", choices:[
          { text:"Ah, sorry sorry! Make I help you pick dem.", type:'good', cd:8, st:1, lesson:"Apologize quickly, e show maturity." },
          { text:"My mistake. You dey okay?", type:'neutral', cd:4, st:1 },
          { text:"Why you put your books there?", type:'bad', cd:-12, st:'fail' },
        ]},
        { text:"Hmm. You get sense small. I be Amaka, Law 200 level.", choices:[
          { text:"I sabi. I too dey hustle to better myself, like you.", type:'good', cd:10, st:2 },
          { text:"I get my reasons for dey here...", type:'neutral', cd:5, st:2 },
          { text:"Wetin concern you?", type:'bad', cd:-6, st:2 },
        ]},
        { text:"I dey go debate practice. You sabi talk talk?", choices:[
          { text:"Try me nah! Wetin be the topic?", type:'pidgin', cd:13, st:'minigame' },
          { text:"I dey try. Wetin una go debate?", type:'neutral', cd:6, st:3 },
          { text:"Debate no be my thing...", type:'bad', cd:-4, st:3 },
        ]},
        { text:"You actually interesting sha. Most guys dey fear me. We go drink coffee?", choices:[
          { text:"I no go fear you. Here my number.", type:'pidgin', cd:15, st:'success' },
          { text:"Any time! When you free?", type:'good', cd:12, st:'success' },
        ]},
      ],
    },
    minigame:{
      title:"Debate Round üó£Ô∏è", timer:10,
      sub:"She asks your view on relationships. Best response?",
      options:[
        {emoji:'ü§ù',text:'Express genuine values about respect and partnership',correct:true},
        {emoji:'üòé',text:'Brag about your past relationships',correct:false},
        {emoji:'üôä',text:'Say "whatever she wants to hear"',correct:false},
        {emoji:'üí≠',text:'Ask her view first, then share yours thoughtfully',correct:true},
      ]
    },
    phoneConvo:[
      { from:'npc', text:"It's Amaka. You actually remembered to text first. Impressive." },
      { from:'player', replies:[
        { text:"Of course. A man of his word üòé", boost:10 },
        { text:"I said I would! How was debate practice?", boost:14 },
        { text:"Yeah, I was in the area...", boost:2 },
      ]},
      { from:'npc', text:"We won! I argued the side I personally disagree with. That's the real test." },
      { from:'player', replies:[
        { text:"That takes real intelligence. I'm impressed.", boost:15 },
        { text:"I could never do that. You're built different.", boost:12 },
        { text:"Cool. Which side?", boost:3 },
      ]},
      { from:'npc', text:"What do you actually want from this, by the way? Be honest." },
      { from:'player', replies:[
        { text:"Something real. I don't do games.", boost:18 },
        { text:"To know you better ‚Äî you fascinate me.", boost:16 },
        { text:"Just vibing for now...", boost:1 },
      ]},
    ],
    trivia:{ q:"Which city is Nigeria's commercial capital?", opts:["Abuja","Lagos","Kano","Port Harcourt"], correct:1 },
  },

  ngozi: {
    id:'ngozi', name:'Ngozi', age:27,
    location:'Tech Hub', job:'Software Developer üíª',
    interests:['Coding üíª','Chess ‚ôüÔ∏è','Jollof Rice üçö'],
    personality:'Analytical, ambitious, independent',
    mood:'ü§î', favGift:'book',
    skinTone:'#8B4513', clothColor:'#2196F3', headwrapColor:'#FF9800',
    rival:{ name:'Tunde', desc:'Tunde works at the same tech company as Ngozi and is very smooth...' },
    memories:[],
    dialogue:{
      english:[
        { text:"Oh, are you here for the tech meetup? I'm actually the speaker today.", choices:[
          { text:"Wow, I'd love to hear your talk! What's the topic?", type:'good', cd:10, st:1, lesson:"Genuine curiosity is magnetic." },
          { text:"Cool. Yeah, I'm here for the meetup.", type:'neutral', cd:4, st:1 },
          { text:"You? The speaker? Interesting.", type:'bad', cd:-10, st:'fail', lesson:"Doubt and surprise about women in tech is harmful." },
        ]},
        { text:"Women in tech in Nigeria ‚Äî it's a passion project. What do you do?", choices:[
          { text:"Share genuinely and show interest in her mission", type:'good', cd:10, st:2, lesson:"Showing you stand for something attracts her." },
          { text:"Tell her what you do", type:'neutral', cd:4, st:2 },
          { text:"Pivot ‚Äî 'Let's talk about you instead'", type:'bad', cd:-5, st:2 },
        ]},
        { text:"Refreshing to meet someone who engages with ideas! Coffee after my talk?", choices:[
          { text:"Absolutely! I'll wait for you.", type:'good', cd:12, st:'minigame', lesson:"Patience and commitment show character." },
          { text:"Sure! Should I grab you one now?", type:'good', cd:10, st:'minigame' },
          { text:"Depends on how long the talk is...", type:'bad', cd:-8, st:3 },
        ]},
        { text:"You waited! I like that. What are you actually looking for?", choices:[
          { text:"Something genuine. I take relationships seriously.", type:'good', cd:15, st:'success' },
          { text:"Just seeing where things go for now", type:'neutral', cd:6, st:'success' },
        ]},
      ],
      pidgin:[
        { text:"Ehen, you come for the tech meetup? I be the one wey go talk today.", choices:[
          { text:"For real? Omo, wetin you go talk about?", type:'pidgin', cd:10, st:1 },
          { text:"Yeah I dey here for the meetup.", type:'neutral', cd:4, st:1 },
          { text:"You? Oya talk!", type:'bad', cd:-10, st:'fail' },
        ]},
        { text:"Women in tech for Naija ‚Äî e be my passion. Wetin you do?", choices:[
          { text:"Share your work and show say you care about her mission", type:'good', cd:10, st:2 },
          { text:"Tell am wetin you do", type:'neutral', cd:4, st:2 },
          { text:"Forget that ‚Äî tell me more about you", type:'bad', cd:-5, st:2 },
        ]},
        { text:"Chai, I dey enjoy this talk! Make we drink coffee after my presentation?", choices:[
          { text:"I go wait for you. Take your time.", type:'good', cd:12, st:'minigame' },
          { text:"Yes! I go order your cup now?", type:'good', cd:10, st:'minigame' },
          { text:"How long your talk go take?", type:'bad', cd:-8, st:3 },
        ]},
        { text:"You wait o! I like that. Wetin you really want from this?", choices:[
          { text:"Something real. I no dey do games.", type:'pidgin', cd:15, st:'success' },
          { text:"I dey see where things go", type:'neutral', cd:6, st:'success' },
        ]},
      ],
    },
    minigame:{
      title:"Coffee Chat ‚òï", timer:11,
      sub:"She asks if you support women in leadership. Best response?",
      options:[
        {emoji:'‚úä',text:'Give a real, specific answer showing genuine thought',correct:true},
        {emoji:'üòÖ',text:'"Of course! I love women."',correct:false},
        {emoji:'ü§î',text:'Ask what inspired her ‚Äî then share your view',correct:true},
        {emoji:'üìä',text:'Recite random statistics to sound smart',correct:false},
      ]
    },
    phoneConvo:[
      { from:'npc', text:"Hey! Ngozi here. I've been thinking about our conversation." },
      { from:'player', replies:[
        { text:"Same! You left quite an impression.", boost:10 },
        { text:"Me too. You're really inspiring.", boost:14 },
        { text:"What about it?", boost:2 },
      ]},
      { from:'npc', text:"I'm building an app for Nigerian women entrepreneurs. It's going to be huge." },
      { from:'player', replies:[
        { text:"That's incredible! How can I support?", boost:16 },
        { text:"Tell me everything. What's the concept?", boost:18 },
        { text:"Nice. Hope it works out.", boost:3 },
      ]},
      { from:'npc', text:"I need beta testers. Would you be interested? I also... want to see you again.", remarks:'üòä' },
      { from:'player', replies:[
        { text:"Both ‚Äî absolutely. When and where?", boost:20 },
        { text:"Of course! Send me the details.", boost:15 },
        { text:"Sure, just send a link.", boost:5 },
      ]},
    ],
    trivia:{ q:"What does 'Jollof' refer to in West African cuisine?", opts:["A cooking method","A spiced rice dish","A type of fish stew","A dessert"], correct:1 },
  },

  titi: {
    id:'titi', name:'Titilayo', age:25,
    location:'Church Compound', job:'Fashion Designer üëó',
    interests:['Fashion üßµ','Prayer üôè','Dancing üíÉ'],
    personality:'Warm, creative, family-values',
    mood:'üòá', favGift:'flowers',
    skinTone:'#C68642', clothColor:'#4CAF50', headwrapColor:'#FF5722',
    rival:{ name:'Pastor Segun', desc:'Pastor Segun\'s son has been admiring Titilayo and her parents approve of him...' },
    memories:[],
    dialogue:{
      english:[
        { text:"Hello! I haven't seen you here before. Are you new to this area?", choices:[
          { text:"Yes! Just moved nearby. It's a beautiful community.", type:'good', cd:8, st:1, lesson:"Positivity and openness invite connection." },
          { text:"Sort of. I came with a friend.", type:'neutral', cd:4, st:1 },
          { text:"I come whenever I feel like it.", type:'bad', cd:-6, st:1 },
        ]},
        { text:"How lovely! I'm Titilayo ‚Äî I make all the choir robes here! Small business but I love it.", choices:[
          { text:"That's amazing! Entrepreneurship and creativity ‚Äî I respect that.", type:'good', cd:10, st:2, lesson:"Celebrating her work shows respect." },
          { text:"Oh nice, so you sew?", type:'neutral', cd:3, st:2 },
          { text:"Can you make me something?", type:'bad', cd:-5, st:2, lesson:"Don't make it about you so quickly." },
        ]},
        { text:"I want to grow it into a full atelier one day. My mama thinks I should find a husband first...", choices:[
          { text:"Your career ambition makes you even more attractive, honestly", type:'good', cd:12, st:'minigame', lesson:"Supporting her dreams is powerful." },
          { text:"What do YOU want?", type:'good', cd:10, st:'minigame', lesson:"Asking her own opinion empowers her." },
          { text:"Your mama has a point...", type:'bad', cd:-10, st:3, lesson:"Never dismiss her ambitions." },
        ]},
        { text:"Nobody ever asked me that! You know what... here's my number. Let's talk more.", choices:[
          { text:"Thank you, Titilayo. I'll reach out.", type:'good', cd:15, st:'success' },
          { text:"I'm saving it right now!", type:'good', cd:12, st:'success' },
        ]},
      ],
      pidgin:[
        { text:"Hello! I never see you here before. You be new person for here?", choices:[
          { text:"Yes! I just move come. E dey fine here sha.", type:'good', cd:8, st:1 },
          { text:"Hmm, I follow friend come.", type:'neutral', cd:4, st:1 },
          { text:"I dey come whenever I feel like.", type:'bad', cd:-6, st:1 },
        ]},
        { text:"Nice to meet you! I be Titilayo ‚Äî I sew all the choir clothes for this church! Small work but I love am.", choices:[
          { text:"Ehn! Entrepreneur and creative ‚Äî I hail you!", type:'pidgin', cd:11, st:2 },
          { text:"Oh, so you be tailor?", type:'neutral', cd:3, st:2 },
          { text:"You fit sew something for me?", type:'bad', cd:-5, st:2 },
        ]},
        { text:"I wan make am big one day. But my mama say make I find husband first...", choices:[
          { text:"Forget that! Your ambition make you fine pass any agbada!", type:'pidgin', cd:13, st:'minigame' },
          { text:"But wetin YOU want?", type:'good', cd:10, st:'minigame' },
          { text:"Your mama get point sha...", type:'bad', cd:-10, st:3 },
        ]},
        { text:"Nobody ever ask me that question! Oya, collect my number. Make we talk more.", choices:[
          { text:"I go call you tomorrow, I promise.", type:'good', cd:15, st:'success' },
          { text:"I don save am! üòä", type:'good', cd:12, st:'success' },
        ]},
      ],
    },
    minigame:{
      title:"Design Studio üé®", timer:12,
      sub:"She shows you her fabric designs. How do you react?",
      options:[
        {emoji:'üëÄ',text:'Ask about the design process and inspiration',correct:true},
        {emoji:'üò¨',text:'Say you prefer simpler, plainer styles',correct:false},
        {emoji:'üí∞',text:'Ask immediately how much she charges',correct:false},
        {emoji:'üåü',text:'Genuinely compliment the craftsmanship and color choices',correct:true},
      ]
    },
    phoneConvo:[
      { from:'npc', text:"Hello! It's Titi üòä Thank you for talking to me today. Not many people ask about my work." },
      { from:'player', replies:[
        { text:"Your work deserves to be celebrated.", boost:14 },
        { text:"Of course! You're talented. I can tell.", boost:12 },
        { text:"No problem at all.", boost:3 },
      ]},
      { from:'npc', text:"I'm working on a collection inspired by Aso-Oke patterns. Would you want to see it?" },
      { from:'player', replies:[
        { text:"I would love that! You're going to be famous one day.", boost:16 },
        { text:"Please! Send me photos or let's meet.", boost:18 },
        { text:"Sure, share pics.", boost:4 },
      ]},
      { from:'npc', text:"You're really sweet üå∏ My family would like you. That's not easy to say..." },
      { from:'player', replies:[
        { text:"That means everything to me, truly.", boost:20 },
        { text:"I hope to earn that honor properly.", boost:18 },
        { text:"Haha, they haven't met me yet!", boost:8 },
      ]},
    ],
    trivia:{ q:"What is 'Aso-Oke' in Yoruba culture?", opts:["A type of food","A traditional woven fabric","A wedding ceremony","A dance style"], correct:1 },
  },

  bisi: {
    id:'bisi', name:'Bisi', age:23,
    location:'Shoprite Mall', job:'Marketing Executive üìà',
    interests:['Photography üì∏','Suya üçñ','Afrobeats üéµ'],
    personality:'Outgoing, fun, social butterfly',
    mood:'ü§©', favGift:'jewelry',
    skinTone:'#7B4F2E', clothColor:'#FF5252', headwrapColor:'#00BCD4',
    rival:{ name:'DJ Kolade', desc:'DJ Kolade is famous locally and just invited Bisi to his show...' },
    memories:[],
    dialogue:{
      english:[
        { text:"OH MY GOD, they're playing Burna Boy in Shoprite?! This is literally my song!", choices:[
          { text:"Right?! Which album is your favorite?", type:'good', cd:10, st:1, lesson:"Matching her energy creates instant connection." },
          { text:"*smiles* You've got great taste.", type:'good', cd:8, st:1 },
          { text:"It's too loud in here honestly...", type:'bad', cd:-8, st:'fail', lesson:"Killing her joy kills your chances." },
        ]},
        { text:"You know Burna?? I'm OBSESSED. I'm Bisi! Sorry, I get excited.", choices:[
          { text:"Don't apologize ‚Äî passion is attractive!", type:'good', cd:10, st:2, lesson:"Validating her personality is key." },
          { text:"Ha, I can tell. I'm [name].", type:'neutral', cd:5, st:2 },
          { text:"A little bit yeah, but it's okay.", type:'bad', cd:-5, st:2 },
        ]},
        { text:"I'm shooting photos at Lekki Conservation tomorrow. I always go alone but...", choices:[
          { text:"I'd love to join if you're open to company!", type:'good', cd:12, st:'minigame', lesson:"Showing interest in her passion is huge." },
          { text:"Photography sounds cool!", type:'neutral', cd:5, st:3 },
          { text:"You go alone? Isn't that dangerous?", type:'bad', cd:-6, st:3, lesson:"Don't make her feel incapable." },
        ]},
        { text:"Come prepared ‚Äî comfortable shoes, 6am. You in?", choices:[
          { text:"Challenge accepted. Send me the location.", type:'good', cd:15, st:'success' },
          { text:"I'm already setting my alarm. Deal!", type:'good', cd:14, st:'success' },
        ]},
      ],
      pidgin:[
        { text:"MEHN! Shoprite dey play Burna Boy?! This na my song!", choices:[
          { text:"You know Burna? Which album you love pass?", type:'pidgin', cd:10, st:1 },
          { text:"*smile* Your taste dey mad.", type:'good', cd:8, st:1 },
          { text:"The music too loud sha...", type:'bad', cd:-8, st:'fail' },
        ]},
        { text:"You sabi Burna?! I dey mad for him! I be Bisi! Sorry I too dey hype.", choices:[
          { text:"No apologize! Passion na the thing I like most.", type:'good', cd:11, st:2 },
          { text:"Ha, I see. I be [name].", type:'neutral', cd:5, st:2 },
          { text:"Haha, small small.", type:'bad', cd:-5, st:2 },
        ]},
        { text:"I wan go snap photos for Lekki tomorrow morning. I dey always go alone but...", choices:[
          { text:"Make I follow you na! I dey free.", type:'pidgin', cd:13, st:'minigame' },
          { text:"Photography! E dey nice.", type:'neutral', cd:5, st:3 },
          { text:"You go alone? E no safe?", type:'bad', cd:-6, st:3 },
        ]},
        { text:"Wear comfy shoes, dey ready by 6am. You dey in?", choices:[
          { text:"I don ready! Send location.", type:'pidgin', cd:15, st:'success' },
          { text:"My alarm don set! E don do.", type:'good', cd:14, st:'success' },
        ]},
      ],
    },
    minigame:{
      title:"Playlist Battle üéµ", timer:10,
      sub:"She asks you to pick a song for a joint playlist. Best choice?",
      options:[
        {emoji:'üéµ',text:'Pick something she mentioned she loves',correct:true},
        {emoji:'üòé',text:'Play only your music to show off your taste',correct:false},
        {emoji:'üéß',text:'Ask what mood she\'s in, then decide together',correct:true},
        {emoji:'üì±',text:'Let Spotify shuffle decide',correct:false},
      ]
    },
    phoneConvo:[
      { from:'npc', text:"Bisi here üì∏ Still thinking about our conversation! Lagos needs more people like you." },
      { from:'player', replies:[
        { text:"Lagos needs more people like YOU üòÑ", boost:12 },
        { text:"That's the nicest thing! How's the photography going?", boost:14 },
        { text:"Haha thanks! Same.", boost:4 },
      ]},
      { from:'npc', text:"Just got back from Lekki! The sunrise was INSANE. Wish you were there." },
      { from:'player', replies:[
        { text:"Next time ‚Äî I'm coming. I mean it.", boost:16 },
        { text:"Show me the photos! I need to see this.", boost:18 },
        { text:"Sounds nice!", boost:4 },
      ]},
      { from:'npc', text:"There will be a next time? üòä I like that confidence." },
      { from:'player', replies:[
        { text:"Count on it. I don't say things I don't mean.", boost:20 },
        { text:"Of course! You're worth showing up for.", boost:18 },
        { text:"Yeah, maybe üòÇ", boost:6 },
      ]},
    ],
    trivia:{ q:"What is 'Suya'?", opts:["A Yoruba greeting","Spiced grilled meat on skewers","A type of fabric","A traditional dance"], correct:1 },
  },

  // ============================================================
  // SECRET 6TH NPC ‚Äî Adaeze (unlocked after completing 3 stories)
  // ============================================================
  adaeze: {
    id:'adaeze', name:'Adaeze', age:29, secret:true,
    location:'Art Gallery', job:'Artist & Gallery Curator üé®',
    interests:['Contemporary Art üñºÔ∏è','Philosophy üåø','Afrobeats üé∂'],
    personality:'Mysterious, deep, fiercely independent',
    mood:'üåø', favGift:'book',
    skinTone:'#7A3B1E', clothColor:'#6D28D9', headwrapColor:'#F59E0B',
    rival:{ name:'Seun', desc:'Seun is a successful artist also vying for Adaeze\'s attention.' },
    memories:[],
    dialogue:{
      english:[
        { text:"You're staring at my piece. Most people glance and move on. What do you actually see?", choices:[
          { text:"I see someone who felt something deeply when they made this.", type:'good', cd:12, st:1, lesson:"Perceiving the artist, not just the art, is rare." },
          { text:"Honestly, I'm still figuring it out.", type:'neutral', cd:6, st:1 },
          { text:"It's... interesting.", type:'bad', cd:-8, st:'fail', lesson:"Vague compliments offend real artists." },
        ]},
        { text:"That's... a real answer. I'm Adaeze. I created this collection after losing someone close. Art was all I had.", choices:[
          { text:"I'm sorry for your loss. Thank you for sharing that through your work.", type:'good', cd:14, st:2, lesson:"Honoring vulnerability creates true connection." },
          { text:"That's beautiful. Art as healing.", type:'good', cd:10, st:2 },
          { text:"Wow, rough. Which piece is the expensive one?", type:'bad', cd:-14, st:'fail', lesson:"Insensitivity destroys momentum instantly." },
        ]},
        { text:"Most men try to impress me with money or status. You haven't. Why?", choices:[
          { text:"Because you clearly care about what's real. So do I.", type:'good', cd:15, st:'minigame', lesson:"Mirroring genuine values is powerful." },
          { text:"I have other ways to impress people üòè", type:'bad', cd:-6, st:3, lesson:"Smugness repels authenticity." },
          { text:"I'm just being myself. Is that enough?", type:'neutral', cd:8, st:3 },
        ]},
        { text:"Come back Thursday. I'm installing a new collection. I'd value a second pair of honest eyes.", choices:[
          { text:"I'll be there. And I promise to actually look.", type:'good', cd:18, st:'success' },
          { text:"I wouldn't miss it.", type:'neutral', cd:10, st:'success' },
        ]},
      ],
      pidgin:[
        { text:"You dey look my work wella. Most people just dey glance pass. Wetin you see?", choices:[
          { text:"I see person wey feel something deep when e dey paint this.", type:'good', cd:12, st:1 },
          { text:"Honestly, I still dey process am.", type:'neutral', cd:6, st:1 },
          { text:"E dey interesting.", type:'bad', cd:-8, st:'fail' },
        ]},
        { text:"That na real answer. I be Adaeze. I make this collection after I lose somebody wey close to me.", choices:[
          { text:"Sorry for your loss. Thank you say you share through your work.", type:'good', cd:14, st:2 },
          { text:"Na so art take heal person. I understand.", type:'good', cd:10, st:2 },
          { text:"Sorry o. Which one be the costly one?", type:'bad', cd:-14, st:'fail' },
        ]},
        { text:"Most men dey try impress me with money. You neva do that. Why?", choices:[
          { text:"Because you care about wetin be real. Me sef.", type:'good', cd:15, st:'minigame' },
          { text:"I get other way to impress üòè", type:'bad', cd:-6, st:3 },
          { text:"I just dey myself. E reach?", type:'neutral', cd:8, st:3 },
        ]},
        { text:"Come Thursday. I dey install new collection. I need genuine eyes.", choices:[
          { text:"I go dey there. I promise to really look.", type:'good', cd:18, st:'success' },
          { text:"I no go miss am.", type:'neutral', cd:10, st:'success' },
        ]},
      ],
    },
    minigame:{
      title:"Gallery Discussion üé®", timer:12,
      sub:"She asks your philosophy on life. Best response?",
      options:[
        {emoji:'üåø',text:'Share something genuine you actually believe in',correct:true},
        {emoji:'üìö',text:'Quote Nietzsche to sound smart',correct:false},
        {emoji:'üí≠',text:'Ask her philosophy first and listen deeply',correct:true},
        {emoji:'üòé',text:'Say life is about enjoying the moment',correct:false},
      ]
    },
    phoneConvo:[
      { from:'npc', text:"Adaeze here. Thursday is confirmed. Bring your honest eyes and nothing else." },
      { from:'player', replies:[
        { text:"Already thinking about what I'll observe üé®", boost:14 },
        { text:"Can't wait. What's the theme?", boost:18 },
        { text:"I'll be there!", boost:6 },
      ]},
      { from:'npc', text:"The theme is 'Belonging'. For obvious reasons." },
      { from:'player', replies:[
        { text:"I think belonging is built, not found. What do you think?", boost:20 },
        { text:"That's powerful. Very personal topic.", boost:14 },
        { text:"Deep.", boost:3 },
      ]},
      { from:'npc', text:"...I'm going to save that answer. See you Thursday." },
      { from:'player', replies:[
        { text:"I'll be there. And I'll bring more where that came from.", boost:18 },
        { text:"Looking forward to it üåø", boost:14 },
        { text:"Okay!", boost:2 },
      ]},
    ],
    trivia:{ q:"What is the largest art museum in West Africa?", opts:["National Museum Lagos","Smithsonian Abuja","Yemisi Shyllon Museum","Eko Gallery"], correct:2 },
  },
};

// ============================================================
// V6: BACKSTORY CHAPTERS
// ============================================================
const NPC_BACKSTORIES = {
  chiamaka:{
    unlockAt:30,
    chapters:[
      { title:'Chapter 1: The Village Girl', text:'Chiamaka grew up in Anambra State, the third of seven children. Her mother was a market trader who woke at 4am every day. By age 12, Chiamaka was helping run the stall before school. She learned early that showing up and working hard is not optional ‚Äî it\'s identity.', unlockAt:0 },
      { title:'Chapter 2: Lagos Dreams', text:'At 18, she moved to Lagos with ‚Ç¶15,000 and a letter of recommendation from her church pastor. She slept on a cousin\'s couch for three months while training as a nurse. The hospital corridors taught her patience she would never have found in textbooks.', unlockAt:40 },
      { title:'Chapter 3: The Wound', text:'She was engaged at 24. He broke it off six weeks before the wedding, with a WhatsApp message. She went to work the next morning and cared for twelve patients. She never spoke of it to her coworkers. Only her journal knows.', unlockAt:65 },
      { title:'Chapter 4: Who She\'s Becoming', text:'Chiamaka doesn\'t dream of being rescued. She dreams of building something ‚Äî a small clinic, eventually, in her hometown. She wants a partner who has a direction of their own, not someone who needs her to provide his. She\'s wary of charm without depth.', unlockAt:85 },
    ],
    lore:[
      { id:'l_ch1', icon:'üìø', hint:'A rosary tied to her wrist ‚Äî she never removes it.', text:'Her late grandmother gave her this rosary the day she left for Lagos. "God goes where you go," Grandma said. She touches it before every difficult conversation.', foundAt:'chiamaka' },
      { id:'l_ch2', icon:'üìì', hint:'A worn notebook in her bag.', text:'This is her third journal. She fills pages with prayers, patient notes she shouldn\'t keep, and sometimes ‚Äî poetry about loneliness. She\'d be embarrassed if you asked to read it.', foundAt:'chiamaka' },
      { id:'l_ch3', icon:'üå∏', hint:'She flinches slightly when someone says "I promise."', text:'After the broken engagement, those two words lost their meaning for her. She doesn\'t realize she does it. She needs someone who shows, not just promises.', foundAt:'chiamaka' },
    ],
  },
  amaka:{
    unlockAt:30,
    chapters:[
      { title:'Chapter 1: Born Arguing', text:'Amaka was debating before she could fully spell. Growing up in Enugu, she would argue cases at the dinner table while her parents exchanged glances. Her father, a magistrate, saw law in her eyes from the start. She never needed convincing.', unlockAt:0 },
      { title:'Chapter 2: The Cost of Being Sharp', text:'Secondary school was lonely. She was too direct for most friendships. Girls thought she was proud; boys were intimidated. She learned to weaponize her intellect as protection. It worked. It also kept people away.', unlockAt:40 },
      { title:'Chapter 3: The One Exception', text:'There was a philosophy professor who treated her ideas with genuine respect ‚Äî not as a "smart woman" but simply as a thinker. For two years, she thought she might be in love with learning itself. She still isn\'t sure she was wrong.', unlockAt:65 },
      { title:'Chapter 4: What She Really Wants', text:'Amaka says she wants a debate partner. That\'s only half true. She wants someone who stays after winning an argument ‚Äî someone who chooses connection over being right. She\'s never found that. She\'s not sure she deserves it. That uncertainty is her real secret.', unlockAt:85 },
    ],
    lore:[
      { id:'l_am1', icon:'‚öñÔ∏è', hint:'She carries a small scales keychain.', text:'A gift from her father when she got into law school. "Justice starts with balance," he told her. She has never lost a mock trial. She has never told her father that.', foundAt:'amaka' },
      { id:'l_am2', icon:'üì±', hint:'She types fast and always re-reads before sending.', text:'She composed 14 drafts of a message to an ex she almost loved. She deleted all of them. She still has the draft folder. She opens it sometimes.', foundAt:'amaka' },
      { id:'l_am3', icon:'üíÉ', hint:'She dances alone in her room at night.', text:'Nobody knows. Amaka loves Afrobeats in a way she considers embarrassing for a serious person. She dances with her curtains closed, alone, and it is the only time she feels completely free.', foundAt:'amaka' },
    ],
  },
  ngozi:{
    unlockAt:30,
    chapters:[
      { title:'Chapter 1: First Code at 13', text:'Ngozi taught herself HTML from a library book in Abuja. By 15 she had built a website for her school\'s literary club. No teacher had taught her. That independence ‚Äî the ability to create from nothing ‚Äî became her religion.', unlockAt:0 },
      { title:'Chapter 2: The Valley', text:'She won a scholarship to study CS in the UK. Two years in, she came back. Not because she failed ‚Äî she was near the top of her class. She came back because she was tired of explaining where Nigeria is to people who write its narrative from the outside.', unlockAt:40 },
      { title:'Chapter 3: The Algorithm', text:'Ngozi once mapped out what an ideal partner would look like in a spreadsheet. She actually did this. Fourteen columns, weighted criteria. She deleted it after meeting someone who fit none of them and sparked something she didn\'t predict.', unlockAt:65 },
      { title:'Chapter 4: Controlled Chaos', text:'She appears structured. She is. But she has also memorized every lyric of every Fela Kuti album. She eats jollof at 2am in front of multiple screens. The chaos is deliberate. She trusts people who have chaos too, even if it\'s different from hers.', unlockAt:85 },
    ],
    lore:[
      { id:'l_ng1', icon:'üíª', hint:'Three monitors on her desk at the Tech Hub.', text:'Left screen: live server metrics. Center: code editor. Right: a chess game against a bot she has beaten 2,847 times. She keeps playing. She\'s trying to understand how it improves.', foundAt:'ngozi' },
      { id:'l_ng2', icon:'üìä', hint:'A deleted spreadsheet in her trash folder.', text:'The "Ideal Partner" spreadsheet. 14 columns. She hasn\'t actually deleted it permanently. She just moved it to a folder called "Deprecated Projects."', foundAt:'ngozi' },
      { id:'l_ng3', icon:'üéß', hint:'She\'s always listening to something.', text:'Fela Kuti when she\'s building. Burna Boy when she\'s debugging. Taylor Swift when she thinks nobody can tell. The playlist leaked once in a meeting. She has never mentioned it.', foundAt:'ngozi' },
    ],
  },
  titi:{
    unlockAt:30,
    chapters:[
      { title:'Chapter 1: The Preacher\'s Granddaughter', text:'Titi\'s grandfather was one of the first Pentecostal pastors in Southwest Nigeria. She grew up in the echo of her family\'s faith ‚Äî not inherited blindly, but tested against every question she ever asked. She has asked many.', unlockAt:0 },
      { title:'Chapter 2: Quiet Storms', text:'At university she led campus fellowship while privately wrestling with doubt. She never told her family. She prayed through it. She came out the other side with a faith that is hers ‚Äî chosen, not assigned. That distinction matters enormously to her.', unlockAt:40 },
      { title:'Chapter 3: The Service Year', text:'NYSC posted her to Borno State. She stayed an extra year. The orphanage there changed the architecture of her priorities entirely. She came back quieter. More deliberate. The church welcomed her back. She welcomed it differently.', unlockAt:65 },
      { title:'Chapter 4: The Standard', text:'Titi\'s standard is not perfection ‚Äî she would be the first to say so. Her standard is consistency of character under pressure. She watches how men treat waiters, talk about their mothers, handle disappointment. She has never once mentioned this to the men she\'s watching.', unlockAt:85 },
    ],
    lore:[
      { id:'l_ti1', icon:'üìñ', hint:'A Bible with handwritten margins.', text:'Every page annotated. The margins are as dense as the text. Some notes are in Yoruba, some in English, some in shorthand she invented. She loans it to nobody.', foundAt:'titi' },
      { id:'l_ti2', icon:'ü§≤', hint:'She volunteers every Saturday.', text:'Agape Orphanage, Surulere. She\'s been going for four years. She has never once mentioned it in conversation unless directly asked. She considers it private.', foundAt:'titi' },
      { id:'l_ti3', icon:'üåº', hint:'She grows herbs on her windowsill.', text:'Scent leaf, mint, aloe vera. She makes teas from them when stressed. The ritual is the point ‚Äî slow, intentional, medicinal. She gave a bundle once to someone sick on her street. She doesn\'t remember them. They remember her.', foundAt:'titi' },
    ],
  },
  bisi:{
    unlockAt:30,
    chapters:[
      { title:'Chapter 1: The Eye Behind the Lens', text:'Bisi\'s first camera was stolen from her older brother\'s bag when she was 10. She returned it a week later with 200 photos on the memory card. He showed their parents. They cried. They bought her her own.', unlockAt:0 },
      { title:'Chapter 2: The Instagram Deception', text:'She has 87,000 followers and hates talking about it. The account started as a hobby and became a brand. She now sometimes wonders if she photographs experiences to live them or to present them. The question unsettles her. She photographs anyway.', unlockAt:40 },
      { title:'Chapter 3: The Deleted Account', text:'She once deleted Instagram for three months. She went to Jos. She shot on film only ‚Äî 36 frames per roll. She cried developing the prints. She never posted any of them. They\'re in a box under her bed in Lagos.', unlockAt:65 },
      { title:'Chapter 4: What She\'s Looking For', text:'Bisi wants someone who can be fully present. She\'s surrounded by people who perform presence ‚Äî who look up from their phone but aren\'t actually there. One honest hour of real attention from one real person means more to her than months of curated connection.', unlockAt:85 },
    ],
    lore:[
      { id:'l_bi1', icon:'üì∑', hint:'She shoots with her phone in her left hand and film camera in her right.', text:'The film camera belonged to a photojournalist she met briefly at a Lagos festival. He left it with her accidentally. She\'s kept it. She told herself she\'d find him to return it. She\'s not sure that\'s true anymore.', foundAt:'bisi' },
      { id:'l_bi2', icon:'üñºÔ∏è', hint:'A box under her bed.', text:'The Jos prints. 36 frames of real life she never posted. Her most honest work. Shown to exactly two people. She considers this her real portfolio.', foundAt:'bisi' },
      { id:'l_bi3', icon:'üåÖ', hint:'She checks sunrise times every evening.', text:'She has been to 34 Lagos sunrises in the last year. Alone, mostly. She considers 6:12am her most productive creative hour. She\'d invite someone who could be quiet enough to deserve it.', foundAt:'bisi' },
    ],
  },
  adaeze:{
    unlockAt:50,
    chapters:[
      { title:'Chapter 1: The Outsider Inside', text:'Adaeze was born in Lagos to an Igbo father and a Yoruba mother, and belonged fully to neither community. She learned early that identity is something you build, not inherit. Art became her answer to every question she was never given.', unlockAt:0 },
      { title:'Chapter 2: The Loss', text:'At 25, she lost her younger brother to a road accident on the Lagos‚ÄìIbadan expressway. She did not paint for eight months. Then she painted every day for a year. The gallery exists because of what that year produced.', unlockAt:60 },
      { title:'Chapter 3: The Gallery', text:'She opened Orisun Gallery at 27 with a personal loan, no investors, and no safety net. Three collectors laughed at her pitch. The fourth one didn\'t. The opening night sold out. She cried in the bathroom for twenty minutes and then went back out.', unlockAt:80 },
      { title:'Chapter 4: The Secret She Keeps', text:'Adaeze is terrified of being truly known. The art is a proxy ‚Äî she speaks through it because speaking directly has cost her too much. The man who can read her paintings and still ask the right question about her, not the work, will be the one she keeps.', unlockAt:95 },
    ],
    lore:[
      { id:'l_ad1', icon:'üé®', hint:'One painting is always covered with a black cloth.', text:'The last painting from her year of grief. She has never shown it publicly. She shows it to no one. She sometimes sits in front of it alone for an hour. She says it\'s finished. Her hands say otherwise.', foundAt:'adaeze' },
      { id:'l_ad2', icon:'üåø', hint:'She keeps a small plant from her brother\'s grave.', text:'A cutting from the plant that grew where he was buried. She waters it every morning without fail. It\'s the first thing she does. It\'s the only ritual she has never broken.', foundAt:'adaeze' },
      { id:'l_ad3', icon:'üìú', hint:'Unsent letters pinned behind a large canvas.', text:'She writes to her brother. She tells him about the gallery, the sales, the people she meets. She tells him when she\'s afraid. She has never told anyone about the letters.', foundAt:'adaeze' },
    ],
  },
};

// ============================================================
// V6: INNER THOUGHTS (What She's Really Thinking)
// ============================================================
const INNER_THOUGHTS = {
  chiamaka:{
    good:["She\'s thinking: 'He actually listened. Most don\'t even try.'","She\'s thinking: 'Okay... he might be different. Don\'t get excited yet.'","She\'s thinking: 'This feels natural. I\'m not pretending anything.'"],
    bad:["She\'s thinking: 'Here we go. Another one who doesn\'t see me as a person.'","She\'s thinking: 'I\'ll give him one more chance. Just one.'"],
    neutral:["She\'s thinking: 'Not sure yet. Keep watching.'","She\'s thinking: 'He\'s trying. I can see it. Just not landing yet.'"],
  },
  amaka:{
    good:["She\'s thinking: 'He held his position without being defensive. That\'s rare.'","She\'s thinking: 'He engages me. Doesn\'t just agree. I like this.'"],
    bad:["She\'s thinking: 'Typical. She sharpens the point so the weak ones cut themselves on it.'","She\'s thinking: 'I\'m not cruel. I just have no patience for laziness.'"],
    neutral:["She\'s thinking: 'Hmm. Average. Maybe there\'s more under there. Jury\'s out.'"],
  },
  ngozi:{
    good:["She\'s thinking: 'He\'s curious without being performative. That\'s actually attractive.'","She\'s thinking: 'He asked a smart question. I did not predict that.'"],
    bad:["She\'s thinking: 'Flag. Processing. He just failed column 7 on the spreadsheet.'","She\'s thinking: 'Not worth more compute cycles. Move on.'"],
    neutral:["She\'s thinking: 'Insufficient data. Gathering more before forming conclusion.'"],
  },
  titi:{
    good:["She\'s thinking: 'He treats me like a complete person. Not just potential.'","She\'s thinking: 'He meant that. I can tell when things are meant.'"],
    bad:["She\'s thinking: 'Character doesn\'t lie. This told me something.'","She\'s thinking: 'Not unkind, just... not ready for what I need.'"],
    neutral:["She\'s thinking: 'I\'ll watch a little longer before deciding.'"],
  },
  bisi:{
    good:["She\'s thinking: 'He\'s actually here. Like, actually present. Do you know how rare that is?'","She\'s thinking: 'I want to photograph this moment. Not to post. Just to keep.'"],
    bad:["She\'s thinking: 'He\'s performing. I see it. I always see it.'","She\'s thinking: 'That\'s the kind of answer someone gives who\'s not listening.'"],
    neutral:["She\'s thinking: 'Medium. Might be shyness. Might be nothing. Both are fine.'"],
  },
  adaeze:{
    good:["She\'s thinking: 'He saw the painting. Not the price. Not the technique. The painting.'","She\'s thinking: 'I\'m going to have to be careful with this one. He\'s real.'"],
    bad:["She\'s thinking: 'He looked at the art the way people look at menus. I\'m closing the gallery early.'","She\'s thinking: 'I designed this conversation as a filter. He just failed it.'"],
    neutral:["She\'s thinking: 'Interesting. Unresolved. I\'ll give him room.'"],
  },
};

// ============================================================
// V6: NARRATOR COMMENTARY
// ============================================================
const NARRATOR_LINES = {
  chiamaka:[
    "üìç Lagos, Buka Restaurant ‚Äî where Tuesday afternoons taste like groundnut soup and second chances.",
    "In Igbo tradition, how a man greets a woman reveals the house he grew up in. She is watching.",
    "The Buka is her sanctuary. You are a guest. Remember that.",
  ],
  amaka:[
    "üìç University of Lagos Campus ‚Äî where argument is currency and weakness is expensive.",
    "Nigerian law students are trained to find the flaw in every position. Including yours.",
    "She will not be impressed by your knowledge. She will be impressed by what you do with doubt.",
  ],
  ngozi:[
    "üìç Lagos Tech Hub, Yaba ‚Äî where startups are born and two-thirds die before their first pitch.",
    "She has read the research on first impressions. She is applying it to you right now.",
    "In Igbo, 'Ngozi' means blessing. She considers this ironic. You should not say that.",
  ],
  titi:[
    "üìç Redeemed Christian Church of God, Surulere ‚Äî where faith is tested and character is revealed.",
    "She notices how men treat people they have no reason to impress. She is watching those moments.",
    "Her standard is not perfection. Her standard is someone who tries the same whether or not she\'s watching.",
  ],
  bisi:[
    "üìç Palms Mall, Lekki ‚Äî where Lagos performs itself for itself.",
    "She has photographed 34 Lagos sunrises. Each one, alone. She measures presence in quality, not quantity.",
    "She will not remember what you said. She will remember whether you were fully there.",
  ],
  adaeze:[
    "üìç Orisun Gallery, Victoria Island ‚Äî built by grief and lit by borrowed time.",
    "The Igbo word 'Ada' means firstborn daughter. She carries the full weight of that prefix.",
    "She built this space for honest looking. If you flinch from what is real, she will know.",
  ],
};

// ============================================================
// V6: CROSSOVER SCENES
// ============================================================
const CROSSOVER_SCENES = [
  {
    id:'amaka_ngozi', trigger:{npc1:'amaka',npc2:'ngozi',minInterest:40},
    title:'Two Forces Meet üí•', emoji:'‚ö°',
    text:'You run into Amaka and Ngozi at the same event ‚Äî a Women in Tech panel where Amaka is a panelist. They clearly know each other. The tension is intellectual and respectful. They both look at you simultaneously.',
    choices:[
      { text:'Compliment them both on their work ‚Äî specifically and sincerely', boost:{amaka:10,ngozi:10}, toast:'Both impressed! +10 each' },
      { text:'Engage with the panel topic directly, no flattery', boost:{amaka:14,ngozi:8}, toast:'Amaka especially impressed!' },
      { text:'Try to make a joke to lighten the room', boost:{amaka:-5,ngozi:5}, toast:'Mixed results...' },
    ]
  },
  {
    id:'chiamaka_titi', trigger:{npc1:'chiamaka',npc2:'titi',minInterest:35},
    title:'Sunday After Church üåø', emoji:'‚õ™',
    text:'You see Chiamaka and Titi together outside church ‚Äî turns out they are childhood friends from the same village. They\'re laughing about something. They spot you and both go quiet in that way that means they were discussing you.',
    choices:[
      { text:'Greet them both warmly and honestly ‚Äî "Whatever you said, I hope it was true."', boost:{chiamaka:12,titi:12}, toast:'They laugh ‚Äî both charmed!' },
      { text:'Ask what they were talking about directly', boost:{chiamaka:8,titi:6}, toast:'Points for boldness!' },
      { text:'Panic and pretend you didn\'t see them', boost:{chiamaka:-8,titi:-8}, toast:'They both noticed. Both disappointed.' },
    ]
  },
  {
    id:'bisi_adaeze', trigger:{npc1:'bisi',npc2:'adaeze',minInterest:45},
    title:'Art + Lens üì∑', emoji:'üé®',
    text:'Bisi is photographing pieces at Adaeze\'s gallery. You arrive to find them in the middle of a fascinating debate about whether a photograph can ever capture what a painting holds. They want your opinion.',
    choices:[
      { text:'"A photo captures a moment. A painting captures a feeling. Both matter."', boost:{bisi:14,adaeze:16}, toast:'They both go quiet. That landed.' },
      { text:'"Photography is more honest ‚Äî no interpretation, just truth."', boost:{bisi:18,adaeze:-4}, toast:'Bisi loves it; Adaeze disagrees.' },
      { text:'"I don\'t know enough to say. I\'d rather learn from you both."', boost:{bisi:8,adaeze:10}, toast:'Humble. Both appreciate it.' },
    ]
  },
];

const LOCATIONS = [
  { id:'chiamaka', label:'Buka Restaurant', emoji:'üç≤', color:'#FF5722', x:'18%', y:'32%', availableTimes:['afternoon','evening'], timeLabel:'Open: Afternoon‚ÄìEve' },
  { id:'amaka',    label:'Uni Campus',       emoji:'üéì', color:'#9C27B0', x:'62%', y:'18%', availableTimes:['morning','afternoon'], timeLabel:'Open: Morning‚ÄìAfternoon' },
  { id:'ngozi',    label:'Tech Hub',         emoji:'üíª', color:'#2196F3', x:'72%', y:'52%', availableTimes:['afternoon','evening','night'], timeLabel:'Open: Afternoon‚ÄìNight' },
  { id:'titi',     label:'Church',           emoji:'‚õ™', color:'#4CAF50', x:'28%', y:'63%', availableTimes:['morning','afternoon'], timeLabel:'Open: Morning‚ÄìAfternoon' },
  { id:'bisi',     label:'Mall',             emoji:'üõçÔ∏è', color:'#E91E63', x:'52%', y:'78%', availableTimes:['afternoon','evening'], timeLabel:'Open: Afternoon‚ÄìEve' },
  { id:'adaeze',   label:'Art Gallery',      emoji:'üñºÔ∏è', color:'#6D28D9', x:'38%', y:'48%', availableTimes:['morning','afternoon','evening'], timeLabel:'Secret NPC', secret:true },
];

const SCENE_BGS = {
  chiamaka:'linear-gradient(180deg,#87CEEB 0%,#DEB887 55%,#8B6914 100%)',
  amaka:'linear-gradient(180deg,#87CEEB 0%,#90EE90 55%,#228B22 100%)',
  ngozi:'linear-gradient(180deg,#1a1a2e 0%,#16213e 55%,#0a0a1a 100%)',
  titi:'linear-gradient(180deg,#87CEEB 0%,#F5DEB3 55%,#8B6914 100%)',
  bisi:'linear-gradient(180deg,#FFB6C1 0%,#DDA0DD 55%,#9370DB 100%)',
  adaeze:'linear-gradient(180deg,#2d1b69 0%,#1a0a3a 55%,#0a0518 100%)',
};

const GIFTS = [
  { id:'flowers', emoji:'üíê', name:'Flowers', price:200, boost:12, likes:['chiamaka','titi'] },
  { id:'chocolate', emoji:'üç´', name:'Chocolate', price:300, boost:10, likes:['bisi','chiamaka'] },
  { id:'perfume', emoji:'üß¥', name:'Perfume', price:800, boost:18, likes:['amaka','bisi'] },
  { id:'jewelry', emoji:'üíç', name:'Bracelet', price:1500, boost:25, likes:['bisi','titi'] },
  { id:'book', emoji:'üìö', name:'Book', price:400, boost:20, likes:['ngozi','amaka'] },
  { id:'suya', emoji:'üçñ', name:'Suya Pack', price:150, boost:14, likes:['bisi','chiamaka'] },
];

const ACTIVITIES = [
  { id:'gym', emoji:'üèãÔ∏è', name:'Hit the Gym', desc:'+15 Confidence', effect:{confidence:15}, cost:0, time:'1 Day' },
  { id:'read', emoji:'üìñ', name:'Read a Book', desc:'+15 Intelligence', effect:{intelligence:15}, cost:0, time:'1 Day' },
  { id:'styling', emoji:'üëî', name:'Style Consultation', desc:'+20 Charm', effect:{charm:20}, cost:500, time:'Same Day' },
  { id:'work', emoji:'üíº', name:'Side Hustle', desc:'+500 Naira', effect:{wallet:500}, cost:0, time:'1 Day' },
  { id:'cook', emoji:'üç≥', name:'Take Cooking Class', desc:'+10 Charm, +10 Intelligence', effect:{charm:10,intelligence:10}, cost:300, time:'1 Day' },
  { id:'pray', emoji:'üôè', name:'Morning Devotion', desc:'+8 all stats', effect:{charm:8,confidence:8}, cost:0, time:'Free' },
];

const SKILLS_TREE = [
  { id:'smooth_talker', name:'Smooth Talker', icon:'üó£Ô∏è', desc:'Unlocks extra dialogue options', cost:2, requires:null, category:'Social' },
  { id:'active_listener', name:'Active Listener', icon:'üëÇ', desc:'Charm boost +15 on all good choices', cost:2, requires:null, category:'Social' },
  { id:'fashion_sense', name:'Fashion Sense', icon:'üëî', desc:'All interactions start with +10 Interest', cost:3, requires:'smooth_talker', category:'Social' },
  { id:'comedian', name:'Natural Comedian', icon:'üòÇ', desc:'Funny choices get double charm boost', cost:2, requires:null, category:'Personality' },
  { id:'gentleman', name:'True Gentleman', icon:'üé©', desc:'Apology choices always work perfectly', cost:2, requires:'active_listener', category:'Personality' },
  { id:'ambitious', name:'Visibly Ambitious', icon:'üöÄ', desc:'Boost interest with career-focused girls', cost:3, requires:'gentleman', category:'Personality' },
  { id:'gift_giver', name:'Gift Master', icon:'üéÅ', desc:'Gifts give 50% more interest boost', cost:2, requires:null, category:'Resources' },
  { id:'negotiator', name:'Negotiator', icon:'üí∞', desc:'Shop prices 20% cheaper', cost:2, requires:'gift_giver', category:'Resources' },
  { id:'hustler', name:'Hustler', icon:'üíº', desc:'Work earns double money', cost:3, requires:'negotiator', category:'Resources' },
];

const ACHIEVEMENTS_DEF = [
  { id:'first_hello', badge:'üëã', title:'First Hello', desc:'Meet your first NPC', trigger:'meet_1' },
  { id:'smooth_criminal', badge:'üòé', title:'Smooth Criminal', desc:'Get 5 good choices in a row', trigger:'good_streak_5' },
  { id:'collector', badge:'üíê', title:'Gift Giver', desc:'Buy 3 gifts', trigger:'buy_3_gifts' },
  { id:'level5', badge:'‚≠ê', title:'Rising Star', desc:'Reach Level 5', trigger:'level_5' },
  { id:'all_met', badge:'ü§ù', title:'Social Butterfly', desc:'Meet all 5 characters', trigger:'meet_all' },
  { id:'first_number', badge:'üì±', title:'Digits!', desc:'Get a phone number', trigger:'first_number' },
  { id:'skilled', badge:'‚ö°', title:'Skill Master', desc:'Unlock 5 skills', trigger:'unlock_5_skills' },
  { id:'trivia_ace', badge:'üß†', title:'Naija Genius', desc:'Answer 3 trivia correctly', trigger:'trivia_3' },
  { id:'pidgin_pro', badge:'üá≥üá¨', title:'Pidgin Pro', desc:'Complete a full convo in Pidgin', trigger:'pidgin_complete' },
  { id:'date_master', badge:'üíï', title:'Date Master', desc:'Plan a perfect date', trigger:'perfect_date' },
  { id:'rich', badge:'üí∞', title:'Big Boy', desc:'Have 5000 naira', trigger:'wallet_5000' },
  { id:'partner', badge:'‚ù§Ô∏è', title:'Naija Lover', desc:'Reach Partner status with someone', trigger:'partner_status' },
  { id:'all_dates', badge:'üåπ', title:'Romantic', desc:'Date all 5 characters', trigger:'date_all' },
  { id:'loyal', badge:'üîí', title:'Loyal Heart', desc:'Reject rival 3 times', trigger:'reject_rival_3' },
  { id:'century', badge:'üíØ', title:'Charm King', desc:'Max charm to 100', trigger:'charm_100' },
  { id:'ending_romance', badge:'üíç', title:'Happily Ever After', desc:'Unlock the Romance ending', trigger:'ending_romance' },
  { id:'ending_marriage', badge:'üíí', title:'Married!', desc:'Unlock a Marriage Proposal ending', trigger:'ending_marriage' },
  { id:'ending_friendzone', badge:'ü§ù', title:'Just Friends?', desc:'Unlock a Friendzone ending', trigger:'ending_friendzone' },
  { id:'what_if_used', badge:'üîÆ', title:'Time Traveler', desc:'Use What If mode', trigger:'what_if' },
  { id:'full_energy', badge:'‚ö°', title:'Early Bird', desc:'Visit 3 locations in one day', trigger:'energy_3' },
  { id:'night_owl', badge:'üåô', title:'Night Owl', desc:'Visit a location at night', trigger:'night_visit' },
];

const TIPS_DATA = [
  { icon:'ü§ù', title:'Respect is Everything', body:"A Nigerian woman values being treated with dignity. No matter your charm or wealth, disrespect is an instant deal-breaker. Greet her warmly, listen when she speaks, and never make her feel small." },
  { icon:'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', title:'Family Matters', body:"In Nigeria, you're not just dating one person ‚Äî you're entering a whole family. Show genuine interest in her family and background. Asking about her parents and showing good family values goes a long way." },
  { icon:'üó£Ô∏è', title:'Communication is King', body:"Don't play games with your intentions. Nigerian women appreciate men who are clear about what they want. If you're interested, say so respectfully. If things change, communicate honestly." },
  { icon:'üí∞', title:'Ambition Attracts', body:"You don't have to be rich, but you need direction. Showing that you're working toward something ‚Äî a career, business, education ‚Äî signals you're serious about life. Women respect effort and vision." },
  { icon:'üïå', title:'Understand Her Values', body:"Nigeria is deeply spiritual. Regardless of your own beliefs, respect her faith. Attending church/mosque with her, or simply not mocking what she holds sacred, shows deep respect for who she is." },
  { icon:'üòÇ', title:'Humor Opens Doors', body:"A good sense of humor is universally attractive. Nigerian humor is rich ‚Äî learn to laugh genuinely and make her laugh without putting others down. Don't try too hard though; authenticity wins." },
  { icon:'üéØ', title:'Be Intentional', body:"If you're serious, make it known at the right time. Nigerian women often prefer men who are clear about pursuing a serious relationship rather than just 'hanging out' indefinitely." },
  { icon:'üåπ', title:'Little Gestures Win Hearts', body:"It doesn't have to be expensive. Remembering what she told you, checking in when she's stressed, bringing food she mentioned she likes ‚Äî these small things build genuine connection." },
  { icon:'üëÇ', title:'Listen First, Talk Second', body:"Ask her questions and genuinely listen. Don't just wait for your turn to speak. The ability to make a woman feel heard and understood is incredibly powerful and rare." },
  { icon:'‚úÖ', title:'Consistency is King', body:"Showing up consistently ‚Äî keeping your word, following through on plans, maintaining the same energy ‚Äî is what separates serious men from those passing through. Be reliable." },
  { icon:'üá≥üá¨', title:'Embrace the Culture', body:"Learning Pidgin, appreciating Afrobeats, eating the food ‚Äî these aren't just social points. They show genuine love for her world. You don't have to fake it ‚Äî just be curious and open." },
  { icon:'‚è≥', title:'Patience is Virtue', body:"Don't rush stages. Going from stranger to close friend to crush to partner takes time and genuine effort. Pressure kills attraction. Let things develop naturally and enjoy each phase." },
];

const EVENTS = [
  { id:'independence', emoji:'üá≥üá¨', title:'Independence Day!', desc:'October 1st ‚Äî All NPCs have special greetings today and interest is boosted by 20%! Visit a location to celebrate together.', bonus:{charm:10,allInterest:20} },
  { id:'eid', emoji:'üåô', title:'Sallah Celebration!', desc:'Eid Mubarak! Share in the celebration. Visiting Amaka today means joining her family gathering ‚Äî a huge trust boost.', npc:'amaka', bonus:{interest:30} },
  { id:'christmas', emoji:'üéÑ', title:'Merry Christmas!', desc:'Season of love! All gifts cost 50% less today and interest boosts from gifts are doubled!', bonus:{giftDiscount:0.5} },
];

const DATE_OPTIONS = {
  locations:[
    {id:'restaurant',emoji:'üçΩÔ∏è',label:'Nice Restaurant',score:3,cost:1000},
    {id:'park',emoji:'üå≥',label:'Park Walk',score:2,cost:0},
    {id:'cinema',emoji:'üé¨',label:'Cinema',score:2,cost:600},
    {id:'beach',emoji:'üèñÔ∏è',label:'Bar Beach',score:3,cost:200},
    {id:'home',emoji:'üè†',label:'Cook at Home',score:4,cost:300},
  ],
  outfits:[
    {id:'agbada',emoji:'üëò',label:'Agbada (Traditional)',score:3},
    {id:'smart',emoji:'üëî',label:'Smart Casual',score:2},
    {id:'casual',emoji:'üëï',label:'Casual',score:1},
    {id:'dashiki',emoji:'üß°',label:'Dashiki',score:3},
  ],
  gifts:[
    {id:'none',emoji:'ü§∑',label:'No Gift',score:0},
    {id:'flowers',emoji:'üíê',label:'Flowers',score:2,cost:200},
    {id:'chocolates',emoji:'üç´',label:'Chocolates',score:2,cost:300},
    {id:'jewelry',emoji:'üíç',label:'Jewelry',score:4,cost:1500},
  ],
  times:[
    {id:'morning',emoji:'üåÖ',label:'Morning',score:1},
    {id:'afternoon',emoji:'‚òÄÔ∏è',label:'Afternoon',score:2},
    {id:'evening',emoji:'üåÜ',label:'Evening',score:3},
    {id:'night',emoji:'üåô',label:'Night',score:4},
  ],
};

// ============================================================
// RELATIONSHIP STAGES
// ============================================================
function getStage(interest) {
  if(interest>=85) return {label:'Partner üíï',cls:'stage-partner'};
  if(interest>=60) return {label:'Crush üíò',cls:'stage-crush'};
  if(interest>=30) return {label:'Friend üë´',cls:'stage-friend'};
  return {label:'Stranger üëã',cls:'stage-stranger'};
}
function getHearts(interest) {
  if(interest>=85) return '‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è';
  if(interest>=60) return '‚ù§Ô∏è‚ù§Ô∏è';
  if(interest>=30) return '‚ù§Ô∏è';
  return 'ü§ç';
}
function getMoodText(npc) {
  const moods={
    'üòä':'Happy today ‚Äî good time to approach!',
    'üò§':'A bit stubborn ‚Äî tread carefully.',
    'ü§î':'Thoughtful ‚Äî engage her intellectually.',
    'üòá':'Warm-hearted ‚Äî gestures will work well.',
    'ü§©':'Excited ‚Äî match her energy!',
  };
  return moods[npc.mood]||'';
}

// ============================================================
// AVATAR SVGs
// ============================================================
function playerSVG(av) {
  const skins=['#8B5E3C','#6B3A2A','#A0522D','#C68642'];
  const shirts=['#008751','#2196F3','#9C27B0','#FF5722'];
  const s=skins[av]||skins[0], sh=shirts[av]||shirts[0];
  return `<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
    <rect width="80" height="80" fill="#f0e6d3" rx="12"/>
    <rect x="20" y="48" width="40" height="25" rx="8" fill="${sh}"/>
    <rect x="30" y="42" width="20" height="20" rx="10" fill="${s}"/>
    <ellipse cx="40" cy="30" rx="18" ry="20" fill="${s}"/>
    <ellipse cx="40" cy="14" rx="18" ry="10" fill="#2C1810"/>
    <ellipse cx="33" cy="28" rx="4" ry="5" fill="white"/>
    <ellipse cx="47" cy="28" rx="4" ry="5" fill="white"/>
    <circle cx="34" cy="29" r="2.5" fill="#1a0a00"/>
    <circle cx="48" cy="29" r="2.5" fill="#1a0a00"/>
    <path d="M34 38 Q40 44 46 38" stroke="#2C1810" stroke-width="1.5" fill="none" stroke-linecap="round"/>
  </svg>`;
}

function npcSVG(npc) {
  return `<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
    <rect width="80" height="80" fill="#FFF0E6" rx="40"/>
    <rect x="16" y="46" width="48" height="30" rx="8" fill="${npc.clothColor}"/>
    <rect x="26" y="40" width="28" height="22" rx="14" fill="${npc.skinTone}"/>
    <ellipse cx="40" cy="28" rx="20" ry="22" fill="${npc.skinTone}"/>
    <path d="M20 22 Q40 8 60 22 Q60 10 40 6 Q20 10 20 22Z" fill="${npc.headwrapColor}"/>
    <ellipse cx="34" cy="27" rx="4" ry="5" fill="white"/>
    <ellipse cx="46" cy="27" rx="4" ry="5" fill="white"/>
    <circle cx="35" cy="28" r="2.5" fill="#1a0a00"/>
    <circle cx="47" cy="28" r="2.5" fill="#1a0a00"/>
    <circle cx="36" cy="27" r="1" fill="white"/>
    <circle cx="48" cy="27" r="1" fill="white"/>
    <path d="M34 37 Q40 43 46 37" stroke="#3a1a00" stroke-width="1.8" fill="none" stroke-linecap="round"/>
    <circle cx="20" cy="30" r="3" fill="${npc.headwrapColor}"/>
    <circle cx="60" cy="30" r="3" fill="${npc.headwrapColor}"/>
  </svg>`;
}

function npcSceneSVG(npc,scale=1) {
  return `<svg viewBox="0 0 100 200" width="${Math.round(90*scale)}" height="${Math.round(180*scale)}" xmlns="http://www.w3.org/2000/svg">
    <ellipse cx="50" cy="155" rx="32" ry="42" fill="${npc.clothColor}"/>
    <rect x="43" y="105" width="14" height="25" rx="7" fill="${npc.skinTone}"/>
    <ellipse cx="50" cy="90" rx="28" ry="30" fill="${npc.skinTone}"/>
    <path d="M22 80 Q50 58 78 80 Q78 64 50 56 Q22 64 22 80Z" fill="${npc.headwrapColor}"/>
    <ellipse cx="41" cy="88" rx="5.5" ry="6.5" fill="white"/>
    <ellipse cx="59" cy="88" rx="5.5" ry="6.5" fill="white"/>
    <circle cx="42" cy="89" r="3.5" fill="#1a0a00"/>
    <circle cx="60" cy="89" r="3.5" fill="#1a0a00"/>
    <circle cx="43" cy="88" r="1.2" fill="white"/>
    <circle cx="61" cy="88" r="1.2" fill="white"/>
    <path d="M40 100 Q50 110 60 100" stroke="#3a1a00" stroke-width="2" fill="none" stroke-linecap="round"/>
    <circle cx="22" cy="90" r="4" fill="${npc.headwrapColor}"/>
    <circle cx="78" cy="90" r="4" fill="${npc.headwrapColor}"/>
    <path d="M20 130 Q10 158 18 178" stroke="${npc.clothColor}" stroke-width="14" stroke-linecap="round" fill="none"/>
    <path d="M80 130 Q90 158 82 178" stroke="${npc.clothColor}" stroke-width="14" stroke-linecap="round" fill="none"/>
    <circle cx="18" cy="178" r="8" fill="${npc.skinTone}"/>
    <circle cx="82" cy="178" r="8" fill="${npc.skinTone}"/>
  </svg>`;
}

function rivalSVG() {
  return `<svg viewBox="0 0 80 160" width="60" height="120" xmlns="http://www.w3.org/2000/svg">
    <ellipse cx="40" cy="120" rx="26" ry="35" fill="#2C1810"/>
    <rect x="34" y="85" width="12" height="20" rx="6" fill="#6B3A2A"/>
    <ellipse cx="40" cy="72" rx="22" ry="24" fill="#6B3A2A"/>
    <ellipse cx="40" cy="52" rx="22" ry="10" fill="#1a0a00"/>
    <ellipse cx="33" cy="70" rx="4" ry="5" fill="white"/>
    <ellipse cx="47" cy="70" rx="4" ry="5" fill="white"/>
    <circle cx="34" cy="71" r="2.5" fill="#1a0a00"/>
    <circle cx="48" cy="71" r="2.5" fill="#1a0a00"/>
    <path d="M34 82 Q40 78 46 82" stroke="#2C1810" stroke-width="2" fill="none"/>
    <text x="30" y="48" font-size="14">üò§</text>
  </svg>`;
}

// ============================================================
// UTILITY
// ============================================================
let toastTimeout;
function showToast(msg,dur=2500) {
  const t=document.getElementById('toast');
  clearTimeout(toastTimeout);
  t.textContent=msg; t.classList.add('show');
  toastTimeout=setTimeout(()=>t.classList.remove('show'),dur);
}

// Screens that require an active character/game
const GAME_SCREENS = new Set(['map-screen','scene-screen','date-screen','phone-screen','chat-screen','skills-screen','shop-screen','journal-screen','achievements-screen','leaderboard-screen','analytics-screen','event-screen','endings-screen','tips-screen','bestie-screen']);

function gameIsActive() {
  return G.gameStarted === true;
}

function showScreen(id) {
  // Block access to game screens if no character created
  if(GAME_SCREENS.has(id) && !gameIsActive()) {
    showToast('‚ö†Ô∏è Create your character first!', 2000);
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    document.getElementById('title-screen').classList.add('active');
    return;
  }
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  const el = document.getElementById(id);
  if(el) el.classList.add('active');
}

function updateStats() {
  const s=G.stats;
  ['charm','money','confidence','intelligence'].forEach(st=>{
    const maps={charm:'charm',money:'money',confidence:'conf',intelligence:'intel'};
    const short=maps[st];
    ['m-'+short,'s-'+short].forEach(id=>{
      const el=document.getElementById(id);
      if(el) el.style.width=Math.max(0,Math.min(100,s[st]))+'%';
    });
    ['m-'+short+'-v','s-'+short+'-v'].forEach(id=>{
      const el=document.getElementById(id);
      if(el) el.textContent=Math.round(s[st]);
    });
  });
  // Energy
  const epct=(G.energy/G.maxEnergy)*100;
  ['energy-bar','s-energy-bar'].forEach(id=>{const el=document.getElementById(id);if(el)el.style.width=epct+'%';});
  ['energy-val','s-energy-val'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=G.energy+'/'+G.maxEnergy;});
  // Energy color
  const eColor=G.energy<=1?'linear-gradient(90deg,#E74C3C,#ff6b6b)':G.energy<=2?'linear-gradient(90deg,#FF6B35,#FFD700)':'linear-gradient(90deg,#FF6B35,#FFD700)';
  ['energy-bar','s-energy-bar'].forEach(id=>{const el=document.getElementById(id);if(el)el.style.background=eColor;});
  const wb=document.getElementById('wallet-display');
  if(wb) wb.textContent=G.wallet;
  const db=document.getElementById('day-badge');
  if(db) db.textContent='Day '+G.day;
  const sp=document.getElementById('skill-points-display');
  if(sp) sp.textContent='SP: '+G.player.skillPoints;
  // Check charm 100
  if(s.charm>=100) unlockAchievement('century');
  // Check wallet
  if(G.wallet>=5000) unlockAchievement('rich');
}

function gainXP(amount) {
  G.player.xp+=amount;
  const needed=G.player.level*80;
  if(G.player.xp>=needed){
    G.player.xp-=needed;
    G.player.level++;
    G.player.skillPoints+=2;
    showToast(`üéâ Level ${G.player.level}! +2 Skill Points!`,3000);
    if(G.player.level>=5) unlockAchievement('level5');
  }
  updateStats();
  saveGame();
}

const TIME_SEQUENCE=['morning','afternoon','evening','night'];
const TIME_EMOJIS={morning:'üåÖ',afternoon:'‚òÄÔ∏è',evening:'üåÜ',night:'üåô'};

function advanceTimeOfDay() {
  const idx=TIME_SEQUENCE.indexOf(G.timeOfDay);
  if(idx<TIME_SEQUENCE.length-1){
    G.timeOfDay=TIME_SEQUENCE[idx+1];
    showToast(`${TIME_EMOJIS[G.timeOfDay]} Time advances to ${G.timeOfDay}!`);
    if(G.timeOfDay==='night') unlockAchievement('night_owl');
    buildMapScreen();
  } else {
    // End of day - advance to next day
    G.day++;
    G.timeOfDay='morning';
    G.energy=G.maxEnergy;
    G.visitsToday=0;
    const db=document.getElementById('day-badge');
    if(db) db.textContent='Day '+G.day;
    showToast(`üåÖ Day ${G.day} begins! Energy restored ‚ö°`);
    // Random NPC notification
    const npcIds=Object.keys(NPCS).filter(id=>G.relationships[id]&&G.relationships[id].met);
    if(npcIds.length>0){
      const rid=npcIds[Math.floor(Math.random()*npcIds.length)];
      const npc=NPCS[rid];
      setTimeout(()=>{
        document.getElementById('phone-notif').classList.add('show');
        showToast(`üì± ${npc.name} sent you a message!`,3000);
      },1500);
    }
    buildMapScreen();
  }
  updateStats();
}

function advanceDay() {
  // Each visit advances time by one step
  advanceTimeOfDay();
}

function restAndRecover() {
  document.getElementById('energy-depleted').classList.remove('show');
  G.energy=Math.min(G.maxEnergy,G.energy+3);
  advanceTimeOfDay(); // resting costs time
  updateStats();
  saveGame();
  buildMapScreen();
}

function spendToRecover() {
  if(G.wallet<300){ showToast('Not enough money! ‚Ç¶300 needed.'); return; }
  G.wallet-=300;
  G.energy=Math.min(G.maxEnergy,G.energy+2);
  document.getElementById('energy-depleted').classList.remove('show');
  updateStats();
  showToast('‚òï Energy restored! +2 ‚ö°');
  saveGame();
  buildMapScreen();
}

// ============================================================
// ACHIEVEMENTS
// ============================================================
let goodStreak=0, triviaCorrect=0, rivalRejected=0, giftsBought=0, pidginCompleted=false;

function unlockAchievement(id) {
  if(G.achievements[id]) return;
  const def=ACHIEVEMENTS_DEF.find(a=>a.id===id);
  if(!def) return;
  G.achievements[id]=true;
  const pop=document.getElementById('ach-pop');
  document.getElementById('ach-pop-name').textContent=def.badge+' '+def.title;
  pop.classList.add('show');
  setTimeout(()=>pop.classList.remove('show'),3000);
  buildAchievements();
  saveGame();
}

function checkAchievements() {
  const metCount=Object.values(NPCS).filter(n=>G.relationships[n.id]&&G.relationships[n.id].met).length;
  if(metCount>=1) unlockAchievement('first_hello');
  if(metCount>=5) unlockAchievement('all_met');
  const numbersGot=Object.values(G.relationships).filter(r=>r.interest>=50).length;
  if(numbersGot>=1) unlockAchievement('first_number');
  const partnerCount=Object.values(G.relationships).filter(r=>r.interest>=85).length;
  if(partnerCount>=1) unlockAchievement('partner');
  const dateCount=Object.values(G.relationships).filter(r=>r.dated).length;
  if(dateCount>=5) unlockAchievement('all_dates');
  const skillCount=Object.values(G.skills).filter(Boolean).length;
  if(skillCount>=5) unlockAchievement('skilled');
}

// ============================================================
// SAVE / LOAD
// ============================================================
function saveGame() {
  if(G.whatIfMode) return; // Never save during what-if mode!
  try {
    const save={player:G.player,stats:G.stats,wallet:G.wallet,day:G.day,timeOfDay:G.timeOfDay,energy:G.energy,visitsToday:G.visitsToday,relationships:G.relationships,inventory:G.inventory,skills:G.skills,achievements:G.achievements,messages:G.messages,completedLocations:[...G.completedLocations],datePlans:G.datePlans,endings:G.endings,sceneHistory:G.sceneHistory,consequences:G.consequences,anniversaries:G.anniversaries,milestones:G.milestones,jealousyLevel:G.jealousyLevel,familyVisits:G.familyVisits,choiceLog:G.choiceLog,timeline:G.timeline,challengeProgress:G.challengeProgress,gossipHeard:G.gossipHeard,dailyChallenge:G.dailyChallenge,ambientOn:G.ambientOn,foundLore:G.foundLore,crossoverUsed:G.crossoverUsed,adaezeUnlocked:G.adaezeUnlocked,tutorialDone:G.tutorialDone,gameStarted:G.gameStarted};
    localStorage.setItem('naija_love_quest_v3',JSON.stringify(save));
  } catch(e){}
}

function loadGame() {
  try {
    const raw=localStorage.getItem('naija_love_quest_v3')||localStorage.getItem('naija_love_quest_v2');
    if(!raw){ showToast('No save found! Start a new game.',2500); return; }
    const save=JSON.parse(raw);
    Object.assign(G.player,save.player);
    Object.assign(G.stats,save.stats);
    G.wallet=save.wallet||3000;
    G.day=save.day||1;
    G.timeOfDay=save.timeOfDay||'morning';
    G.energy=save.energy!=null?save.energy:5;
    G.visitsToday=save.visitsToday||0;
    G.relationships=save.relationships||{};
    G.inventory=save.inventory||[];
    G.skills=save.skills||{};
    G.achievements=save.achievements||{};
    G.messages=save.messages||{};
    G.completedLocations=new Set(save.completedLocations||[]);
    G.datePlans=save.datePlans||{};
    G.endings=save.endings||{};
    G.sceneHistory=save.sceneHistory||{};
    G.consequences=save.consequences||{};
    G.anniversaries=save.anniversaries||{};
    G.milestones=save.milestones||{};
    G.jealousyLevel=save.jealousyLevel||{};
    G.familyVisits=save.familyVisits||{};
    G.choiceLog=save.choiceLog||[];
    G.timeline=save.timeline||[];
    G.challengeProgress=save.challengeProgress||{};
    G.gossipHeard=save.gossipHeard||{};
    G.dailyChallenge=save.dailyChallenge||generateDailyChallenge();
    G.ambientOn=save.ambientOn||false;
    initV5Features();
    G.foundLore=save.foundLore||{};
    G.crossoverUsed=save.crossoverUsed||[];
    G.adaezeUnlocked=save.adaezeUnlocked||false;
    G.tutorialDone=save.tutorialDone||false;
    G.gameStarted=save.gameStarted||true;
    if(G.adaezeUnlocked&&!G.relationships.adaeze){G.relationships.adaeze={interest:10,met:false,status:'Stranger',dated:false,memories:[],phoneStep:0,broken:false};}
    initV6Features();
    buildMapScreen();
    buildJournal();
    buildTips();
    buildShop();
    buildSkills();
    buildAchievements();
    buildPhone();
    updateStats();
    showScreen('map-screen');
    showToast(`Welcome back, ${G.player.name}! Day ${G.day} üíö`);
  } catch(e){ showToast('Save data corrupted. Starting fresh.',2500); }
}

// ============================================================
// SETUP
// ============================================================
function goToSetup() {
  showScreen('setup-screen');
  const grid=document.getElementById('avatar-grid');
  grid.innerHTML=[0,1,2,3].map(i=>`<div class="avatar-option ${i===0?'selected':''}" onclick="selAvatar(this,${i})">${playerSVG(i)}</div>`).join('');
  G.player.avatar=0;
  G.player.trait='funny';
}

function selAvatar(el,idx){ document.querySelectorAll('.avatar-option').forEach(a=>a.classList.remove('selected')); el.classList.add('selected'); G.player.avatar=idx; }
function selectTrait(el,t){ document.querySelectorAll('.trait-btn').forEach(b=>b.classList.remove('selected')); el.classList.add('selected'); G.player.trait=t; }
function setLang(l){
  G.player.lang=l;
  document.getElementById('lang-english').classList.toggle('selected',l==='english');
  document.getElementById('lang-pidgin').classList.toggle('selected',l==='pidgin');
}

function startGame() {
  const name=document.getElementById('player-name').value.trim();
  if(!name){
    const inp=document.getElementById('player-name');
    inp.style.borderColor='#E74C3C';
    inp.placeholder='Enter your name first! üëÜ';
    inp.focus();
    setTimeout(()=>{inp.style.borderColor='';inp.placeholder='Enter your name...';},2000);
    return;
  }
  G.player.name=name;
  G.gameStarted=true;
  G.energy=G.maxEnergy;
  G.visitsToday=0;
  G.endings={};
  G.sceneHistory={};
  G.consequences={};
  G.anniversaries={};
  G.milestones={};
  G.jealousyLevel={};
  G.familyVisits={};
  G.choiceLog=[];
  G.timeline=[];
  G.challengeProgress={};
  G.gossipHeard={};
  G.dailyChallenge=generateDailyChallenge();
  G.ambientOn=false;
  G.foundLore={};
  G.crossoverUsed=[];
  G.adaezeUnlocked=false;
  G.tutorialDone=false;
  Object.keys(NPCS).forEach(id=>{ G.relationships[id]={interest:10,met:false,status:'Stranger',dated:false,memories:[],phoneStep:0,broken:false}; });
  buildMapScreen(); buildJournal(); buildTips(); buildShop(); buildSkills(); buildAchievements(); buildPhone();
  initV6Features();
  updateStats();
  showScreen('map-screen');
  showToast(`Welcome, ${name}! Your love story begins! üíö`);
  saveGame();
}

// ============================================================
// MAP
// ============================================================
function buildMapScreen() {
  const container=document.getElementById('map-container');
  let html=`<div class="map-bg-img"></div>`;
  html+=`<div class="map-title">üìç Lagos, Nigeria</div>`;
  html+=`<div class="player-lvl">Lvl ${G.player.level}</div>`;
  const timeEmoji={morning:'üåÖ',afternoon:'‚òÄÔ∏è',evening:'üåÜ',night:'üåô'};
  html+=`<div class="time-of-day-badge">${timeEmoji[G.timeOfDay]||'‚òÄÔ∏è'} ${G.timeOfDay.charAt(0).toUpperCase()+G.timeOfDay.slice(1)} <button onclick="advanceTimeOfDay()" style="background:rgba(255,215,0,.2);border:none;color:var(--gold);font-size:9px;font-weight:800;cursor:pointer;padding:1px 5px;border-radius:5px;margin-left:4px">‚è© Skip</button></div>`;
  html+=`<button class="ambient-btn" onclick="toggleAmbientSound()" id="ambient-btn-el">${G.ambientOn?'üîä':'üîá'} Ambient</button>`;

  // City silhouette SVG
  html+=`<svg style="position:absolute;bottom:0;left:0;width:100%;height:45%;opacity:.2;pointer-events:none" viewBox="0 0 430 200" xmlns="http://www.w3.org/2000/svg">
    <rect x="0" y="100" width="50" height="100" fill="#1a3a2a"/>
    <rect x="12" y="80" width="26" height="20" fill="#1a3a2a"/>
    <rect x="55" y="120" width="65" height="80" fill="#1a3a2a"/>
    <rect x="65" y="95" width="45" height="25" fill="#1a3a2a"/>
    <rect x="125" y="70" width="55" height="130" fill="#1a3a2a"/>
    <rect x="185" y="100" width="75" height="100" fill="#1a3a2a"/>
    <rect x="265" y="80" width="50" height="120" fill="#1a3a2a"/>
    <rect x="320" y="105" width="60" height="95" fill="#1a3a2a"/>
    <rect x="385" y="85" width="45" height="115" fill="#1a3a2a"/>
    ${[55,130,190,270,325,390].map(x=>`<rect x="${x+5}" y="${70+Math.random()*40|0}" width="8" height="8" fill="rgba(255,215,0,.4)"/>`).join('')}
  </svg>`;

  LOCATIONS.filter(loc=>!loc.secret).forEach((loc,idx)=>{
    const rel=G.relationships[loc.id];
    const met=rel&&rel.met;
    const completed=G.completedLocations.has(loc.id);
    const available=!loc.availableTimes||loc.availableTimes.includes(G.timeOfDay);
    const delay=idx*0.3;
    const lockedClass=(!available)?'pin-locked-time':'';
    const lockedStyle=(!available)?'opacity:.45':'';
    html+=`<div class="location-pin ${lockedClass}" style="left:${loc.x};top:${loc.y};animation:pin-bounce 2s ${delay}s ease-in-out infinite;${lockedStyle}" onclick="${available?`visitLocation('${loc.id}')`:`showToast('${NPCS[loc.id].name} isn\\'t here ${G.timeOfDay}. Try ${(loc.availableTimes||['later'])[0]}!')`}">
      <div class="pin-icon" style="background:${loc.color}">${loc.emoji}${completed?'‚úÖ':available?'':' üïê'}</div>
      <div class="pin-label">${loc.label}</div>
      ${!available?`<span style="font-size:8px;background:rgba(0,0,0,.7);color:#FFD700;padding:1px 5px;border-radius:5px;display:block;text-align:center">${loc.timeLabel||''}</span>`:''}
      ${met&&available?`<div class="pin-hearts">${getHearts(rel.interest)}</div>`:''}
    </div>`;
  });

  // Event banner
  html+=`<div class="event-banner" onclick="showEvents()">üéâ Special Events Available! Tap to view</div>`;
  // Quick access buttons row
  html+=`<div style="position:absolute;bottom:8px;left:8px;right:8px;display:flex;gap:6px;z-index:5">
    <button onclick="showBestie()" style="flex:1;background:rgba(0,188,212,.15);border:1px solid rgba(0,188,212,.3);color:var(--teal);font-size:11px;font-weight:800;padding:7px 4px;border-radius:12px;cursor:pointer">üí¨ Bestie</button>
    <button onclick="hearGossip()" style="flex:1;background:rgba(255,107,53,.15);border:1px solid rgba(255,107,53,.3);color:var(--orange);font-size:11px;font-weight:800;padding:7px 4px;border-radius:12px;cursor:pointer">üó£Ô∏è Gossip</button>
    <button onclick="showDailyChallenge()" style="flex:1;background:rgba(255,107,157,.15);border:1px solid rgba(255,107,157,.3);color:var(--pink);font-size:11px;font-weight:800;padding:7px 4px;border-radius:12px;cursor:pointer">üéØ Daily</button>
    <button onclick="showBestieEndings()" style="flex:1;background:rgba(255,215,0,.1);border:1px solid rgba(255,215,0,.3);color:var(--gold);font-size:11px;font-weight:800;padding:7px 4px;border-radius:12px;cursor:pointer">üí´ Ends</button>
  </div>`;

  container.innerHTML=html;

  // CSS for pin bounce
  if(!document.getElementById('pin-style')){
    const s=document.createElement('style');
    s.id='pin-style';
    s.textContent='@keyframes pin-bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-7px)}}';
    document.head.appendChild(s);
  }
}

// ============================================================
// WHAT IF MODE
// ============================================================
function openWhatIfMode() {
  const npcId=G.currentNPC;
  const history=G.sceneHistory[npcId]||[];
  if(history.length===0){
    showToast('No past scenes to revisit yet! Play more first.',2500);
    return;
  }
  document.getElementById('history-list').innerHTML=history.map((h,i)=>
    `<div class="history-item" onclick="enterWhatIfScene(${i})">
      <div class="history-item-meta">Step ${i+1} ‚Ä¢ Day ${h.day||'?'} ‚Ä¢ ${(h.time||'daytime')}</div>
      <div class="history-item-text">"${h.dialogueText||'...'}"</div>
      <div class="history-item-choice">You chose: ${h.choiceText||'...'}</div>
    </div>`
  ).join('');
  document.getElementById('history-panel').classList.add('show');
  unlockAchievement('what_if_used');
}

function closeHistoryPanel(){
  document.getElementById('history-panel').classList.remove('show');
}

function enterWhatIfScene(historyIdx) {
  document.getElementById('history-panel').classList.remove('show');
  // Snapshot current state
  G.whatIfSnapshot={
    relationships:JSON.parse(JSON.stringify(G.relationships)),
    stats:JSON.parse(JSON.stringify(G.stats)),
    wallet:G.wallet,
    dialogueStep:G.dialogueStep,
  };
  G.whatIfMode=true;
  document.getElementById('what-if-bar').style.display='flex';
  showToast('üîÆ What If Mode ‚Äî Replaying from scene '+( historyIdx+1));
  // Jump to that dialogue step
  const h=G.sceneHistory[G.currentNPC][historyIdx];
  G.dialogueStep=h.step||0;
  showDialogue(h.step||0);
}

function exitWhatIfMode(){
  if(!G.whatIfMode) return;
  // Restore snapshot
  if(G.whatIfSnapshot){
    Object.assign(G.relationships,G.whatIfSnapshot.relationships);
    Object.assign(G.stats,G.whatIfSnapshot.stats);
    G.wallet=G.whatIfSnapshot.wallet;
  }
  G.whatIfMode=false;
  G.whatIfSnapshot=null;
  document.getElementById('what-if-bar').style.display='none';
  updateStats();
  showToast('üîÆ Returned to your real timeline.');
}

// ============================================================
// CONSEQUENCE SYSTEM (cross-NPC ripple effects)
// ============================================================
const CONSEQUENCE_RULES=[
  { trigger:'chiamaka_success', affects:'ngozi', boost:5, msg:'Word travels fast! Ngozi has heard about your charm with Chiamaka! üåü' },
  { trigger:'amaka_success',    affects:'bisi',  boost:8, msg:'Amaka mentioned you to her friends. Bisi is curious about you! üí¨' },
  { trigger:'ngozi_dated',      affects:'amaka', boost:-5, msg:'Amaka heard you were out with someone from tech... she seems less impressed ü§î' },
  { trigger:'titi_success',     affects:'chiamaka', boost:6, msg:'Chiamaka heard you\'re also friendly with Titi. She appreciates that! üòä' },
  { trigger:'rival_rejected',   affects:'all',   boost:4, msg:'Your confidence standing your ground has impressed everyone! üí™' },
];

function recordConsequence(trigger){
  if(G.consequences[trigger]) return;
  G.consequences[trigger]=true;
  saveGame();
}

function applyConsequences(visitingNpcId){
  CONSEQUENCE_RULES.forEach(rule=>{
    if(!G.consequences[rule.trigger]) return;
    if(rule.affects==='all'){
      Object.keys(G.relationships).forEach(id=>{
        if(id!==visitingNpcId) return;
        G.relationships[id].interest=Math.min(100,G.relationships[id].interest+rule.boost);
      });
      if(Object.keys(G.relationships).includes(visitingNpcId)){
        showRippleToast(rule.msg);
      }
    } else if(rule.affects===visitingNpcId){
      G.relationships[visitingNpcId].interest=Math.min(100,Math.max(0,G.relationships[visitingNpcId].interest+rule.boost));
      showRippleToast(rule.msg);
    }
    // Mark as consumed so it doesn't fire again
    delete G.consequences[rule.trigger];
  });
}

function showRippleToast(msg){
  const el=document.getElementById('ripple-toast');
  if(!el) return;
  el.textContent=msg;
  el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'),3500);
}

// ============================================================
// STORY ENDINGS SYSTEM
// ============================================================
const ENDINGS_DATA={
  friendzone:{ emoji:'ü§ù', title:'Just Good Friends', desc:'Your relationship stayed warm but platonic. She values you deeply as a friend.', color:'linear-gradient(135deg,#4A90E2,#74b9ff)', condition: r=>r.interest>=30&&r.interest<55&&r.dated },
  romance:   { emoji:'üíï', title:'Sweet Romance', desc:'You two are officially dating! Lagos has never felt more magical.', color:'linear-gradient(135deg,#FF6B9D,#ff9a9e)', condition: r=>r.interest>=75&&r.dated },
  heartbreak:{ emoji:'üíî', title:'Heartbreak', desc:'Things didn\'t work out, but you learned a lot about yourself.', color:'linear-gradient(135deg,#E74C3C,#c0392b)', condition: r=>r.interest<25&&r.met&&r.dated },
  proposal:  { emoji:'üíç', title:'Marriage Proposal!', desc:'You got down on one knee in Lagos Island. She said YES!', color:'linear-gradient(135deg,#FFD700,#ffaa00)', condition: r=>r.interest>=95&&r.dated },
  longdist:  { emoji:'‚úàÔ∏è', title:'Long Distance Love', desc:'Life takes you both in different directions, but the connection remains.', color:'linear-gradient(135deg,#9B59B6,#6c3483)', condition: r=>r.interest>=60&&r.dated&&r.status==='Acquaintance' },
};

function checkEndings(npcId){
  const rel=G.relationships[npcId];
  if(!rel) return;
  let newEnding=null;
  for(const [type,data] of Object.entries(ENDINGS_DATA)){
    if(!G.endings[npcId]&&data.condition(rel)){
      newEnding=type; break;
    }
  }
  if(newEnding&&newEnding!==G.endings[npcId]){
    G.endings[npcId]=newEnding;
    const ed=ENDINGS_DATA[newEnding];
    const achMap={romance:'ending_romance',proposal:'ending_marriage',friendzone:'ending_friendzone'};
    if(achMap[newEnding]) unlockAchievement(achMap[newEnding]);
    // Show on result panel
    const box=document.getElementById('ending-achieved-box');
    if(box){
      document.getElementById('ending-achieved-emoji').textContent=ed.emoji;
      document.getElementById('ending-achieved-title').textContent='Ending Unlocked: '+ed.title;
      document.getElementById('ending-achieved-desc').textContent=ed.desc;
      box.style.display='block';
    }
    saveGame();
  }
}

function showEndings(){
  const npcIds=Object.keys(NPCS);
  let html='';
  npcIds.forEach(npcId=>{
    const npc=NPCS[npcId];
    const rel=G.relationships[npcId]||{};
    const unlockedType=G.endings[npcId];
    html+=`<div style="margin-bottom:10px;font-family:'Baloo 2',cursive;font-size:13px;color:var(--gold);font-weight:800">${npcSVG(npc).replace('80','28').replace('80','28')} ${npc.name}</div>`;
    Object.entries(ENDINGS_DATA).forEach(([type,data])=>{
      const isUnlocked=unlockedType===type;
      html+=`<div class="ending-card ${isUnlocked?'':'ending-locked'}" style="background:${data.color}">
        <div class="ending-type">${data.emoji} Ending Type</div>
        <div class="ending-title">${isUnlocked?data.title:'???'}</div>
        <div class="ending-desc">${isUnlocked?data.desc:'Keep playing to discover this ending...'}</div>
        ${isUnlocked?`<div class="ending-unlocked-badge">‚úÖ</div>`:''}
      </div>`;
    });
    html+='<div style="height:8px"></div>';
  });
  document.getElementById('endings-content').innerHTML=html;
  showScreen('endings-screen');
}

// ============================================================
// SCENE HISTORY RECORDING
// ============================================================
function recordSceneHistory(npcId,step,dialogueText,choiceText,choiceType){
  if(G.whatIfMode) return; // don't record in what-if
  if(!G.sceneHistory[npcId]) G.sceneHistory[npcId]=[];
  G.sceneHistory[npcId].push({step,dialogueText,choiceText,choiceType,day:G.day,time:G.timeOfDay});
  if(G.sceneHistory[npcId].length>20) G.sceneHistory[npcId].shift();
}


function visitLocation(npcId) {
  // Energy check
  if(G.energy<=0){
    document.getElementById('energy-depleted').classList.add('show');
    return;
  }

  // Time of day check
  const loc=LOCATIONS.find(l=>l.id===npcId);
  if(loc&&loc.availableTimes&&!loc.availableTimes.includes(G.timeOfDay)){
    const npc=NPCS[npcId];
    showToast(`üïê ${npc.name} isn't available ${G.timeOfDay}. Try ${loc.availableTimes[0]}!`,3000);
    return;
  }

  // Spend energy
  G.energy=Math.max(0,G.energy-1);
  G.visitsToday++;
  if(G.visitsToday>=3) unlockAchievement('full_energy');
  
  // V5: track visit challenge
  updateChallengeProgress('visit',npcId);
  if(G.timeOfDay==='night') updateChallengeProgress('night',npcId);
  addToTimeline(`üìç Visited ${NPCS[npcId]?.name||npcId} at ${G.timeOfDay}`,'var(--blue)');

  const npc=NPCS[npcId];
  G.currentNPC=npcId;
  G.dialogueStep=0;
  G.whatIfMode=false;
  document.getElementById('what-if-bar').style.display='none';

  // Initialize scene history for this NPC
  if(!G.sceneHistory[npcId]) G.sceneHistory[npcId]=[];

  const rel=G.relationships[npcId];
  rel.met=true;

  // Record first meeting anniversary
  if(!G.anniversaries[npcId]) G.anniversaries[npcId]={firstMet:G.day};

  // Jealousy system: dating multiple people at Partner/Crush stage
  checkJealousy(npcId);

  checkAchievements();

  // Apply mood modifier
  let interestBonus=0;
  if(npc.mood==='üòä'||npc.mood==='üòá'||npc.mood==='ü§©') interestBonus=5;
  if(interestBonus>0) rel.interest=Math.min(100,rel.interest+interestBonus);

  // Apply skill bonuses
  if(G.skills.fashion_sense) rel.interest=Math.min(100,rel.interest+10);

  // Apply cross-NPC consequences
  applyConsequences(npcId);

  // Scene background
  document.getElementById('scene-bg-layer').style.background=SCENE_BGS[npcId];

  // Char stage
  let stageHTML=`<div class="npc-scene-wrap"><div class="npc-char" id="npc-char">${npcSceneSVG(npc,1.1)}</div></div>`;
  // Random rival appearance (30% chance after day 3)
  if(G.day>3&&Math.random()<0.3&&!G.rivalActive){
    stageHTML+=`<div class="rival-char">${rivalSVG()}</div>`;
  }
  document.getElementById('char-stage').innerHTML=stageHTML;

  // NPC profile
  const stage=getStage(rel.interest);
  document.getElementById('npc-profile-card').innerHTML=`
    <div class="npc-profile-header">
      <div class="npc-av">${npcSVG(npc)}</div>
      <div style="flex:1">
        <div class="npc-name">${npc.name}, ${npc.age}</div>
        <div class="npc-det">${npc.job} ‚Ä¢ ${npc.location}</div>
      </div>
      <div class="npc-mood" title="${getMoodText(npc)}">${npc.mood}</div>
      <div class="npc-interest">
        <div class="npc-hearts">${getHearts(rel.interest)}</div>
        <div class="npc-il">Interest ${rel.interest}%</div>
      </div>
    </div>
    <div class="npc-tags">
      ${npc.interests.map(i=>`<span class="npc-tag">${i}</span>`).join('')}
      <span class="npc-stage-tag">${stage.label}</span>
    </div>
    ${(()=>{const hint=getGossipHint(npcId);return hint?`<div style="background:rgba(255,107,53,.1);border-left:3px solid var(--orange);border-radius:0 8px 8px 0;padding:6px 8px;margin-top:6px;font-size:10px;color:rgba(255,165,0,.8)">${hint}</div>`:''})()}`;

  showScreen('scene-screen');
  updateStats();

  // Check for rival event
  if(G.day>5&&Math.random()<0.25) {
    setTimeout(()=>triggerRivalEvent(npc),2500);
  } else {
    // Check for trivia unlock (every 3rd visit)
    const visitCount=G.completedLocations.size;
    if(visitCount>0&&visitCount%3===0&&Math.random()<0.5){
      setTimeout(()=>startTrivia(npc),2000);
    } else {
      showDialogue(0);
    }
  }
  saveGame();
}

// ============================================================
// DIALOGUE with TYPEWRITER EFFECT
// ============================================================
let typewriterInterval;
function showDialogue(step) {
  const npc=NPCS[G.currentNPC];
  const lang=G.player.lang;
  const dialogues=npc.dialogue[lang]||npc.dialogue.english;

  if(step>=dialogues.length){ showDialogue(dialogues.length-1); return; }
  const d=dialogues[step];
  G.dialogueStep=step;

  document.getElementById('dlg-name').textContent=npc.name;
  document.getElementById('dlg-mood').textContent=getMoodText(npc);
  document.getElementById('choices').innerHTML='';

  // Typewriter effect
  const textEl=document.getElementById('dlg-text');
  textEl.innerHTML='';
  clearInterval(typewriterInterval);
  let i=0;
  const fullText=d.text;
  const cursor=`<span class="typewriter-cursor"></span>`;
  typewriterInterval=setInterval(()=>{
    if(i<fullText.length){
      textEl.innerHTML=fullText.slice(0,++i)+cursor;
    } else {
      clearInterval(typewriterInterval);
      textEl.innerHTML=fullText;
      renderChoices(d.choices);
    }
  },22);
}

function renderChoices(choices) {
  const npc=NPCS[G.currentNPC];
  // Add skill-unlocked extra choice
  let extraChoice=null;
  if(G.skills.smooth_talker&&G.dialogueStep===0){
    extraChoice={ text:'I\'ve been looking forward to meeting you! ‚ú®', type:'good', cd:15, st:1, lesson:'Smooth Talker skill activated!' };
  }
  const allChoices=extraChoice?[...choices,extraChoice]:choices;

  document.getElementById('choices').innerHTML=allChoices.map((c,i)=>{
    const type=c.type==='pidgin'?'pidgin':c.type;
    return `<button class="choice-btn ${type}" onclick="makeChoice(${i},${!!extraChoice})">
      <span class="ct ${type}">${type==='good'?'‚úì':type==='bad'?'‚úó':type==='pidgin'?'üá≥üá¨':'~'}</span>
      ${c.text}
    </button>`;
  }).join('');
}

function makeChoice(idx,hasExtra) {
  const npc=NPCS[G.currentNPC];
  const lang=G.player.lang;
  const dialogues=npc.dialogue[lang]||npc.dialogue.english;
  const d=dialogues[G.dialogueStep];

  let choices=d.choices;
  if(hasExtra&&G.skills.smooth_talker&&G.dialogueStep===0){
    const extra={ text:'I\'ve been looking forward to meeting you!', type:'good', cd:15, st:1, lesson:'Smooth Talker skill activated!' };
    choices=[...choices,extra];
  }
  const choice=choices[idx];
  const rel=G.relationships[G.currentNPC];

  // Calculate delta with skill bonuses and difficulty
  let delta=choice.cd||0;
  if(delta>0&&G.skills.active_listener) delta=Math.round(delta*1.3);
  if(delta>0&&choice.type==='good'&&G.player.trait==='romantic') delta=Math.round(delta*1.2);
  if(delta>0&&G.skills.comedian&&choice.type==='good'&&G.player.trait==='funny') delta=Math.round(delta*1.5);
  // Apply difficulty multiplier
  if(typeof SETTINGS!=='undefined' && delta!==0){
    const mults={casual:{good:1.4,bad:0.4},realistic:{good:1.0,bad:1.0},hard:{good:0.7,bad:1.4},ngplus:{good:0.6,bad:1.6}};
    const m=mults[SETTINGS.difficulty]||mults.realistic;
    if(delta>0) delta=Math.round(delta*m.good);
    else if(delta<0) delta=Math.round(delta*m.bad);
  }

  G.stats.charm=Math.max(0,Math.min(100,G.stats.charm+delta));
  rel.interest=Math.max(0,Math.min(100,rel.interest+Math.abs(delta)*(delta>0?1:-0.4)));

  // Track good streak
  if(delta>0){ goodStreak++; if(goodStreak>=5) unlockAchievement('smooth_criminal'); }
  else goodStreak=0;

  // Memory system
  if(choice.lesson) rel.memories.push(choice.lesson);
  if(rel.memories.length>5) rel.memories.shift();

  // NPC char reaction
  const charEl=document.getElementById('npc-char');
  if(charEl){
    charEl.classList.remove('happy','sad');
    if(delta>0){ charEl.classList.add('happy'); }
    else if(delta<0){ charEl.classList.add('sad'); }
    setTimeout(()=>{ charEl.classList.remove('happy','sad'); },2500);
  }

  // Record to scene history
  const npc2=NPCS[G.currentNPC];
  const lang2=G.player.lang;
  const dlgs2=npc2.dialogue[lang2]||npc2.dialogue.english;
  const d2=dlgs2[G.dialogueStep];
  recordSceneHistory(G.currentNPC,G.dialogueStep,d2?d2.text:'',choice.text,choice.type);

  // Log choice for analytics
  logChoice(choice.type||'neutral',G.currentNPC,d?d.text:'',choice.text);
  
  // Trigger NPC expression
  const charStageEl=document.getElementById('char-stage');
  if(charStageEl){
    const wrap=charStageEl.querySelector('.npc-scene-wrap');
    if(wrap){
      if(delta>0) showNPCExpression(wrap,'good');
      else if(delta<0) showNPCExpression(wrap,'frown');
    }
  }
  
  // Check milestone changes
  checkStageMilestones(G.currentNPC);

  // Play sound feedback
  if(delta>5) playSuccessSound();
  else if(delta<-5) playFailSound();

  // Particle effects on great choices
  if(delta>=10) spawnParticles('hearts',70,50);
  else if(delta>=5) spawnParticles('stars',70,50);

  if(delta>0) showToast(`+${delta} Charm ‚ú®`);
  else if(delta<0) showToast(`${delta} Charm üò¨`);
  updateStats();

  if(lang==='pidgin'&&G.completedLocations.has(G.currentNPC)) pidginCompleted=true;
  if(pidginCompleted) unlockAchievement('pidgin_pro');

  // Route
  const st=choice.st;
  if(st==='fail') return showResult('üò¨','Awkward...','She walked away. Every interaction is a lesson!',0,false,[choice.lesson]);
  if(st==='tooFast') return showResult('‚ö°','Too Fast!','Slow down! Build a connection first.',0,false,['Don\'t rush ‚Äî connection takes time.']);
  if(st==='minigame') {
    // Route to NPC-specific minigame
    const npcId=G.currentNPC;
    if(npcId==='ngozi') return startChessGame();
    if(npcId==='amaka') return startDebateGame();
    if(npcId==='bisi') return startPhotoGame();
    if(npcId==='titi') return startRhythmGame('dance');
    if(npcId==='chiamaka') return startCookoffGame();
    return startMinigame(); // fallback for any other NPC
  }
  if(st==='success'){
    G.completedLocations.add(G.currentNPC);
    rel.status=rel.interest>=60?'Close Friend':'Acquaintance';
    if(rel.interest>=85){
      unlockAchievement('partner');
      // Unlock Meet the Family if not visited yet
      if(!G.familyVisits[G.currentNPC]){
        setTimeout(()=>showToast(`üíê ${NPCS[G.currentNPC].name} wants you to meet her family!`,3500),2000);
      }
    }
    gainXP(50);
    checkAchievements();
    checkEndings(G.currentNPC);
    // Record consequence
    recordConsequence(G.currentNPC+'_success');
    // Exit what-if mode on success
    if(G.whatIfMode) exitWhatIfMode();
    buildMapScreen(); buildJournal();
    return showResult('üéâ','Great Connection!',`${NPCS[G.currentNPC].name} gave you her number! Keep in touch.`,50,true,[choice.lesson]);
  }
  const nextStep=typeof st==='number'?st:G.dialogueStep+1;
  if(nextStep<(dialogues.length)) showDialogue(nextStep);
  else showDialogue(G.dialogueStep);
}

// ============================================================
// MINIGAME WITH TIMER
// ============================================================
let mgTimer, mgTimeLeft;
function startMinigame() {
  const npc=NPCS[G.currentNPC];
  const mg=npc.minigame;
  document.getElementById('mg-title').textContent=mg.title;
  document.getElementById('mg-sub').textContent=mg.sub;
  document.getElementById('mg-panel').classList.add('show');

  // Timer
  mgTimeLeft=mg.timer||12;
  const timerEl=document.getElementById('mg-timer');
  timerEl.textContent=mgTimeLeft;
  timerEl.classList.remove('urgent');
  clearInterval(mgTimer);
  mgTimer=setInterval(()=>{
    mgTimeLeft--;
    timerEl.textContent=mgTimeLeft;
    if(mgTimeLeft<=4) timerEl.classList.add('urgent');
    if(mgTimeLeft<=0){ clearInterval(mgTimer); mgTimeExpired(); }
  },1000);

  // Shuffle options
  const shuffled=[...mg.options].sort(()=>Math.random()-.5);
  document.getElementById('mg-grid').innerHTML=shuffled.map(opt=>
    `<div class="comp-card" onclick="selectCompliment(this,${opt.correct})">
      <div class="comp-emoji">${opt.emoji}</div>
      <div class="comp-text">${opt.text}</div>
    </div>`
  ).join('');
}

function mgTimeExpired(){
  clearInterval(mgTimer);
  document.getElementById('mg-panel').classList.remove('show');
  G.stats.charm=Math.max(0,G.stats.charm-10);
  showToast('‚è∞ Time\'s up! ‚àí10 Charm');
  updateStats();
  const npc=NPCS[G.currentNPC];
  const lang=G.player.lang;
  const dialogues=npc.dialogue[lang]||npc.dialogue.english;
  showDialogue(Math.min(3,dialogues.length-1));
}

function selectCompliment(el,correct) {
  clearInterval(mgTimer);
  const rel=G.relationships[G.currentNPC];
  const npc=NPCS[G.currentNPC];
  el.classList.add(correct?'correct':'wrong');
  setTimeout(()=>{
    document.getElementById('mg-panel').classList.remove('show');
    if(correct){
      let bonus=20; if(G.skills.active_listener) bonus=30;
      G.stats.charm=Math.min(100,G.stats.charm+15);
      rel.interest=Math.min(100,rel.interest+bonus);
      showToast('üéØ Perfect choice! +15 Charm!');
    } else {
      G.stats.charm=Math.max(0,G.stats.charm-5);
      showToast('üò¨ Could\'ve been better... ‚àí5 Charm');
    }
    updateStats();
    const lang=G.player.lang;
    const dialogues=npc.dialogue[lang]||npc.dialogue.english;
    showDialogue(Math.min(3,dialogues.length-1));
  },900);
}

function skipMinigame() {
  clearInterval(mgTimer);
  G.stats.charm=Math.max(0,G.stats.charm-5);
  document.getElementById('mg-panel').classList.remove('show');
  updateStats();
  const npc=NPCS[G.currentNPC];
  const lang=G.player.lang;
  const dialogues=npc.dialogue[lang]||npc.dialogue.english;
  showDialogue(Math.min(3,dialogues.length-1));
}

// ============================================================
// RIVAL EVENT
// ============================================================
function triggerRivalEvent(npc) {
  const rival=npc.rival||{name:'Someone',desc:'A rival appears!'};
  document.getElementById('rival-title').textContent=`üò§ Rival Alert!`;
  document.getElementById('rival-msg').textContent=`${rival.name} is also interested in ${npc.name}. ${rival.desc} How do you handle this?`;
  document.getElementById('rival-event').classList.add('show');
  G.rivalActive=true;
}

function handleRival(standGround) {
  document.getElementById('rival-event').classList.remove('show');
  G.rivalActive=false;
  const rel=G.relationships[G.currentNPC];
  if(standGround){
    G.stats.confidence=Math.min(100,G.stats.confidence+15);
    rel.interest=Math.min(100,rel.interest+15);
    rivalRejected++;
    if(rivalRejected>=3) unlockAchievement('loyal');
    recordConsequence('rival_rejected');
    showToast('üí™ You stood your ground! +15 Confidence!');
  } else {
    G.stats.confidence=Math.max(0,G.stats.confidence-10);
    rel.interest=Math.max(0,rel.interest-10);
    showToast('üòî She noticed you backed off...');
  }
  updateStats();
  showDialogue(G.dialogueStep);
}

// ============================================================
// TRIVIA
// ============================================================
function startTrivia(npc) {
  const tv=npc.trivia;
  document.getElementById('trivia-q').textContent=tv.q;
  document.getElementById('trivia-score').textContent=`Cultural Trivia ‚Äî Answer right for +20 Charm!`;
  document.getElementById('trivia-opts').innerHTML=tv.opts.map((opt,i)=>
    `<button class="trivia-opt" onclick="answerTrivia(this,${i===tv.correct},${JSON.stringify(opt).replace(/"/g,"'")})">${opt}</button>`
  ).join('');
  document.getElementById('trivia-panel').classList.add('show');
}

function answerTrivia(el,correct) {
  document.querySelectorAll('.trivia-opt').forEach(b=>b.disabled=true);
  el.classList.add(correct?'correct':'wrong');
  setTimeout(()=>{
    document.getElementById('trivia-panel').classList.remove('show');
    if(correct){
      G.stats.charm=Math.min(100,G.stats.charm+20);
      showToast('üß† Correct! +20 Charm! You know your culture!');
      triviaCorrect++;
      if(triviaCorrect>=3) unlockAchievement('trivia_ace');
    } else {
      showToast('üòÖ Learn more about Nigerian culture!');
    }
    updateStats();
    showDialogue(G.dialogueStep);
  },1200);
}

// ============================================================
// RESULT PANEL
// ============================================================
function showResult(emoji,title,msg,xp,success,lessons=[]) {
  document.getElementById('res-emoji').textContent=emoji;
  document.getElementById('res-title').textContent=title;
  document.getElementById('res-msg').textContent=msg;
  document.getElementById('res-xp').textContent=success?`+${xp} XP earned! üåü`:'Keep trying!';
  const debrief=document.getElementById('res-debrief');
  if(lessons&&lessons.length>0){
    debrief.innerHTML=`<div class="debrief-title">üí° What You Learned</div>`+
      lessons.filter(Boolean).map(l=>`<div class="debrief-item"><span>üíö</span><span>${l}</span></div>`).join('');
    debrief.style.display='block';
  } else { debrief.style.display='none'; }
  document.getElementById('result-panel').classList.add('show');
  if(success&&xp>0) gainXP(xp);
}

function closeResult() {
  document.getElementById('result-panel').classList.remove('show');
  // Reset ending box
  const box=document.getElementById('ending-achieved-box');
  if(box) box.style.display='none';
  if(G.whatIfMode){
    exitWhatIfMode();
  } else {
    advanceDay();
  }
  backToMap();
}

function backToMap() {
  if(!gameIsActive()) {
    showScreen('title-screen');
    return;
  }
  showScreen('map-screen');
  buildMapScreen();
  switchTab('map');
  saveGame();
}

// ============================================================
// PHONE / TEXTING
// ============================================================
function buildPhone() {
  const container=document.getElementById('phone-contacts');
  const metNPCs=Object.values(NPCS).filter(n=>G.relationships[n.id]&&G.relationships[n.id].met);
  if(metNPCs.length===0){
    container.innerHTML=`<div style="padding:40px;text-align:center;color:rgba(255,255,255,.4)">
      <div style="font-size:40px;margin-bottom:12px">üìµ</div>
      <div style="font-size:14px">No contacts yet!<br>Meet someone on the Map first.</div>
    </div>`;
    return;
  }
  container.innerHTML=metNPCs.map(npc=>{
    const ms=G.messages[npc.id];
    const lastMsg=ms&&ms.length>0?ms[ms.length-1].text:'Tap to start chatting!';
    const unread=G.relationships[npc.id].interest>=30;
    return `<div class="contact-item" onclick="openChat('${npc.id}')">
      <div class="contact-av">${npcSVG(npc)}</div>
      <div style="flex:1">
        <div class="contact-name">${npc.name}</div>
        <div class="contact-preview">${lastMsg.substring(0,40)}${lastMsg.length>40?'...':''}</div>
      </div>
      <div>
        <div class="contact-time">${unread?'now':''}</div>
        ${unread?'<div class="unread-dot"></div>':''}
      </div>
    </div>`;
  }).join('');
  document.getElementById('phone-notif').classList.remove('show');
}

function openChat(npcId) {
  G.currentNPC=npcId;
  const npc=NPCS[npcId];
  const rel=G.relationships[npcId];
  if(!rel.met||rel.interest<25){
    showToast('Meet her first and build some connection! üëã');
    return;
  }

  document.getElementById('chat-av').innerHTML=npcSVG(npc);
  document.getElementById('chat-name').textContent=npc.name;
  document.getElementById('chat-status').textContent='‚óè Online';
  showScreen('chat-screen');

  // Init messages
  if(!G.messages[npcId]) G.messages[npcId]=[];
  const msgs=G.messages[npcId];
  const convo=npc.phoneConvo;
  const step=rel.phoneStep||0;

  if(msgs.length===0&&convo&&convo.length>0&&convo[0].from==='npc'){
    msgs.push({from:'npc',text:convo[0].text,time:getTime()});
    rel.phoneStep=1;
  }

  renderChatMessages(npcId);
  renderChatReplies(npcId);
}

function renderChatMessages(npcId) {
  const msgs=G.messages[npcId]||[];
  const el=document.getElementById('chat-messages');
  el.innerHTML=msgs.map(m=>`
    <div class="msg ${m.from==='player'?'sent':'received'}">
      ${m.text}
      <div class="msg-time">${m.time||'now'}</div>
    </div>`).join('');
  el.scrollTop=el.scrollHeight;
}

function renderChatReplies(npcId) {
  const npc=NPCS[npcId];
  const rel=G.relationships[npcId];
  const convo=npc.phoneConvo;
  const step=rel.phoneStep||0;
  const repliesEl=document.getElementById('chat-replies');

  if(!convo||step>=convo.length){
    repliesEl.innerHTML=`<div style="color:rgba(255,255,255,.4);font-size:12px;padding:8px;text-align:center">Chat is going well! Plan a date üìÖ</div>`;
    return;
  }

  const current=convo[step];
  if(!current){ repliesEl.innerHTML=''; return; }

  if(current.from==='player'&&current.replies){
    repliesEl.innerHTML=current.replies.map((r,i)=>
      `<div class="reply-opt" onclick="sendReply('${npcId}',${i})">${r.text}</div>`
    ).join('');
  } else {
    repliesEl.innerHTML=`<div style="color:rgba(255,255,255,.4);font-size:12px;padding:8px">She's typing...</div>`;
    setTimeout(()=>npcReply(npcId),1500);
  }
}

function sendReply(npcId,idx) {
  const npc=NPCS[npcId];
  const rel=G.relationships[npcId];
  const convo=npc.phoneConvo;
  const step=rel.phoneStep||0;
  const current=convo[step];
  if(!current||!current.replies) return;

  const reply=current.replies[idx];
  if(!G.messages[npcId]) G.messages[npcId]=[];
  G.messages[npcId].push({from:'player',text:reply.text,time:getTime()});

  rel.interest=Math.min(100,rel.interest+(reply.boost||5));
  rel.phoneStep=(step+1);
  renderChatMessages(npcId);

  // NPC responds after delay
  const nextStep=convo[rel.phoneStep];
  if(nextStep&&nextStep.from==='npc'){
    document.getElementById('chat-replies').innerHTML=`<div style="color:rgba(255,255,255,.4);font-size:12px;padding:8px">${npc.name} is typing...</div>`;
    setTimeout(()=>npcReply(npcId),1200);
  } else {
    renderChatReplies(npcId);
  }
  updateStats(); buildJournal(); saveGame();
}

function npcReply(npcId) {
  const npc=NPCS[npcId];
  const rel=G.relationships[npcId];
  const convo=npc.phoneConvo;
  const step=rel.phoneStep;
  if(!convo||step>=convo.length) return;
  const msg=convo[step];
  if(!msg||msg.from!=='npc') return;

  G.messages[npcId].push({from:'npc',text:msg.text,time:getTime()});
  rel.phoneStep++;
  renderChatMessages(npcId);
  renderChatReplies(npcId);
}

function getTime() {
  const d=new Date();
  return d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0');
}

// ============================================================
// DATE PLANNER
// ============================================================
let datePlan={ loc:null, outfit:null, gift:null, time:null };

function openDatePlanner(npcId) {
  const rel=G.relationships[npcId||G.currentNPC];
  if(!rel||rel.interest<50){
    showToast('Build more connection first! Need 50+ interest üíï');
    return;
  }
  G.currentNPC=npcId||G.currentNPC;
  datePlan={ loc:null, outfit:null, gift:null, time:null };

  document.getElementById('date-screen-title').textContent=`Plan a Date with ${NPCS[G.currentNPC].name}`;

  const makeOpts=(opts,rowId,planKey)=>
    opts.map(o=>`<div class="date-opt" onclick="selectDateOpt(this,'${rowId}','${planKey}','${o.id}',${o.score},${o.cost||0})" title="${o.label}">
      <span class="date-opt-emoji">${o.emoji}</span>
      <span class="date-opt-label">${o.label}</span>
    </div>`).join('');

  document.getElementById('date-loc-row').innerHTML=makeOpts(DATE_OPTIONS.locations,'date-loc-row','loc');
  document.getElementById('date-outfit-row').innerHTML=makeOpts(DATE_OPTIONS.outfits,'date-outfit-row','outfit');
  document.getElementById('date-gift-row').innerHTML=makeOpts(DATE_OPTIONS.gifts,'date-gift-row','gift');
  document.getElementById('date-time-row').innerHTML=makeOpts(DATE_OPTIONS.times,'date-time-row','time');

  showScreen('date-screen');
}

function selectDateOpt(el,rowId,planKey,optId,score,cost) {
  document.querySelectorAll(`#${rowId} .date-opt`).forEach(o=>o.classList.remove('sel'));
  el.classList.add('sel');
  datePlan[planKey]={ id:optId, score, cost };
  updateDatePreview();
}

function updateDatePreview() {
  const total=Object.values(datePlan).filter(Boolean).reduce((sum,o)=>sum+(o.score||0),0);
  const totalCost=Object.values(datePlan).filter(Boolean).reduce((sum,o)=>sum+(o.cost||0),0);
  const npc=NPCS[G.currentNPC];
  let grade='',emoji='';
  if(total>=10){ grade='Perfect Date! üåü'; emoji='üíï'; }
  else if(total>=7){ grade='Great Date! üòç'; emoji='‚ù§Ô∏è'; }
  else if(total>=5){ grade='Nice Date'; emoji='üòä'; }
  else if(total>0){ grade='Basic Date...'; emoji='üòê'; }
  else{ grade='Plan your date above! üëÜ'; emoji='üìÖ'; }
  document.getElementById('date-preview-card').innerHTML=`
    <div style="font-size:36px;margin-bottom:8px">${emoji}</div>
    <div style="font-family:'Baloo 2',cursive;font-size:18px;color:var(--gold);font-weight:800">${grade}</div>
    <div style="color:rgba(255,255,255,.7);font-size:13px;margin-top:6px">Score: ${total}/13 ‚Ä¢ Cost: ‚Ç¶${totalCost}</div>
    ${totalCost>0?`<div style="color:rgba(255,255,255,.5);font-size:11px;margin-top:4px">Wallet: ‚Ç¶${G.wallet}</div>`:''}`;
}

function goOnDate() {
  const filled=Object.values(datePlan).filter(Boolean).length;
  if(filled<2){ showToast('Plan at least 2 aspects of the date!'); return; }
  const total=Object.values(datePlan).filter(Boolean).reduce((sum,o)=>sum+(o.score||0),0);
  const totalCost=Object.values(datePlan).filter(Boolean).reduce((sum,o)=>sum+(o.cost||0),0);
  if(G.wallet<totalCost){ showToast('Not enough money! üí∞ Earn more in the Shop.'); return; }
  G.wallet-=totalCost;
  const rel=G.relationships[G.currentNPC];
  const npc=NPCS[G.currentNPC];
  let boost=0,msg='';
  if(total>=10){ boost=35; msg=`The date was absolutely perfect! ${npc.name} is head over heels! üíï`; unlockAchievement('date_master'); }
  else if(total>=7){ boost=22; msg=`${npc.name} had a wonderful time! She's definitely interested.`; }
  else if(total>=5){ boost=12; msg=`It was a decent date. ${npc.name} had fun but felt you could do better.`; }
  else { boost=5; msg=`${npc.name} appreciated the effort but the date wasn't very memorable.`; }
  rel.interest=Math.min(100,rel.interest+boost);
  rel.dated=true;
  // Record first date anniversary
  if(G.anniversaries[G.currentNPC]&&!G.anniversaries[G.currentNPC].firstDate){
    G.anniversaries[G.currentNPC].firstDate=G.day;
  }
  // Milestone: first date cutscene
  triggerMilestone(G.currentNPC,'firstDate',`Your First Date with ${NPCS[G.currentNPC].name}!`,
    `The evening was electric. You and ${NPCS[G.currentNPC].name} laughed until the stars came out. Something shifted between you tonight.`,
    'üåü');
  checkAchievements();
  checkEndings(G.currentNPC);
  recordConsequence(G.currentNPC+'_dated');
  gainXP(total*5);
  updateStats(); buildJournal(); saveGame();
  advanceDay();

  // Show result
  showScreen('map-screen');
  setTimeout(()=>{
    showToast(`üíï ${msg}`,4000);
    buildMapScreen();
  },300);
}

// ============================================================
// SHOP
// ============================================================
function buildShop() {
  const discount=G.skills.negotiator?0.8:1;
  document.getElementById('wallet-display').textContent=G.wallet;

  document.getElementById('gift-grid').innerHTML=GIFTS.map(g=>{
    const price=Math.round(g.price*discount);
    const owned=G.inventory.filter(i=>i===g.id).length;
    return `<div class="gift-card ${owned?'owned':''}" onclick="buyGift('${g.id}',${price},${g.boost},'${g.likes.join(',')}')">
      <div class="gift-emoji">${g.emoji}</div>
      <div class="gift-name">${g.name}</div>
      <div class="gift-price">‚Ç¶${price}</div>
      <div class="gift-likes">Fav: ${g.likes.map(id=>NPCS[id]?.name).join(', ')}</div>
      ${owned?`<div style="font-size:10px;color:var(--gold);font-weight:800">Owned: ${owned}</div>`:''}
    </div>`;
  }).join('');

  document.getElementById('activity-list').innerHTML=ACTIVITIES.map(a=>{
    const cost=a.cost;
    return `<div class="activity-card" onclick="doActivity('${a.id}',${cost},${JSON.stringify(a.effect)})">
      <div class="act-icon">${a.emoji}</div>
      <div style="flex:1">
        <div class="act-name">${a.name}</div>
        <div class="act-effect">${a.desc} ‚Ä¢ ${a.time}</div>
      </div>
      <div class="act-cost">${cost>0?'‚Ç¶'+cost:'Free'}</div>
    </div>`;
  }).join('');
}

function buyGift(id,price,boost,likesStr) {
  if(G.wallet<price){ showToast('Not enough money! üí∞'); return; }
  G.wallet-=price;
  G.inventory.push(id);
  giftsBought++;
  if(giftsBought>=3) unlockAchievement('collector');
  document.getElementById('wallet-display').textContent=G.wallet;
  showToast(`üéÅ ${id} bought! Now give it to someone special.`);
  buildShop();
  saveGame();

  // Auto-give gift modal
  const likes=likesStr.split(',');
  const metNPCs=Object.keys(NPCS).filter(nid=>G.relationships[nid]&&G.relationships[nid].met);
  if(metNPCs.length>0){
    const opts=metNPCs.map(nid=>`<button class="btn-secondary" style="max-width:100%" onclick="giveGift('${id}','${nid}',${boost},${likes.includes(nid)})">${NPCS[nid].name} ${getHearts(G.relationships[nid].interest)}</button>`).join('');
    showModal(`<div class="modal-handle"></div><div class="screen-title" style="text-align:center;margin-bottom:16px">üéÅ Give ${id}?</div>${opts}<button class="btn-secondary" onclick="closeModal()">Keep for later</button>`);
  }
}

function giveGift(giftId,npcId,baseBoost,isFav) {
  closeModal();
  const rel=G.relationships[npcId];
  const npc=NPCS[npcId];
  if(!rel.met){ showToast('Meet her first!'); return; }
  const invIdx=G.inventory.indexOf(giftId);
  if(invIdx===-1){ showToast('You don\'t have that gift!'); return; }
  G.inventory.splice(invIdx,1);
  let boost=isFav?baseBoost*2:baseBoost;
  if(G.skills.gift_giver) boost=Math.round(boost*1.5);
  rel.interest=Math.min(100,rel.interest+boost);
  showToast(`${npc.name} loved the gift! +${boost} Interest üíï`);
  buildJournal(); buildShop(); updateStats(); saveGame();
}

function doActivity(id,cost,effectObj) {
  if(G.wallet<cost){ showToast('Not enough money! üí∞'); return; }
  G.wallet-=cost;
  Object.entries(effectObj).forEach(([k,v])=>{
    if(k==='wallet') G.wallet+=v;
    else if(G.stats[k]!==undefined) G.stats[k]=Math.min(100,G.stats[k]+v);
  });
  const effect=Object.entries(effectObj).map(([k,v])=>`+${v} ${k}`).join(', ');
  showToast(`‚úÖ Activity done! ${effect}`);
  if(id==='work'&&G.skills.hustler) G.wallet+=500;
  buildShop(); updateStats(); advanceDay(); saveGame();
}

// ============================================================
// SKILLS
// ============================================================
function buildSkills() {
  document.getElementById('skill-points-display').textContent='SP: '+G.player.skillPoints;
  const categories=[...new Set(SKILLS_TREE.map(s=>s.category))];
  document.getElementById('skills-content').innerHTML=categories.map(cat=>`
    <div class="skill-section">
      <div class="skill-section-title">${cat}</div>
      <div class="skill-grid">
        ${SKILLS_TREE.filter(s=>s.category===cat).map(sk=>{
          const unlocked=G.skills[sk.id];
          const reqMet=!sk.requires||G.skills[sk.requires];
          const locked=!reqMet;
          return `<div class="skill-card ${unlocked?'unlocked':''} ${locked?'locked':''}" onclick="unlockSkill('${sk.id}',${sk.cost})">
            <div class="skill-icon">${sk.icon}</div>
            <div class="skill-name">${sk.name}${unlocked?' ‚úì':''}</div>
            <div class="skill-desc">${sk.desc}</div>
            <div class="skill-cost">${unlocked?'Unlocked ‚úÖ':locked?`Requires: ${SKILLS_TREE.find(s=>s.id===sk.requires)?.name||'?'}`:`Cost: ${sk.cost} SP`}</div>
          </div>`;
        }).join('')}
      </div>
    </div>`).join('');
}

function unlockSkill(id,cost) {
  if(G.skills[id]){ showToast('Already unlocked!'); return; }
  const sk=SKILLS_TREE.find(s=>s.id===id);
  if(!sk) return;
  if(sk.requires&&!G.skills[sk.requires]){ showToast(`Unlock "${SKILLS_TREE.find(s=>s.id===sk.requires)?.name}" first!`); return; }
  if(G.player.skillPoints<cost){ showToast(`Need ${cost} Skill Points! Level up to earn more.`); return; }
  G.player.skillPoints-=cost;
  G.skills[id]=true;
  showToast(`‚ö° Skill Unlocked: ${sk.name}!`);
  const skillCount=Object.values(G.skills).filter(Boolean).length;
  if(skillCount>=5) unlockAchievement('skilled');
  buildSkills(); saveGame();
}

// ============================================================
// JOURNAL
// ============================================================
function buildJournal() {
  document.getElementById('journal-list').innerHTML=Object.values(NPCS).map(npc=>{
    const rel=G.relationships[npc.id]||{met:false,interest:10,memories:[]};
    const stage=getStage(rel.interest);
    const lastMemory=rel.memories&&rel.memories.length>0?rel.memories[rel.memories.length-1]:'No interactions yet';
    return `<div class="npc-journal-card" onclick="visitLocation('${npc.id}')">
      <div class="njc-row">
        <div class="njc-av">${npcSVG(npc)}</div>
        <div style="flex:1">
          <div class="njc-name">${npc.name}, ${npc.age}</div>
          <div class="njc-status">${npc.job} ‚Ä¢ ${rel.met?'Met ‚úì':'Not met yet'}</div>
          <span class="njc-stage ${stage.cls}">${stage.label}</span>
          ${rel.dated?'<span class="njc-stage" style="background:rgba(255,107,157,.3);color:#ff6b9d;margin-left:4px">Dated üíï</span>':''}
        </div>
        <div style="font-size:22px">${getHearts(rel.interest)}</div>
      </div>
      <div class="love-bar-wrap"><div class="love-bar-fill" style="width:${rel.interest}%"></div></div>
      <div class="njc-memory">üí≠ "${lastMemory}"</div>
    </div>`;
  }).join('');
}

// ============================================================
// ACHIEVEMENTS
// ============================================================
function buildAchievements() {
  const earned=Object.keys(G.achievements).length;
  document.getElementById('ach-progress').textContent=`${earned}/${ACHIEVEMENTS_DEF.length}`;
  document.getElementById('ach-grid').innerHTML=ACHIEVEMENTS_DEF.map(a=>
    `<div class="ach-card ${G.achievements[a.id]?'earned':'locked-ach'}">
      <div class="ach-badge">${a.badge}</div>
      <div class="ach-title">${a.title}</div>
      <div class="ach-desc">${a.desc}</div>
    </div>`
  ).join('');
}

// ============================================================
// EVENTS
// ============================================================
function showEvents() {
  document.getElementById('event-content').innerHTML=EVENTS.map(ev=>`
    <div class="event-card" onclick="triggerEvent('${ev.id}')">
      <div class="event-emoji">${ev.emoji}</div>
      <div class="event-title">${ev.title}</div>
      <div class="event-desc">${ev.desc}</div>
      <button class="btn-gold" style="max-width:200px" onclick="triggerEvent('${ev.id}')">Join Event!</button>
    </div>`).join('');
  showScreen('event-screen');
}

function triggerEvent(id) {
  const ev=EVENTS.find(e=>e.id===id);
  if(!ev) return;
  if(ev.bonus.charm) G.stats.charm=Math.min(100,G.stats.charm+ev.bonus.charm);
  if(ev.bonus.allInterest) Object.values(G.relationships).forEach(r=>r.interest=Math.min(100,r.interest+ev.bonus.allInterest));
  gainXP(30);
  showToast(`üéâ ${ev.title} bonus activated!`);
  updateStats(); buildJournal(); saveGame();
  backToMap();
}

// ============================================================
// TIPS
// ============================================================
function buildTips() {
  document.getElementById('tips-content').innerHTML=TIPS_DATA.map(t=>`
    <div class="tip-card">
      <div class="tip-header">
        <div class="tip-icon-big">${t.icon}</div>
        <div class="tip-title">${t.title}</div>
      </div>
      <div class="tip-body">${t.body}</div>
    </div>`).join('');
}

// ============================================================
// MODAL
// ============================================================
function showModal(html) {
  let overlay=document.getElementById('modal-overlay');
  if(!overlay){
    overlay=document.createElement('div');
    overlay.id='modal-overlay';
    overlay.className='modal-overlay';
    overlay.innerHTML=`<div class="modal-sheet" id="modal-sheet"></div>`;
    overlay.addEventListener('click',e=>{ if(e.target===overlay) closeModal(); });
    document.getElementById('app').appendChild(overlay);
  }
  document.getElementById('modal-sheet').innerHTML=html;
  overlay.classList.add('show');
}

function closeModal() {
  const overlay=document.getElementById('modal-overlay');
  if(overlay) overlay.classList.remove('show');
}

// ============================================================
// TAB NAVIGATION
// ============================================================
// switchTab is defined below with full feature support

// ============================================================
// CUTSCENE SYSTEM
// ============================================================
let cutsceneCallback=null;
function showCutscene(emoji,title,text,sub,cb){
  document.getElementById('cutscene-emoji').textContent=emoji;
  document.getElementById('cutscene-title').textContent=title;
  document.getElementById('cutscene-text').textContent=text;
  document.getElementById('cutscene-sub').textContent=sub||'';
  document.getElementById('cutscene-overlay').classList.add('show');
  cutsceneCallback=cb||null;
}
function closeCutscene(){
  document.getElementById('cutscene-overlay').classList.remove('show');
  if(cutsceneCallback){ const cb=cutsceneCallback; cutsceneCallback=null; cb(); }
}

// ============================================================
// MILESTONE SYSTEM
// ============================================================
const MILESTONE_DEFS={
  firstLaugh:  {emoji:'üòÇ',title:'First Laugh Together',text:'Something she said made you both laugh until you couldn\'t breathe. That unguarded moment created an invisible thread between you.'},
  firstFight:  {emoji:'üò§',title:'Your First Disagreement',text:'You disagreed ‚Äî really disagreed. But instead of walking away, you both chose to stay and work through it. That\'s rare.'},
  firstApology:{emoji:'üôè',title:'First Apology',text:'One of you said "I\'m sorry" and meant it. The other received it graciously. Trust grew three sizes that night.'},
  firstDate:   {emoji:'üåü',title:'Your First Date',text:'The evening was electric. Time slipped away unnoticed. Something shifted between you.'},
  metFamily:   {emoji:'üë®‚Äçüë©‚Äçüëß',title:'You Met Her Family',text:'An invitation into someone\'s family is an invitation into their soul. They saw you ‚Äî and you saw them.'},
};

function triggerMilestone(npcId,type,titleOverride,textOverride,emojiOverride){
  if(!G.milestones[npcId]) G.milestones[npcId]={};
  if(G.milestones[npcId][type]) return; // already triggered
  G.milestones[npcId][type]=true;
  const def=MILESTONE_DEFS[type]||{};
  showCutscene(
    emojiOverride||def.emoji||'üíï',
    titleOverride||def.title||'A Moment',
    textOverride||def.text||'',
    '‚Äî Relationship Milestone Unlocked ‚Äî'
  );
  gainXP(20);
  saveGame();
}

// ============================================================
// ANNIVERSARY SYSTEM
// ============================================================
function checkAnniversaries(){
  Object.keys(G.anniversaries).forEach(npcId=>{
    const ann=G.anniversaries[npcId];
    const npc=NPCS[npcId];
    if(!npc) return;
    // First met anniversary (every 7 days)
    if(ann.firstMet && (G.day - ann.firstMet)>0 && (G.day - ann.firstMet) % 7 === 0){
      showToast(`üéÇ It's been ${G.day-ann.firstMet} days since you met ${npc.name}!`,3500);
      G.relationships[npcId].interest=Math.min(100,G.relationships[npcId].interest+5);
    }
    // First date anniversary (every 5 days)
    if(ann.firstDate && (G.day - ann.firstDate)>0 && (G.day - ann.firstDate) % 5 === 0){
      showToast(`üíï ${G.day-ann.firstDate} days since your first date with ${npc.name}! She noticed you remembered üåπ`,4000);
      G.relationships[npcId].interest=Math.min(100,G.relationships[npcId].interest+8);
      gainXP(15);
    }
  });
}

// ============================================================
// JEALOUSY MECHANICS
// ============================================================
function checkJealousy(visitingNpcId){
  if(!G.jealousyLevel) G.jealousyLevel={};
  // Count how many NPCs are at Crush or Partner stage
  const highRelNpcs=Object.keys(G.relationships).filter(id=>{
    return G.relationships[id].interest>=60 && id!==visitingNpcId;
  });
  if(highRelNpcs.length>=2){
    // Jealousy kicks in
    const jLevel=(highRelNpcs.length-1)*15;
    G.jealousyLevel[visitingNpcId]=(G.jealousyLevel[visitingNpcId]||0)+jLevel;
    if(G.jealousyLevel[visitingNpcId]>=30){
      const dropAmount=Math.min(15,Math.floor(G.jealousyLevel[visitingNpcId]/3));
      G.relationships[visitingNpcId].interest=Math.max(20,G.relationships[visitingNpcId].interest-dropAmount);
      const npc=NPCS[visitingNpcId];
      showToast(`üòí ${npc.name} heard you've been close with others... ‚àí${dropAmount} Interest`,3500);
      // Potential breakup event
      if(G.relationships[visitingNpcId].interest<30&&G.relationships[visitingNpcId].dated){
        setTimeout(()=>triggerBreakupEvent(visitingNpcId,'jealousy'),1500);
      }
    }
  }
}

// ============================================================
// BREAKUP & RECONCILIATION
// ============================================================
function triggerBreakupEvent(npcId, reason){
  const npc=NPCS[npcId];
  const rel=G.relationships[npcId];
  const msgs={
    jealousy:`${npc.name} confronts you: "I've heard things. Are you juggling multiple people? I deserve honesty."`,
    neglect:`${npc.name} feels you've been distant. "I thought we had something, but I don't think you're taking this seriously."`,
    conflict:`Things escalated after your last fight. ${npc.name} says: "I need some space to think about this."`,
  };
  document.getElementById('breakup-emoji').textContent='üíî';
  document.getElementById('breakup-title').textContent='Relationship Crisis!';
  document.getElementById('breakup-msg').textContent=msgs[reason]||msgs.conflict;
  document.getElementById('breakup-options').innerHTML=`
    <button class="btn-primary" style="max-width:100%" onclick="handleBreakup('${npcId}','fight')">üí™ Fight for the relationship</button>
    <button class="btn-secondary" style="max-width:100%" onclick="handleBreakup('${npcId}','honest')">üí¨ Be completely honest</button>
    <button class="btn-secondary" style="max-width:100%" onclick="handleBreakup('${npcId}','accept')">üòî Give her space</button>
  `;
  document.getElementById('breakup-overlay').classList.add('show');
  rel.broken=true;
}

function handleBreakup(npcId,choice){
  document.getElementById('breakup-overlay').classList.remove('show');
  const rel=G.relationships[npcId];
  const npc=NPCS[npcId];
  if(choice==='fight'){
    rel.interest=Math.min(100,rel.interest+10);
    rel.broken=false;
    triggerMilestone(npcId,'firstFight','You Fought for Her','You didn\'t run when things got hard. You stayed. That takes real strength ‚Äî and she noticed it.','üí™');
    showToast(`üí™ You stood firm! ${npc.name} respects your commitment. +10 Interest`,3000);
  } else if(choice==='honest'){
    rel.interest=Math.min(100,rel.interest+15);
    rel.broken=false;
    triggerMilestone(npcId,'firstApology','Radical Honesty','You laid it all on the table. No filters. The truth, however imperfect, was the bridge back to each other.','üôè');
    showToast(`üôè Honesty healed the wound! ${npc.name} appreciates your vulnerability. +15 Interest`,3000);
  } else {
    rel.interest=Math.max(10,rel.interest-15);
    showToast(`üòî ${npc.name} needed space... -15 Interest. Reconcile on the phone.`,3000);
  }
  gainXP(25);
  updateStats(); buildJournal(); saveGame();
}

// ============================================================
// NPC-INITIATED EVENTS
// ============================================================
function tryNpcInitiatedText(){
  const metHighInterest=Object.keys(NPCS).filter(id=>{
    const rel=G.relationships[id];
    return rel&&rel.met&&rel.interest>=40&&rel.phoneStep>=2;
  });
  if(metHighInterest.length===0) return;
  const npcId=metHighInterest[Math.floor(Math.random()*metHighInterest.length)];
  const npc=NPCS[npcId];
  const msgs=[
    `Hey! I was just thinking about you üòä`,
    `Are you free later today? I want to show you something!`,
    `I made extra jollof... just saying üëÄ`,
    `You've been on my mind. Is that weird? üòÖ`,
    `I saw something today and immediately thought of you.`,
  ];
  const msg=msgs[Math.floor(Math.random()*msgs.length)];
  document.getElementById('npc-text-avatar').innerHTML=npcSVG(npc);
  document.getElementById('npc-text-name').textContent=npc.name;
  document.getElementById('npc-text-msg').textContent=msg;
  const popup=document.getElementById('npc-text-popup');
  popup.classList.add('show');
  popup.dataset.npcId=npcId;
  // Boost interest for the reach-out
  G.relationships[npcId].interest=Math.min(100,G.relationships[npcId].interest+3);
  setTimeout(()=>dismissNpcText(),8000);
}

function dismissNpcText(){
  document.getElementById('npc-text-popup').classList.remove('show');
}

// ============================================================
// MEET THE FAMILY
// ============================================================
const FAMILY_DATA={
  chiamaka:{
    intro:'Chiamaka has invited you to Sunday lunch with her family in Surulere. Her parents are old-school and traditional. First impressions matter greatly here.',
    members:[
      {id:'mama',emoji:'üë©‚Äçü¶≥',name:'Mama Chiamaka',role:'Mother',
       questions:['What are your intentions with my daughter?','Do you go to church?','Can you provide for a family?'],
       goodAnswers:[0,0,1], attitude:'skeptical'},
      {id:'papa',emoji:'üë¥',name:'Chief Okafor',role:'Father',
       questions:['What is your profession?','Do you respect tradition?','Why should I trust you with my daughter?'],
       goodAnswers:[0,1,0], attitude:'hostile'},
      {id:'sister',emoji:'üëß',name:'Adaeze',role:'Little Sister',
       questions:['Do you make her laugh?','Are you nice to people?','Do you like peppered snail?'],
       goodAnswers:[0,1,2], attitude:'neutral'},
    ]
  },
  amaka:{
    intro:'Amaka\'s progressive family invites you to a dinner debate. Her parents are both lawyers ‚Äî they will test your intellect and values mercilessly.',
    members:[
      {id:'mama',emoji:'üë©‚Äç‚öñÔ∏è',name:'Barrister Stella',role:'Mother / Lawyer',
       questions:['What do you think about gender equality in Nigeria?','How do you handle conflict?','What drives you?'],
       goodAnswers:[0,0,1], attitude:'skeptical'},
      {id:'papa',emoji:'üë®‚Äç‚öñÔ∏è',name:'Senior Counsel Emmanuel',role:'Father / SAN',
       questions:['What are your five-year plans?','How do you view women\'s careers?','Tell me about a mistake you made.'],
       goodAnswers:[1,0,2], attitude:'neutral'},
    ]
  },
  ngozi:{
    intro:'Ngozi rarely brings people home. The fact that she\'s inviting you signals serious consideration. Her brother runs a startup and will quiz you on technology.',
    members:[
      {id:'mama',emoji:'üë©',name:'Mama Ngozi',role:'Mother',
       questions:['Are you ambitious?','Do you support her career goals?','Can you keep up with her?'],
       goodAnswers:[0,0,1], attitude:'neutral'},
      {id:'brother',emoji:'üë®‚Äçüíª',name:'Chukwuemeka',role:'Big Brother (Tech CEO)',
       questions:['What\'s your view on Web3?','How do you handle failure?','Why should smart women settle down?'],
       goodAnswers:[1,0,2], attitude:'skeptical'},
    ]
  },
};

function showMeetFamily(npcId){
  const rel=G.relationships[npcId];
  if(!rel||rel.interest<85){
    showToast('Reach Partner level (85+ interest) to meet her family! üíï');
    return;
  }
  const familyDef=FAMILY_DATA[npcId];
  if(!familyDef){ showToast('Coming soon for this character!'); return; }

  document.getElementById('family-screen-title').textContent=`Meet ${NPCS[npcId].name}'s Family üë®‚Äçüë©‚Äçüëß`;
  document.getElementById('family-intro').textContent=familyDef.intro;

  if(!G.familyVisits[npcId]) G.familyVisits[npcId]={};

  document.getElementById('family-members').innerHTML=familyDef.members.map(m=>{
    const visited=G.familyVisits[npcId][m.id];
    const attitudeCls=visited?visited:'neutral';
    return `<div class="family-member ${attitudeCls}" onclick="talkToFamilyMember('${npcId}','${m.id}')">
      <div class="fm-row">
        <div class="fm-emoji">${m.emoji}</div>
        <div style="flex:1">
          <div class="fm-name">${m.name}</div>
          <div class="fm-role">${m.role}</div>
        </div>
        <div style="font-size:20px">${visited==='approved'?'‚úÖ':visited==='skeptical'?'ü§®':visited==='hostile'?'üò†':'ü§ù'}</div>
      </div>
      <div class="fm-attitude ${visited==='approved'?'good':visited==='hostile'?'bad':'neutral'}">${visited==='approved'?'Approves of you!':visited==='hostile'?'Not impressed yet':visited==='skeptical'?'Warming up slowly':'Not spoken yet'}</div>
    </div>`;
  }).join('');

  document.getElementById('family-result').style.display='none';
  G.currentNPC=npcId;
  showScreen('family-screen');
}

function talkToFamilyMember(npcId,memberId){
  const familyDef=FAMILY_DATA[npcId];
  if(!familyDef) return;
  const member=familyDef.members.find(m=>m.id===memberId);
  if(!member) return;

  const q=member.questions[Math.floor(Math.random()*member.questions.length)];
  const qIdx=member.questions.indexOf(q);
  const isGoodChoice=member.goodAnswers[qIdx];

  // Create answer options
  const answers=[
    {text:'Be sincere and thoughtful in your response',good:true},
    {text:'Give a generic, non-committal answer',good:false},
    {text:'Show genuine interest back ‚Äî ask about them',good:isGoodChoice===1||isGoodChoice===2},
  ];

  showModal(`
    <div class="modal-handle"></div>
    <div style="font-size:32px;text-align:center;margin-bottom:8px">${member.emoji}</div>
    <div style="font-family:'Baloo 2',cursive;font-size:15px;color:var(--gold);font-weight:800;text-align:center;margin-bottom:6px">${member.name}</div>
    <div style="color:rgba(255,255,255,.8);font-size:13px;text-align:center;margin-bottom:14px;line-height:1.5">"${q}"</div>
    ${answers.map((a,i)=>`<button class="btn-secondary" style="max-width:100%;text-align:left;padding:10px 14px;margin-bottom:6px" onclick="answerFamilyMember('${npcId}','${memberId}',${a.good})">${i===0?'üí¨':i===1?'ü§∑':'ü§ù'} ${a.text}</button>`).join('')}
  `);
}

function answerFamilyMember(npcId,memberId,isGood){
  closeModal();
  if(!G.familyVisits[npcId]) G.familyVisits[npcId]={};

  const rel=G.relationships[npcId];
  let attitude,interestBoost,toast;
  if(isGood){
    attitude='approved';
    interestBoost=12;
    toast='üåü They loved your answer! +12 Interest';
  } else {
    attitude='skeptical';
    interestBoost=3;
    toast='ü§î They seem unconvinced... try again with a different approach.';
  }
  G.familyVisits[npcId][memberId]=attitude;
  rel.interest=Math.min(100,rel.interest+interestBoost);

  // Check if all family members approved
  const familyDef=FAMILY_DATA[npcId];
  const allApproved=familyDef.members.every(m=>G.familyVisits[npcId][m.id]==='approved');
  if(allApproved){
    triggerMilestone(npcId,'metFamily',`${NPCS[npcId].name}'s Family Approves!`,
      `Every member of her family gave their blessing. In Nigerian culture, this is everything. The path forward is clear.`,'üë®‚Äçüë©‚Äçüëß');
    rel.interest=Math.min(100,rel.interest+20);
    unlockAchievement&&unlockAchievement('family_approved');
    document.getElementById('family-result').style.display='block';
    document.getElementById('family-result').innerHTML=`<div style="font-size:36px">üéä</div><div style="font-family:'Baloo 2',cursive;font-size:16px;color:var(--gold);font-weight:800">Family Fully Approved!</div><div style="color:rgba(255,255,255,.7);font-size:12px;margin-top:6px">+20 bonus interest earned! The family loves you.</div>`;
  }

  showToast(toast,3000);
  updateStats(); buildJournal(); saveGame();
  // Refresh family screen
  showMeetFamily(npcId);
}

// ============================================================
// JOURNAL: add Meet Family button
// ============================================================
const _origBuildJournal=buildJournal;
function buildJournal(){
  document.getElementById('journal-list').innerHTML=Object.values(NPCS).map(npc=>{
    const rel=G.relationships[npc.id]||{met:false,interest:10,memories:[]};
    const stage=getStage(rel.interest);
    const lastMemory=rel.memories&&rel.memories.length>0?rel.memories[rel.memories.length-1]:'No interactions yet';
    const ms=G.milestones[npc.id]||{};
    const msPips=[
      {key:'firstLaugh',emoji:'üòÇ'},{key:'firstFight',emoji:'üò§'},{key:'firstApology',emoji:'üôè'},
      {key:'firstDate',emoji:'üåü'},{key:'metFamily',emoji:'üë®‚Äçüë©‚Äçüëß'},
    ];
    const canMeetFamily=rel.interest>=85&&FAMILY_DATA[npc.id];
    return `<div class="npc-journal-card" data-npcid="${npc.id}">
      <div class="njc-row" onclick="visitLocation('${npc.id}')">
        <div class="njc-av">${npcSVG(npc)}</div>
        <div style="flex:1">
          <div class="njc-name">${npc.name}, ${npc.age}</div>
          <div class="njc-status">${npc.job} ‚Ä¢ ${rel.met?'Met ‚úì':'Not met yet'}</div>
          <span class="njc-stage ${stage.cls}">${stage.label}</span>
          ${rel.dated?'<span class="njc-stage" style="background:rgba(255,107,157,.3);color:#ff6b9d;margin-left:4px">Dated üíï</span>':''}
          ${rel.broken?'<span class="njc-stage" style="background:rgba(231,76,60,.3);color:#ff6b6b;margin-left:4px">üíî Crisis</span>':''}
        </div>
        <div style="font-size:22px">${getHearts(rel.interest)}</div>
      </div>
      <div class="love-bar-wrap"><div class="love-bar-fill" style="width:${rel.interest}%"></div></div>
      <div class="milestone-row">${msPips.map(p=>`<div class="milestone-pip ${ms[p.key]?'done':''}" title="${p.key}">${ms[p.key]?p.emoji:'¬∑'}</div>`).join('')}</div>
      <div class="njc-memory">üí≠ "${lastMemory}"</div>
      ${canMeetFamily?`<button class="btn-gold" style="max-width:100%;margin-top:8px;padding:8px" onclick="showMeetFamily('${npc.id}')">üë®‚Äçüë©‚Äçüëß Meet the Family!</button>`:''}
    </div>`;
  }).join('');
}

// ============================================================
// RHYTHM MINI-GAME (Suya Date & Dance-off)
// ============================================================
let rhythmInterval, rhythmNoteInterval, rhythmState={};
const RHYTHM_CONFIGS={
  suya:{title:'üç¢ Suya Date Night!',sub:'Fan the coals to the beat! Tap the lane when notes reach the ring!',lanes:['üî•','üå∂Ô∏è','ü•©','üßÖ'],color:'#FF6B35',tempo:800},
  dance:{title:'üíÉ Afrobeats Dance-Off!',sub:'Match the moves! Hit the beats as they drop!',lanes:['üï∫','üíÉ','üôå','‚ú®'],color:'#FF6B9D',tempo:700},
};

function startRhythmGame(mode){
  mode=mode||'suya';
  G.activeMinigame='rhythm';
  const cfg=RHYTHM_CONFIGS[mode]||RHYTHM_CONFIGS.suya;
  document.getElementById('rhythm-title').textContent=cfg.title;
  document.getElementById('rhythm-sub').textContent=cfg.sub;

  rhythmState={score:0,combo:0,misses:0,hits:0,total:0,mode,cfg,active:true,timeLeft:20};
  document.getElementById('rhythm-combo').textContent='0x';
  document.getElementById('rhythm-score-val').textContent='0';
  document.getElementById('rhythm-acc-fill').style.width='100%';
  document.getElementById('rhythm-timer-display').textContent='20s';

  // Build lanes
  const lanesEl=document.getElementById('rhythm-lanes');
  lanesEl.innerHTML=cfg.lanes.map((emoji,i)=>`
    <div class="rhythm-lane" id="rl-${i}" onclick="hitRhythmLane(${i})">
      <div class="rhythm-hit-zone" id="rhz-${i}">${emoji}</div>
    </div>`).join('');

  document.getElementById('rhythm-game').classList.add('show');

  // Countdown
  let cd=3; document.getElementById('rhythm-timer-display').textContent='Get ready: '+cd;
  const cdInt=setInterval(()=>{
    cd--;
    if(cd>0) document.getElementById('rhythm-timer-display').textContent='Get ready: '+cd;
    else{
      clearInterval(cdInt);
      runRhythmGame(cfg);
    }
  },800);
}

function runRhythmGame(cfg){
  rhythmState.active=true;
  let timeLeft=20;
  rhythmInterval=setInterval(()=>{
    timeLeft--;
    rhythmState.timeLeft=timeLeft;
    document.getElementById('rhythm-timer-display').textContent=timeLeft+'s remaining';
    if(timeLeft<=0){ clearInterval(rhythmInterval); clearInterval(rhythmNoteInterval); endRhythmGame(true); }
  },1000);

  // Spawn notes
  rhythmNoteInterval=setInterval(()=>{
    if(!rhythmState.active) return;
    const lane=Math.floor(Math.random()*cfg.lanes.length);
    spawnNote(lane,cfg);
  },cfg.tempo);
}

function spawnNote(lane,cfg){
  const laneEl=document.getElementById('rl-'+lane);
  if(!laneEl) return;
  const note=document.createElement('div');
  note.className='rhythm-note';
  note.style.background=cfg.color;
  note.style.left='50%';
  note.style.transform='translateX(-50%)';
  note.style.animationDuration='1.2s';
  note.textContent=cfg.lanes[lane];
  note.dataset.lane=lane;
  note.dataset.spawnTime=Date.now();
  laneEl.insertBefore(note,laneEl.firstChild);
  rhythmState.total++;

  // Auto-miss after note falls through
  setTimeout(()=>{
    if(note.parentNode){
      note.remove();
      rhythmState.misses++;
      rhythmState.combo=0;
      document.getElementById('rhythm-combo').textContent='0x';
      updateRhythmAccuracy();
    }
  },1300);
}

function hitRhythmLane(laneIdx){
  if(!rhythmState.active) return;
  const laneEl=document.getElementById('rl-'+laneIdx);
  const notes=laneEl.querySelectorAll('.rhythm-note');
  if(notes.length===0) return; // miss (no note in lane)

  // Find the lowest (closest to hit zone) note
  const note=notes[notes.length-1];
  const age=Date.now()-parseInt(note.dataset.spawnTime);
  let feedback,points;
  if(age>=700&&age<1100){ feedback='PERFECT! üî•'; points=30; }
  else if(age>=500){ feedback='GOOD! ‚ú®'; points=15; }
  else { feedback='EARLY üò¨'; points=5; }

  note.remove();
  rhythmState.hits++;
  rhythmState.combo++;
  rhythmState.score+=points*(1+Math.floor(rhythmState.combo/5)*0.5);

  document.getElementById('rhythm-combo').textContent=rhythmState.combo+'x';
  document.getElementById('rhythm-score-val').textContent=Math.round(rhythmState.score);
  updateRhythmAccuracy();
  showRhythmFeedback(feedback,laneIdx);

  // Flash hit zone
  const hz=document.getElementById('rhz-'+laneIdx);
  if(hz){ hz.classList.add('flash'); setTimeout(()=>hz.classList.remove('flash'),200); }
}

function showRhythmFeedback(text,lane){
  const fb=document.getElementById('rhythm-feedback');
  const laneEl=document.getElementById('rl-'+lane);
  if(!laneEl) return;
  fb.textContent=text;
  fb.style.color=text.includes('PERFECT')?'#FFD700':text.includes('GOOD')?'#00b86b':'#FF6B35';
  fb.style.top=(Math.random()*40+20)+'%';
  fb.classList.remove('show');
  void fb.offsetWidth;
  fb.classList.add('show');
}

function updateRhythmAccuracy(){
  const total=rhythmState.hits+rhythmState.misses;
  const acc=total===0?100:Math.round((rhythmState.hits/total)*100);
  document.getElementById('rhythm-acc-fill').style.width=acc+'%';
}

function endRhythmGame(success){
  clearInterval(rhythmInterval);
  clearInterval(rhythmNoteInterval);
  rhythmState.active=false;
  document.getElementById('rhythm-game').classList.remove('show');
  G.activeMinigame=null;

  const rel=G.relationships[G.currentNPC];
  const npc=NPCS[G.currentNPC];
  if(!success){ G.stats.charm=Math.max(0,G.stats.charm-5); showToast('üòÖ Skipped the beat... ‚àí5 Charm'); updateStats(); showDialogue(G.dialogueStep); return; }
  
  updateChallengeProgress('minigame',G.currentNPC);

  const score=rhythmState.score;
  let boost,toast;
  if(score>=200){ boost=25; toast=`üî• FIRE performance! ${npc.name} is blown away! +25 Interest`; G.stats.charm=Math.min(100,G.stats.charm+20); }
  else if(score>=100){ boost=15; toast=`‚ú® Great rhythm! ${npc.name} loved it! +15 Interest`; G.stats.charm=Math.min(100,G.stats.charm+10); }
  else { boost=8; toast=`üòä Not bad! ${npc.name} had fun! +8 Interest`; G.stats.charm=Math.min(100,G.stats.charm+5); }

  rel.interest=Math.min(100,rel.interest+boost);
  showToast(toast,3000);
  updateStats();
  if(rhythmState.mode==='dance') triggerMilestone(G.currentNPC,'firstLaugh','You Danced Together!','Bodies moving in sync, laughter erupting between wrong moves and perfect ones. A night neither of you will forget.','üíÉ');
  const lang=G.player.lang; const dialogues=npc.dialogue[lang]||npc.dialogue.english;
  showDialogue(Math.min(3,dialogues.length-1));
}

// ============================================================
// JOLLOF COOK-OFF
// ============================================================
const COOKOFF_STEPS=[
  {emoji:'üßÖ',text:'Blend peppers, tomatoes and onions',correct:true,order:1},
  {emoji:'ü´ô',text:'Pour in the tomato paste and season',correct:true,order:2},
  {emoji:'ü•ò',text:'Fry the blended mix in hot oil until the colour darkens',correct:true,order:3},
  {emoji:'üå∂Ô∏è',text:'Add stock/water and bring to a boil',correct:true,order:4},
  {emoji:'üçö',text:'Pour in the parboiled rice and steam on low heat',correct:true,order:5},
  {emoji:'ü§§',text:'Add jollof seasoning and taste!',correct:false,order:0}, // Wrong placement
  {emoji:'ü´í',text:'Skip the frying ‚Äî just pour everything in at once',correct:false,order:0},
];

let cookoffState={step:0,score:0,wrong:0};
function startCookoffGame(){
  G.activeMinigame='cookoff';
  cookoffState={step:0,score:0,wrong:0};
  document.getElementById('cookoff-game').classList.add('show');
  renderCookoffStep();
}

function renderCookoffStep(){
  const correctSteps=COOKOFF_STEPS.filter(s=>s.correct).sort(()=>Math.random()-.5);
  const wrongSteps=COOKOFF_STEPS.filter(s=>!s.correct);
  const pool=[...correctSteps.slice(0,3),...wrongSteps].sort(()=>Math.random()-.5);

  // Highlight the correct next step
  const targetOrder=cookoffState.step+1;
  const instruction=`Step ${targetOrder}/5: What happens next?`;
  document.getElementById('cookoff-instruction').textContent=instruction;

  // Progress pips
  document.getElementById('cookoff-progress').innerHTML=Array.from({length:5},(_,i)=>
    `<div class="cookoff-pip ${i<cookoffState.step?'done':''}"></div>`).join('');

  document.getElementById('cookoff-steps').innerHTML=pool.map((step,i)=>`
    <div class="cookoff-step" onclick="selectCookoffStep(this,${step.correct&&step.order===targetOrder})">
      <div class="cookoff-emoji">${step.emoji}</div>
      <div class="cookoff-text">${step.text}</div>
    </div>`).join('');
}

function selectCookoffStep(el,isCorrect){
  el.classList.add(isCorrect?'correct':'wrong');
  el.classList.add('completed');
  setTimeout(()=>{
    if(isCorrect){
      cookoffState.step++;
      cookoffState.score+=20;
      if(cookoffState.step>=5){ endCookoff(true); return; }
      renderCookoffStep();
    } else {
      cookoffState.wrong++;
      cookoffState.score=Math.max(0,cookoffState.score-10);
      if(cookoffState.wrong>=3){ endCookoff(true); return; }
      el.style.opacity='0.4';
      showToast('üö´ That\'s not the right step! Try again.');
    }
  },600);
}

function endCookoff(success){
  document.getElementById('cookoff-game').classList.remove('show');
  G.activeMinigame=null;
  const rel=G.relationships[G.currentNPC];
  const npc=NPCS[G.currentNPC];
  if(!success){ G.stats.charm=Math.max(0,G.stats.charm-5); showToast('üçö The jollof burned a little...'); updateStats(); showDialogue(G.dialogueStep); return; }
  const s=cookoffState.score;
  let boost,toast;
  if(s>=90){ boost=28; toast=`üçö PARTY JOLLOF! ${npc.name} is impressed ‚Äî she wants the recipe! +28 Interest`; }
  else if(s>=60){ boost=18; toast=`üë®‚Äçüç≥ Good cooking! ${npc.name} enjoyed it! +18 Interest`; }
  else { boost=8; toast=`üòÖ Decent effort... ${npc.name} appreciated the try. +8 Interest`; }
  rel.interest=Math.min(100,rel.interest+boost);
  G.stats.charm=Math.min(100,G.stats.charm+10);
  showToast(toast,3500);
  triggerMilestone(G.currentNPC,'firstLaugh','Jollof Wars!','You cooked together, argued about seasoning, and laughed the whole time. That\'s the kind of memory that stays.','üçö');
  updateStats();
  const lang=G.player.lang; const dialogues=npc.dialogue[lang]||npc.dialogue.english;
  showDialogue(Math.min(3,dialogues.length-1));
}

// ============================================================
// PHOTO GAME (Bisi)
// ============================================================
let photoState={shots:5,score:0,reticleX:90,reticleY:90};
let photoSubjectInterval;
function startPhotoGame(){
  G.activeMinigame='photo';
  photoState={shots:5,score:0,reticleX:90,reticleY:90};
  document.getElementById('photo-shots').textContent=5;
  document.getElementById('photo-score-display').textContent=0;
  document.getElementById('photo-game').classList.add('show');

  // Random subjects for Bisi's photoshoot
  const subjects=['üåÜ','üåÖ','üèôÔ∏è','üå¥','üíÉ','ü¶Ö'];
  const subEl=document.getElementById('photo-subject');
  const vf=document.getElementById('photo-viewfinder');

  function moveSubject(){
    const x=Math.floor(Math.random()*200);
    const y=Math.floor(Math.random()*200);
    subEl.style.left=x+'px'; subEl.style.top=y+'px';
    subEl.textContent=subjects[Math.floor(Math.random()*subjects.length)];
  }
  moveSubject();
  photoSubjectInterval=setInterval(moveSubject,2000);

  // Reticle dragging
  vf.addEventListener('pointermove',onPhotoPointer);
  vf.addEventListener('touchmove',onPhotoTouch,{passive:false});

  // Criteria
  document.getElementById('photo-criteria-row').innerHTML=[
    {id:'pct-centered',label:'Well Centered'},
    {id:'pct-light',label:'Good Lighting'},
    {id:'pct-timing',label:'Right Moment'},
  ].map(c=>`<div class="photo-criteria" id="${c.id}">${c.label}</div>`).join('');
}

function onPhotoPointer(e){
  const vf=document.getElementById('photo-viewfinder');
  const rect=vf.getBoundingClientRect();
  photoState.reticleX=Math.max(0,Math.min(200,e.clientX-rect.left-30));
  photoState.reticleY=Math.max(0,Math.min(200,e.clientY-rect.top-30));
  const r=document.getElementById('photo-reticle');
  if(r){ r.style.left=photoState.reticleX+'px'; r.style.top=photoState.reticleY+'px'; }
}
function onPhotoTouch(e){
  e.preventDefault();
  if(e.touches[0]) onPhotoPointer(e.touches[0]);
}

function snapPhoto(){
  if(photoState.shots<=0){ endPhotoGame(true); return; }
  photoState.shots--;
  document.getElementById('photo-shots').textContent=photoState.shots;

  // Score based on centering
  const subEl=document.getElementById('photo-subject');
  const sx=parseInt(subEl.style.left)||90, sy=parseInt(subEl.style.top)||90;
  const dist=Math.sqrt(Math.pow(photoState.reticleX-sx,2)+Math.pow(photoState.reticleY-sy,2));
  const centered=dist<50;
  const lightBonus=Math.random()>0.3; // random lighting
  const timing=Math.random()>0.4;

  document.getElementById('pct-centered').className='photo-criteria'+(centered?' met':'');
  document.getElementById('pct-light').className='photo-criteria'+(lightBonus?' met':'');
  document.getElementById('pct-timing').className='photo-criteria'+(timing?' met':'');

  const shotScore=(centered?40:0)+(lightBonus?30:0)+(timing?30:0);
  photoState.score+=shotScore;
  document.getElementById('photo-score-display').textContent=Math.round(photoState.score/(5-photoState.shots+1));

  // Flash effect
  const vf=document.getElementById('photo-viewfinder');
  vf.style.background='rgba(255,255,255,.4)';
  setTimeout(()=>{vf.style.background='rgba(255,255,255,.03)';},120);

  if(photoState.shots<=0) setTimeout(()=>endPhotoGame(true),500);
}

function endPhotoGame(success){
  clearInterval(photoSubjectInterval);
  const vf=document.getElementById('photo-viewfinder');
  vf.removeEventListener('pointermove',onPhotoPointer);
  document.getElementById('photo-game').classList.remove('show');
  G.activeMinigame=null;

  const rel=G.relationships[G.currentNPC];
  const npc=NPCS[G.currentNPC];
  if(!success){ G.stats.charm=Math.max(0,G.stats.charm-5); showToast('üì∑ Session ended early.'); updateStats(); showDialogue(G.dialogueStep); return; }

  const avgScore=photoState.score/5;
  let boost,toast;
  if(avgScore>=70){ boost=25; toast=`üì∏ Stunning shots! Bisi is amazed by your eye! +25 Interest`; }
  else if(avgScore>=40){ boost=15; toast=`üì∑ Good work! Bisi liked your compositions! +15 Interest`; }
  else { boost=8; toast=`ü§≥ You tried! Bisi appreciated the effort. +8 Interest`; }

  rel.interest=Math.min(100,rel.interest+boost);
  G.stats.intelligence=Math.min(100,G.stats.intelligence+8);
  showToast(toast,3000);
  updateStats();
  const lang=G.player.lang; const dialogues=npc.dialogue[lang]||npc.dialogue.english;
  showDialogue(Math.min(3,dialogues.length-1));
}

// ============================================================
// LEGAL DEBATE GAME (Amaka)
// ============================================================
const DEBATE_CASES=[
  {title:'Case: Workplace Gender Quotas',text:'Amaka argues that mandatory quotas for women in leadership are essential. You must defend or challenge this thoughtfully.',
   args:[
    {text:'Quotas alone don\'t build culture ‚Äî mentorship, equal pay, and bias training work together.',strength:3,type:'strong'},
    {text:'I fully support quotas ‚Äî women are obviously better leaders anyway.',strength:0,type:'weak'},
    {text:'The data shows underrepresentation is systemic ‚Äî quotas correct historical imbalance.',strength:3,type:'strong'},
    {text:'Merit should be the only criterion ‚Äî quotas are unfair to qualified men.',strength:1,type:'weak'},
   ]},
  {title:'Case: Customary Law vs Statutory Law',text:'There\'s a conflict between a traditional land tenure custom and a woman\'s statutory inheritance rights. Amaka prosecutes. You defend.',
   args:[
    {text:'Statutory law is supreme under the Constitution ‚Äî customary law cannot override fundamental rights.',strength:3,type:'strong'},
    {text:'Tradition has value ‚Äî we should respect both systems equally.',strength:1,type:'weak'},
    {text:'This case requires the court to examine whether the custom violates Section 42 of CFRN.',strength:3,type:'strong'},
    {text:'The law is the law ‚Äî end of discussion.',strength:0,type:'weak'},
   ]},
  {title:'Case: Ethics of Plea Bargaining',text:'A politician offers to return stolen funds if charges are reduced. Amaka opposes. You must argue the merit.',
   args:[
    {text:'Plea bargaining is pragmatic ‚Äî it guarantees recovery of funds and saves judicial time.',strength:2,type:'strong'},
    {text:'Corruption must never be rewarded. No deal.',strength:2,type:'strong'},
    {text:'We should let the people decide via referendum.',strength:0,type:'weak'},
    {text:'The prosecution should extract maximum penalty as deterrence.',strength:1,type:'weak'},
   ]},
];

let debateState={round:0,yourScore:0,oppScore:0};
function startDebateGame(){
  G.activeMinigame='debate';
  debateState={round:0,yourScore:0,oppScore:0};
  document.getElementById('debate-game').classList.add('show');
  renderDebateRound();
}

function renderDebateRound(){
  const round=debateState.round;
  if(round>=3){ endDebateGame(true); return; }
  const cas=DEBATE_CASES[round];
  document.getElementById('debate-round').textContent=`${round+1}/3`;
  document.getElementById('debate-your-score').textContent=debateState.yourScore;
  document.getElementById('debate-opp-score').textContent=debateState.oppScore;
  document.getElementById('debate-case-title').textContent=cas.title;
  document.getElementById('debate-case-text').textContent=cas.text;

  const shuffled=[...cas.args].sort(()=>Math.random()-.5);
  document.getElementById('debate-args').innerHTML=shuffled.map((arg,i)=>
    `<div class="debate-arg ${arg.type}" onclick="selectDebateArg(this,${arg.strength})">${arg.text}</div>`
  ).join('');
}

function selectDebateArg(el,strength){
  document.querySelectorAll('.debate-arg').forEach(a=>{a.style.pointerEvents='none';});
  if(strength>=2){
    el.classList.add('selected-good');
    debateState.yourScore+=strength;
    showToast(`‚öñÔ∏è Strong argument! +${strength} points`);
  } else {
    el.classList.add('selected-bad');
    debateState.oppScore+=3-strength;
    showToast('üò¨ Amaka countered that! She scores a point.');
  }
  // Amaka scores randomly
  const oppGain=Math.floor(Math.random()*2);
  debateState.oppScore+=oppGain;

  setTimeout(()=>{
    debateState.round++;
    renderDebateRound();
  },1200);
}

function endDebateGame(success){
  document.getElementById('debate-game').classList.remove('show');
  G.activeMinigame=null;
  const rel=G.relationships[G.currentNPC];
  const npc=NPCS[G.currentNPC];

  if(!success){ G.stats.charm=Math.max(0,G.stats.charm-5); showToast('‚öñÔ∏è Conceded the debate.'); updateStats(); showDialogue(G.dialogueStep); return; }

  const won=debateState.yourScore>debateState.oppScore;
  const tied=debateState.yourScore===debateState.oppScore;
  let boost,toast;
  if(won){ boost=28; toast=`‚öñÔ∏è You won the debate! Amaka is genuinely impressed! +28 Interest`; G.stats.intelligence=Math.min(100,G.stats.intelligence+15); }
  else if(tied){ boost=18; toast=`‚öñÔ∏è A draw! Amaka respects a worthy opponent. +18 Interest`; G.stats.intelligence=Math.min(100,G.stats.intelligence+8); }
  else { boost=10; toast=`üòÖ Amaka won, but she enjoyed the sparring! +10 Interest`; G.stats.intelligence=Math.min(100,G.stats.intelligence+5); }

  rel.interest=Math.min(100,rel.interest+boost);
  showToast(toast,3500);
  updateStats();
  const lang=G.player.lang; const dialogues=npc.dialogue[lang]||npc.dialogue.english;
  showDialogue(Math.min(3,dialogues.length-1));
}

// ============================================================
// CHESS GAME (Ngozi)
// ============================================================
// Simplified 8x8 chess with legal-enough moves for gameplay
const CHESS_PIECES={
  wK:'‚ôî',wQ:'‚ôï',wR:'‚ôñ',wB:'‚ôó',wN:'‚ôò',wP:'‚ôô',
  bK:'‚ôö',bQ:'‚ôõ',bR:'‚ôú',bB:'‚ôù',bN:'‚ôû',bP:'‚ôü',
};
let chessState={};

function initChessBoard(){
  const b=Array(8).fill(null).map(()=>Array(8).fill(null));
  // Black pieces (top)
  b[0]=['bR','bN','bB','bQ','bK','bB','bN','bR'];
  b[1]=Array(8).fill('bP');
  // White pieces (bottom)
  b[7]=['wR','wN','wB','wQ','wK','wB','wN','wR'];
  b[6]=Array(8).fill('wP');
  return b;
}

function startChessGame(){
  G.activeMinigame='chess';
  chessState={
    board:initChessBoard(),
    selected:null,
    turn:'w',
    captures:{w:[],b:[]},
    movesCount:0,
    gameOver:false,
  };
  document.getElementById('chess-game').classList.add('show');
  renderChessBoard();
}

function renderChessBoard(){
  const {board,selected,turn}=chessState;
  const possible=selected?getPossibleMoves(selected[0],selected[1]):[];
  const possibleSet=new Set(possible.map(([r,c])=>r+','+c));

  let html='';
  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      const light=(r+c)%2===0;
      const piece=board[r][c];
      const isSel=selected&&selected[0]===r&&selected[1]===c;
      const isPoss=possibleSet.has(r+','+c);
      html+=`<div class="chess-cell ${light?'light':'dark'} ${isSel?'selected':''} ${isPoss?'possible-move':''}"
        onclick="chessClick(${r},${c})">${piece?CHESS_PIECES[piece]||'':''}`;
      if(isPoss&&!piece) html+=`<div style="width:12px;height:12px;border-radius:50%;background:rgba(0,0,0,.3);position:absolute;"></div>`;
      html+='</div>';
    }
  }
  document.getElementById('chess-board').innerHTML=html;
  document.getElementById('chess-status').textContent=chessState.turn==='w'?'Your move (White ‚ôî)':'Ngozi thinking... ‚ôö';
  document.getElementById('chess-captures').innerHTML=
    chessState.captures.w.map(p=>`<span>${CHESS_PIECES[p]||''}</span>`).join('')+
    '<span style="margin:0 6px;color:rgba(255,255,255,.3)">|</span>'+
    chessState.captures.b.map(p=>`<span>${CHESS_PIECES[p]||''}</span>`).join('');
}

function getPossibleMoves(row,col){
  const {board}=chessState;
  const piece=board[row][col];
  if(!piece) return [];
  const color=piece[0];
  const type=piece[1];
  const moves=[];

  const inBounds=(r,c)=>r>=0&&r<8&&c>=0&&c<8;
  const friendly=(r,c)=>board[r][c]&&board[r][c][0]===color;
  const slide=(dr,dc)=>{
    let r=row+dr, c=col+dc;
    while(inBounds(r,c)){
      if(friendly(r,c)) break;
      moves.push([r,c]);
      if(board[r][c]) break; // capture and stop
      r+=dr; c+=dc;
    }
  };

  if(type==='P'){
    const dir=color==='w'?-1:1;
    const startRow=color==='w'?6:1;
    if(inBounds(row+dir,col)&&!board[row+dir][col]) moves.push([row+dir,col]);
    if(row===startRow&&!board[row+dir][col]&&!board[row+2*dir][col]) moves.push([row+2*dir,col]);
    [[row+dir,col-1],[row+dir,col+1]].forEach(([r,c])=>{if(inBounds(r,c)&&board[r][c]&&board[r][c][0]!==color) moves.push([r,c]);});
  }
  if(type==='R'||type==='Q'){[[0,1],[0,-1],[1,0],[-1,0]].forEach(([dr,dc])=>slide(dr,dc));}
  if(type==='B'||type==='Q'){[[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([dr,dc])=>slide(dr,dc));}
  if(type==='N'){[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]].forEach(([dr,dc])=>{const r=row+dr,c=col+dc;if(inBounds(r,c)&&!friendly(r,c)) moves.push([r,c]);});}
  if(type==='K'){[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]].forEach(([dr,dc])=>{const r=row+dr,c=col+dc;if(inBounds(r,c)&&!friendly(r,c)) moves.push([r,c]);});}
  return moves;
}

function chessClick(row,col){
  if(chessState.turn!=='w'||chessState.gameOver) return;
  const {board,selected}=chessState;
  const piece=board[row][col];

  if(selected){
    const [sr,sc]=selected;
    const possible=getPossibleMoves(sr,sc);
    const isValid=possible.some(([r,c])=>r===row&&c===col);
    if(isValid){
      // Make move
      if(board[row][col]) chessState.captures.w.push(board[row][col]);
      board[row][col]=board[sr][sc];
      board[sr][sc]=null;
      chessState.selected=null;
      chessState.movesCount++;
      // Pawn promotion
      if(board[row][col]==='wP'&&row===0) board[row][col]='wQ';
      // Check king capture
      const bKing=board.flat().includes('bK');
      if(!bKing){ endChessGame('won'); return; }
      chessState.turn='b';
      renderChessBoard();
      setTimeout(ngoziChessMove,900);
      return;
    }
    chessState.selected=null;
  }
  if(piece&&piece[0]==='w'){
    chessState.selected=[row,col];
  }
  renderChessBoard();
}

function ngoziChessMove(){
  if(chessState.gameOver) return;
  const {board}=chessState;
  // Collect all black moves
  const allMoves=[];
  for(let r=0;r<8;r++) for(let c=0;c<8;c++){
    if(board[r][c]&&board[r][c][0]==='b'){
      const moves=getPossibleMoves(r,c);
      moves.forEach(([tr,tc])=>allMoves.push({from:[r,c],to:[tr,tc],captures:board[tr][tc]}));
    }
  }
  if(allMoves.length===0){ endChessGame('won'); return; }
  // Prioritize captures, then random
  const captures=allMoves.filter(m=>m.captures&&m.captures[0]==='w');
  const move=captures.length>0?captures[Math.floor(Math.random()*captures.length)]:allMoves[Math.floor(Math.random()*allMoves.length)];
  const {from:[fr,fc],to:[tr,tc]}=move;
  if(board[tr][tc]) chessState.captures.b.push(board[tr][tc]);
  board[tr][tc]=board[fr][fc];
  board[fr][fc]=null;
  // Pawn promotion
  if(board[tr][tc]==='bP'&&tr===7) board[tr][tc]='bQ';
  // Check king
  const wKing=board.flat().includes('wK');
  if(!wKing){ endChessGame('lost'); return; }
  chessState.turn='w';
  chessState.movesCount++;
  if(chessState.movesCount>=40) { endChessGame('draw'); return; }
  renderChessBoard();
}

function endChessGame(result){
  chessState.gameOver=true;
  document.getElementById('chess-game').classList.remove('show');
  G.activeMinigame=null;
  const rel=G.relationships[G.currentNPC];
  const npc=NPCS[G.currentNPC];
  let boost,toast;
  if(result==='won'){ boost=30; toast=`‚ôüÔ∏è You beat Ngozi at chess! She's genuinely impressed! +30 Interest`; G.stats.intelligence=Math.min(100,G.stats.intelligence+15); }
  else if(result==='resign'||result==='lost'){ boost=12; toast=`‚ôüÔ∏è Ngozi won but respects your game. +12 Interest`; G.stats.intelligence=Math.min(100,G.stats.intelligence+5); }
  else { boost=20; toast=`‚ôüÔ∏è Well played draw! Ngozi says "Same time next week?" +20 Interest`; G.stats.intelligence=Math.min(100,G.stats.intelligence+10); }
  rel.interest=Math.min(100,rel.interest+boost);
  showToast(toast,3500);
  updateStats();
  const lang=G.player.lang; const dialogues=npc.dialogue[lang]||npc.dialogue.english;
  showDialogue(Math.min(3,dialogues.length-1));
}

// ============================================================
// HOOK ANNIVERSARY CHECK INTO DAY ADVANCE
// ============================================================
const _origAdvanceDay=advanceDay;
advanceDay = function(){
  _origAdvanceDay();
  checkAnniversaries();
  // Try NPC-initiated text every few days
  if(G.day%3===0) setTimeout(tryNpcInitiatedText,2500);
}

// ============================================================
// V5 FEATURES
// ============================================================

// ---- Global state additions ----
window.addEventListener('DOMContentLoaded',()=>{
  if(!G.choiceLog) G.choiceLog=[];
  if(!G.timeline) G.timeline=[];
  if(!G.dailyChallenge) G.dailyChallenge=generateDailyChallenge();
  if(!G.challengeProgress) G.challengeProgress={};
  if(G.ambientOn===undefined) G.ambientOn=false;
  applyDayNightFilter();
});

// ---- SCENE TRANSITIONS ----
function doSceneTransition(type,callback){
  const ov=document.getElementById('scene-transition');
  ov.className='screen-transition-overlay '+type;
  ov.style.display='block';
  setTimeout(()=>{callback&&callback();},200);
  setTimeout(()=>{ov.style.display='none';ov.className='screen-transition-overlay';},500);
}

// Patch showScreen to use transitions
const _origShowScreen=showScreen;
showScreen = function(id){
  const types=['sliding','fading','curtain'];
  const type=types[Math.floor(Math.random()*types.length)];
  doSceneTransition(type,()=>_origShowScreen(id));
}

// ---- PARTICLE EFFECTS ----
function spawnParticles(type,x,y){
  const container=document.getElementById('particle-container');
  const configs={
    hearts:{emojis:['‚ù§Ô∏è','üíï','üíó'],count:8},
    stars:{emojis:['‚≠ê','‚ú®','üí´'],count:10},
    confetti:{emojis:['üéâ','üéä','‚ú®','üíõ','üíö'],count:12},
  };
  const cfg=configs[type]||configs.stars;
  for(let i=0;i<cfg.count;i++){
    const p=document.createElement('div');
    p.className='particle';
    p.textContent=cfg.emojis[Math.floor(Math.random()*cfg.emojis.length)];
    p.style.cssText=`left:${x||50}%;top:${y||50}%;font-size:${14+Math.random()*10}px;--dx:${(Math.random()-0.5)*120}px;--dy:${-40-Math.random()*80}px;animation-delay:${Math.random()*0.3}s;`;
    container.appendChild(p);
    setTimeout(()=>p.remove(),1500);
  }
}

// Trigger particles on good choices
const _origGainXP=gainXP;
gainXP = function(amount){
  _origGainXP(amount);
  if(amount>10) spawnParticles('stars',50,60);
}

// ---- NPC ANIMATED EXPRESSIONS ----
function showNPCExpression(npcEl,expr){
  const existing=npcEl.querySelector('.npc-mood-bubble');
  if(existing) existing.remove();
  const bubble=document.createElement('div');
  bubble.className='npc-mood-bubble';
  const exprMap={good:'üòä',great:'ü§©',blush:'üò≥',laugh:'üòÇ',frown:'üò§',shy:'‚ò∫Ô∏è',angry:'üò†',happy:'ü•∞'};
  bubble.textContent=exprMap[expr]||expr;
  npcEl.appendChild(bubble);
  setTimeout(()=>bubble.remove(),3000);
}

// Patch showDialogue to add expressions
const _origShowDialogue=window.showDialogue;

// ---- AMBIENT SOUNDS (Web Audio API) ----
let ambientCtx=null, ambientSource=null, ambientGain=null;
const AMBIENT_SOUNDS={
  morning:{name:'üåÖ Morning Birds',freq:440,type:'sine'},
  afternoon:{name:'‚òÄÔ∏è Market Buzz',freq:220,type:'sawtooth'},
  evening:{name:'üåÜ Church Bells',freq:523,type:'triangle'},
  night:{name:'üåô Night Crickets',freq:330,type:'sine'},
};

function toggleAmbientSound(){
  G.ambientOn=!G.ambientOn;
  if(G.ambientOn) startAmbientSound();
  else stopAmbientSound();
  const btn=document.getElementById('ambient-btn-el');
  if(btn) btn.innerHTML=G.ambientOn?'üîä Ambient':'üîá Ambient';
  showToast(G.ambientOn?`${AMBIENT_SOUNDS[G.timeOfDay].name} playing üéµ`:'Ambient sound off');
}

function startAmbientSound(){
  try{
    if(!ambientCtx) ambientCtx=new(window.AudioContext||window.webkitAudioContext)();
    stopAmbientSound();
    ambientGain=ambientCtx.createGain();
    ambientGain.gain.setValueAtTime(0.05,ambientCtx.currentTime);
    ambientGain.connect(ambientCtx.destination);
    ambientSource=ambientCtx.createOscillator();
    const snd=AMBIENT_SOUNDS[G.timeOfDay]||AMBIENT_SOUNDS.afternoon;
    ambientSource.type=snd.type;
    ambientSource.frequency.setValueAtTime(snd.freq,ambientCtx.currentTime);
    // Add subtle LFO for organic feel
    const lfo=ambientCtx.createOscillator();
    lfo.frequency.value=0.3;
    const lfoGain=ambientCtx.createGain();
    lfoGain.gain.value=5;
    lfo.connect(lfoGain);
    lfoGain.connect(ambientSource.frequency);
    lfo.start();
    ambientSource.connect(ambientGain);
    ambientSource.start();
  }catch(e){}
}

function stopAmbientSound(){
  try{if(ambientSource){ambientSource.stop();ambientSource=null;}}catch(e){}
}

function playSuccessSound(){
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    const o=ctx.createOscillator(); const g=ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.frequency.setValueAtTime(523,ctx.currentTime);
    o.frequency.setValueAtTime(659,ctx.currentTime+0.1);
    o.frequency.setValueAtTime(784,ctx.currentTime+0.2);
    g.gain.setValueAtTime(0.3,ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.5);
    o.start(ctx.currentTime); o.stop(ctx.currentTime+0.5);
  }catch(e){}
}

function playFailSound(){
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    const o=ctx.createOscillator(); const g=ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.frequency.setValueAtTime(300,ctx.currentTime);
    o.frequency.setValueAtTime(200,ctx.currentTime+0.15);
    g.gain.setValueAtTime(0.2,ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.4);
    o.start(ctx.currentTime); o.stop(ctx.currentTime+0.4);
  }catch(e){}
}

// ---- DAY/NIGHT VISUAL FILTER ----
function applyDayNightFilter(){
  document.body.className=`time-${G.timeOfDay||'afternoon'}`;
  if(G.ambientOn) startAmbientSound();
}

// Patch advanceTimeOfDay to apply filter
const _origAdvanceTimeOfDay=advanceTimeOfDay;
advanceTimeOfDay = function(){
  _origAdvanceTimeOfDay();
  applyDayNightFilter();
}

// ---- MILESTONE CUTSCENES ----
const MILESTONE_CUTSCENES={
  friend:{title:'üí´ A New Friend!',panels:[
    {emoji:'ü§ù',text:'You built real trust'},
    {emoji:'üòä',text:'She remembers you'},
    {emoji:'‚ú®',text:'The journey continues...'},
  ]},
  crush:{title:'üíò She Likes You!',panels:[
    {emoji:'üíì',text:'Something changed in her eyes'},
    {emoji:'üò≥',text:'She thinks about you'},
    {emoji:'üåπ',text:'The feelings are real...'},
  ]},
  partner:{title:'‚ù§Ô∏è You\'re Official!',panels:[
    {emoji:'üíï',text:'She chose YOU'},
    {emoji:'üéâ',text:'Lagos witnesses your love'},
    {emoji:'üíç',text:'The story\'s just beginning...'},
  ]},
};

function showMilestoneCutscene(type){
  const cfg=MILESTONE_CUTSCENES[type];
  if(!cfg) return;
  document.getElementById('milestone-title').textContent=cfg.title;
  document.getElementById('milestone-panels').innerHTML=cfg.panels.map(p=>`
    <div class="milestone-panel">
      <div class="milestone-panel-emoji">${p.emoji}</div>
      <div class="milestone-panel-text">${p.text}</div>
    </div>`).join('');
  document.getElementById('milestone-text').textContent='A defining moment in your love story! üá≥üá¨';
  document.getElementById('milestone-cutscene').classList.add('show');
  playSuccessSound();
  spawnParticles('hearts',50,50);
}

function closeMilestoneCutscene(){
  document.getElementById('milestone-cutscene').classList.remove('show');
}

// Track stage changes for milestone cutscenes
let _lastStages={};
function checkStageMilestones(npcId){
  const rel=G.relationships[npcId];
  if(!rel) return;
  const stage=getStage(rel.interest);
  const stageMap={[getStage(30).label]:'friend',[getStage(60).label]:'crush',[getStage(85).label]:'partner'};
  const prev=_lastStages[npcId];
  const stageKey=stageMap[stage.label];
  if(stageKey&&prev!==stageKey){
    _lastStages[npcId]=stageKey;
    if(prev) setTimeout(()=>showMilestoneCutscene(stageKey),800);
  }
  if(!prev) _lastStages[npcId]=stageKey||'stranger';
}

// ---- WINGMAN (CHIDI) ----
const WINGMAN_TIPS={
  stranger:["She doesn't know you yet, bro. Start with genuine curiosity ‚Äî ask about HER.","First impression matters! Smile, stand tall, speak clearly. Lagos guys got this!","Easy does it. Don't rush. Let the conversation breathe naturally."],
  friend:["You're in the friend zone... or ARE you? Show her a different side of you today.","She trusts you now. Time to show ambition and depth. Tell her your dreams!","Consistency is your secret weapon right now. Keep showing up!"],
  crush:["Bro! She likes you! Don't overthink it now. Stay calm and confident.","She's feeling you. Plan something memorable ‚Äî surprise her!","Time to be more intentional. Make your interest clear but not desperate."],
  partner:["You're together! Now it's about depth. Ask deeper questions. Show vulnerability.","Keep the energy fresh! Do something unexpected today.","She's your person. Protect that energy. Be consistent, be real."],
};

function callWingman(){
  const npcId=G.currentNPC;
  const rel=G.relationships[npcId];
  const stage=rel?getStage(rel.interest).label:'';
  let tipsKey='stranger';
  if(stage.includes('Partner')) tipsKey='partner';
  else if(stage.includes('Crush')) tipsKey='crush';
  else if(stage.includes('Friend')) tipsKey='friend';
  const tips=WINGMAN_TIPS[tipsKey];
  const tip=tips[Math.floor(Math.random()*tips.length)];
  const npc=NPCS[npcId];
  const extraTip=npc?` (Tip: ${npc.name} loves ${npc.interests[0]})`:'.';
  document.getElementById('wingman-text').textContent=tip+extraTip;
  document.getElementById('wingman-panel').classList.add('show');
}

function closeWingman(){
  document.getElementById('wingman-panel').classList.remove('show');
}

// ---- BEST FRIEND (EMEKA) ----
const BESTIE_CONVOS=[
  {
    bestie:"Guy! I heard you went to see that babe at the restaurant. How e go?",
    replies:[
      {text:"It went well bro! She's amazing üòç",response:"Omo! You're catching feelings already? Okay okay, just don't move too fast. Play it cool.",boost:'charm',val:5},
      {text:"Struggled small but I'm learning",response:"That's the spirit! Every interaction teaches you something. Keep going, Lagos belongs to us!",boost:'confidence',val:8},
      {text:"E was a disaster bro...",response:"Ahhh! Don't worry. Tomorrow is another chance. What went wrong? Let's strategize."},
    ],
  },
  {
    bestie:"I saw Amaka with some guy at the mall. Looked friendly sha... You better step up!",
    replies:[
      {text:"Who was the guy?!",response:"Relax bro ‚Äî I think it was just her cousin. But still, don't sleep on this. Make a move!",boost:'confidence',val:5},
      {text:"I'm not fazed. I trust the process.",response:"That's growth right there! Confidence without desperation ‚Äî that's the formula.",boost:'charm',val:8},
      {text:"Maybe she's not interested in me...",response:"Stop that negative talk! Did you forget she gave you her number? She's interested, trust me."},
    ],
  },
  {
    bestie:"How you doing generally sha? You look like man with a mission today üòÇ",
    replies:[
      {text:"Bro I'm locked in! This is my season üî•",response:"That's what I want to hear! Confidence looks good on you. Go and conquer Lagos!",boost:'charm',val:10},
      {text:"I'm learning patience. These things take time.",response:"Deep! The babes always respect a patient man. You're doing better than you think.",boost:'confidence',val:8},
      {text:"Honestly I'm just enjoying the journey",response:"Philosophical! That's maturity. Enjoy every moment ‚Äî the journey IS the destination.",boost:'intelligence',val:5},
    ],
  },
];

let bestieStep=0;
function showBestie(){
  if(!gameIsActive()) { showScreen('title-screen'); return; }
  _origShowScreen('bestie-screen');
  bestieStep=Math.floor(Math.random()*BESTIE_CONVOS.length);
  renderBestieConvo();
}

function renderBestieConvo(){
  const convo=BESTIE_CONVOS[bestieStep];
  const msgs=document.getElementById('bestie-messages');
  msgs.innerHTML=`
    <div class="msg received" style="align-self:flex-start">
      <div style="font-weight:800;color:var(--teal);font-size:11px;margin-bottom:3px">Emeka üßëüèæ</div>
      <div>${convo.bestie}</div>
    </div>`;
  document.getElementById('bestie-replies').innerHTML=convo.replies.map((r,i)=>
    `<button class="bestie-reply" onclick="selectBestieReply(${i})">${r.text}</button>`).join('');
}

function selectBestieReply(idx){
  const convo=BESTIE_CONVOS[bestieStep];
  const r=convo.replies[idx];
  const msgs=document.getElementById('bestie-messages');
  msgs.innerHTML+=`<div class="msg sent" style="align-self:flex-end"><div>${r.text}</div></div>`;
  if(r.response){
    setTimeout(()=>{
      msgs.innerHTML+=`<div class="msg received" style="align-self:flex-start"><div style="font-weight:800;color:var(--teal);font-size:11px;margin-bottom:3px">Emeka üßëüèæ</div><div>${r.response}</div></div>`;
      msgs.scrollTop=msgs.scrollHeight;
    },800);
  }
  if(r.boost&&G.stats[r.boost]!==undefined){
    G.stats[r.boost]=Math.min(100,G.stats[r.boost]+(r.val||5));
    showToast(`+${r.val} ${r.boost} from Emeka's advice! üíØ`);
    updateStats();
  }
  document.getElementById('bestie-replies').innerHTML=`<button class="bestie-reply" onclick="showBestie()">Ask Emeka something else üîÑ</button><button class="bestie-reply" onclick="backToMap()">Back to Lagos üó∫Ô∏è</button>`;
  // Record in timeline
  addToTimeline(`üí¨ Talked to Emeka about your love life`,'var(--teal)');
}

function showBestieEndings(){showEndings();}

// ---- GOSSIP SYSTEM ----
const GOSSIP_DATA=[
  {npc:'amaka',text:"Amaka was seen turning down THREE guys this week alone. She has very high standards ‚Äî you've been warned.",source:"Campus gist from Fatima"},
  {npc:'amaka',text:"Amaka told her roommate she's actually impressed by someone she met recently. Could be you?",source:"Overheard in the library"},
  {npc:'chiamaka',text:"Chiamaka's aunty says she's looking for a serious man who respects family values above everything.",source:"Buka restaurant regulars"},
  {npc:'chiamaka',text:"Word is Chiamaka rejected a wealthy man last month because he was rude to the waiter. She notices EVERYTHING.",source:"Inside scoop from her cousin"},
  {npc:'ngozi',text:"Ngozi turned down a job at Google US to stay in Lagos. She's deeply patriotic ‚Äî respect that.",source:"Tech Hub insider"},
  {npc:'ngozi',text:"Ngozi told her colleague she values intellectual honesty over flattery. Empty compliments don't work on her.",source:"Overheard at a hackathon"},
  {npc:'titi',text:"Titi volunteers every Saturday at the orphanage. She looks for that same servant heart in a partner.",source:"Church announcement board"},
  {npc:'titi',text:"Titi's pastor mentioned she's been praying about a future relationship. She takes this very seriously.",source:"Church WhatsApp group"},
  {npc:'bisi',text:"Bisi's photography got featured in a Lagos lifestyle magazine this month! She's going places.",source:"Mall gossip"},
  {npc:'bisi',text:"Someone saw Bisi delete a guy's number right in front of him because he was on his phone the whole date.",source:"Mall food court tea ‚òï"},
];

let gossipTimeout;
function hearGossip(){
  const item=GOSSIP_DATA[Math.floor(Math.random()*GOSSIP_DATA.length)];
  document.getElementById('gossip-text').textContent=item.text;
  document.getElementById('gossip-source').textContent=`üìç ${item.source}`;
  const popup=document.getElementById('gossip-popup');
  popup.classList.add('show');
  clearTimeout(gossipTimeout);
  gossipTimeout=setTimeout(closeGossip,6000);
  // Unlock gossip tip for this NPC
  G.gossipHeard=G.gossipHeard||{};
  G.gossipHeard[item.npc]=item;
  addToTimeline(`üó£Ô∏è Heard gossip about ${NPCS[item.npc]?.name||item.npc}!`,'#FF6B35');
}

function closeGossip(){
  document.getElementById('gossip-popup').classList.remove('show');
}

// Show gossip hint during dialogues
function getGossipHint(npcId){
  const g=G.gossipHeard&&G.gossipHeard[npcId];
  return g?`üí° Gossip tip: "${g.text.substring(0,60)}..."`:null;
}

// ---- ANALYTICS SCREEN ----
function switchTab(tab){
  if(!gameIsActive()) { showScreen('title-screen'); return; }
  const screenMap={map:'map-screen',skills:'skills-screen',phone:'phone-screen',shop:'shop-screen',journal:'journal-screen',ach:'achievements-screen',analytics:'analytics-screen',settings:'settings-screen'};
  const id=screenMap[tab];
  if(!id) return;
  _origShowScreen(id);
  if(tab==='analytics') buildAnalytics();
  if(tab==='journal') buildJournal();
  if(tab==='settings') buildSettingsScreen();
  if(tab==='phone') buildPhone();
  if(tab==='skills') buildSkills();
  if(tab==='shop') buildShop();
  if(tab==='ach') buildAchievements();
  if(tab==='map') buildMapScreen();
  // Update bottom nav active states
  document.querySelectorAll('.nav-btn').forEach(b=>{
    b.classList.remove('active');
    const onclick = b.getAttribute('onclick')||'';
    if(onclick.includes(`'${tab}'`) || (tab==='leaderboard' && onclick.includes('showLeaderboard'))) {
      b.classList.add('active');
    }
  });
}


function buildStatsRadar() {
  const stats = G.stats;
  const vals = [
    { label:'Charm', val: stats.charm||0, color:'#FF6B9D' },
    { label:'Confidence', val: stats.confidence||0, color:'#FF6B35' },
    { label:'Intelligence', val: stats.intelligence||0, color:'#4A90E2' },
    { label:'Finance', val: Math.min(100, (G.wallet||0)/100), color:'#FFD700' },
    { label:'Social', val: stats.money||0, color:'#00B86B' },
  ];
  const cx=100, cy=100, r=70;
  const n=vals.length;
  function polar(angle, radius) {
    return [cx + radius*Math.cos(angle - Math.PI/2), cy + radius*Math.sin(angle - Math.PI/2)];
  }
  // Web lines
  let webHtml='';
  [20,40,60,80,100].forEach(pct=>{
    const pts=vals.map((_,i)=>polar(2*Math.PI*i/n, r*pct/100).join(',')).join(' ');
    webHtml+=`<polygon points="${pts}" fill="none" stroke="rgba(255,255,255,0.08)" stroke-width="1"/>`;
  });
  // Axis lines
  let axisHtml='';
  vals.forEach((_,i)=>{
    const [x,y]=polar(2*Math.PI*i/n, r);
    axisHtml+=`<line x1="${cx}" y1="${cy}" x2="${x}" y2="${y}" stroke="rgba(255,255,255,0.12)" stroke-width="1"/>`;
  });
  // Data polygon
  const dataPoints=vals.map((v,i)=>polar(2*Math.PI*i/n, r*v.val/100).join(',')).join(' ');
  // Labels and dots
  let labelHtml='', dotHtml='';
  vals.forEach((v,i)=>{
    const angle=2*Math.PI*i/n;
    const [lx,ly]=polar(angle, r+18);
    const [dx,dy]=polar(angle, r*v.val/100);
    labelHtml+=`<text x="${lx}" y="${ly}" text-anchor="middle" dominant-baseline="middle" fill="${v.color}" font-size="9" font-weight="800" font-family="Baloo 2,cursive">${v.label}</text>
      <text x="${lx}" y="${ly+10}" text-anchor="middle" dominant-baseline="middle" fill="rgba(255,255,255,0.5)" font-size="7">${Math.round(v.val)}%</text>`;
    dotHtml+=`<circle cx="${dx}" cy="${dy}" r="4" fill="${v.color}" stroke="rgba(0,0,0,0.5)" stroke-width="1"/>`;
  });

  return `<div class="analytics-section">
    <div class="analytics-title">üï∏Ô∏è Stats Radar</div>
    <div style="display:flex;justify-content:center;align-items:center;gap:16px;flex-wrap:wrap">
      <svg width="200" height="200" viewBox="0 0 200 200" style="flex-shrink:0">
        ${webHtml}
        ${axisHtml}
        <polygon points="${dataPoints}" fill="rgba(255,107,157,0.2)" stroke="#FF6B9D" stroke-width="2"/>
        ${dotHtml}
        ${labelHtml}
      </svg>
      <div style="display:flex;flex-direction:column;gap:8px;">
        ${vals.map(v=>`<div style="display:flex;align-items:center;gap:8px;font-size:11px">
          <div style="width:10px;height:10px;border-radius:50%;background:${v.color};flex-shrink:0"></div>
          <span style="color:rgba(255,255,255,0.7);width:80px">${v.label}</span>
          <div style="width:60px;height:6px;background:rgba(255,255,255,0.1);border-radius:3px;overflow:hidden">
            <div style="height:100%;width:${v.val}%;background:${v.color};border-radius:3px;transition:width 0.5s"></div>
          </div>
          <span style="color:white;font-weight:800;width:30px">${Math.round(v.val)}%</span>
        </div>`).join('')}
      </div>
    </div>
  </div>`;
}

function buildAnalytics(){
  const container=document.getElementById('analytics-content');
  let html='';

  // Playstyle analysis
  const log=G.choiceLog||[];
  const good=log.filter(c=>c.type==='good').length;
  const bad=log.filter(c=>c.type==='bad').length;
  const neutral=log.filter(c=>c.type==='neutral').length;
  const total=Math.max(1,good+bad+neutral);
  const boldPct=Math.round((good/total)*100);
  const shyPct=Math.round((neutral/total)*100);
  const failPct=Math.round((bad/total)*100);

  let playstyle,desc;
  if(boldPct>=60){playstyle='üî• Bold & Confident';desc='You go for what you want. High risk, high reward. Watch out for coming across too strong sometimes.';}
  else if(failPct>=40){playstyle='üò¨ Needs Work';desc='You tend to choose aggressive or ill-timed moves. Slow down and read the situation more carefully.';}
  else if(shyPct>=50){playstyle='üåø Cautious & Steady';desc='You play it safe. You\'re reliable and patient, but sometimes you need to take more decisive action!';}
  else{playstyle='‚öñÔ∏è Balanced Romantic';desc='You adapt to each situation. Good instincts ‚Äî keep trusting them!';}

  html+=`<div class="analytics-section">
    <div class="analytics-title">üé≠ Your Playstyle</div>
    <div class="playstyle-card">
      <div class="playstyle-title">${playstyle}</div>
      <div class="playstyle-desc">${desc}</div>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:10px;flex-wrap:wrap">
        <span class="breakdown-tag high">Bold: ${boldPct}%</span>
        <span class="breakdown-tag">Steady: ${shyPct}%</span>
        <span class="breakdown-tag low">Missteps: ${failPct}%</span>
      </div>
    </div>
  </div>`;

  // Choice heatmap
  html+=`<div class="analytics-section">
    <div class="analytics-title">üó∫Ô∏è Choice Heatmap</div>
    <div class="heatmap-container" id="heatmap-viz">
      <div class="heatmap-label" style="top:5px;left:5px">Aggressive</div>
      <div class="heatmap-label" style="top:5px;right:5px">Charming</div>
      <div class="heatmap-label" style="bottom:5px;left:5px">Passive</div>
      <div class="heatmap-label" style="bottom:5px;right:5px">Thoughtful</div>
    </div>
  </div>`;

  // Compatibility scores
  html+=`<div class="analytics-section">
    <div class="analytics-title">üíï Compatibility Scores</div>`;
  Object.values(NPCS).forEach(npc=>{
    const rel=G.relationships[npc.id];
    if(!rel||!rel.met) return;
    const interest=rel.interest||0;
    const compat=Math.min(100,Math.round(interest*(0.6+(G.stats.charm||50)/250)));
    html+=`<div class="compat-card">
      <div class="compat-row">
        <div style="width:36px;height:36px;border-radius:50%;overflow:hidden;flex-shrink:0">${npcSVG(npc)}</div>
        <div style="flex:1">
          <div style="font-weight:800;color:white;font-size:13px">${npc.name}</div>
          <div style="font-size:10px;color:rgba(255,255,255,.5)">${npc.job}</div>
        </div>
        <div class="compat-score">${compat}%</div>
      </div>
      <div class="compat-bar-wrap"><div class="compat-bar-fill" style="width:${compat}%"></div></div>
      <div class="breakdown-row">
        <span class="breakdown-tag ${interest>=60?'high':''}">Interest: ${interest}%</span>
        <span class="breakdown-tag ${G.stats.charm>=60?'high':''}">Charm: ${Math.round(G.stats.charm)}%</span>
        <span class="breakdown-tag">${getStage(interest).label}</span>
        ${rel.dated?'<span class="breakdown-tag high">Dated ‚úì</span>':''}
      </div>
    </div>`;
  });
  html+='</div>';

  // Relationship timeline
  const timeline=G.timeline||[];
  if(timeline.length>0){
    html+=`<div class="analytics-section">
      <div class="analytics-title">üìÖ Relationship Timeline</div>
      <div class="timeline-wrap">`;
    [...timeline].reverse().slice(0,10).forEach((evt,i)=>{
      html+=`<div class="timeline-event">
        <div>
          <div class="timeline-dot" style="background:${evt.color||'var(--gold)'}"></div>
          ${i<timeline.length-1?'<div class="timeline-line"></div>':''}
        </div>
        <div class="timeline-content">
          <div class="timeline-day">Day ${evt.day||'?'} ‚Ä¢ ${evt.time||''}</div>
          <div class="timeline-text">${evt.text}</div>
        </div>
      </div>`;
    });
    html+='</div></div>';
  }

  // Weekly report card
  html+=buildWeeklyReport();

  // Add radar chart
  html+=buildStatsRadar();

  container.innerHTML=html;

  // Render heatmap dots
  setTimeout(()=>{
    const hm=document.getElementById('heatmap-viz');
    if(!hm) return;
    const dots=[
      {x:boldPct,y:30,color:'rgba(255,107,157,.7)',size:Math.max(8,boldPct/3)},
      {x:shyPct/2,y:70,color:'rgba(74,144,226,.7)',size:Math.max(8,shyPct/3)},
      {x:80-failPct,y:50,color:'rgba(0,135,81,.7)',size:Math.max(8,(100-failPct)/3)},
    ];
    dots.forEach(d=>{
      const dot=document.createElement('div');
      dot.className='heatmap-dot';
      dot.style.cssText=`left:${d.x}%;top:${d.y}%;width:${d.size}px;height:${d.size}px;background:${d.color};box-shadow:0 0 ${d.size}px ${d.color};`;
      hm.appendChild(dot);
    });
  },100);
}

function buildWeeklyReport(){
  const day=G.day||1;
  const log=G.choiceLog||[];
  const thisWeek=log.filter(c=>c.day&&c.day>=day-7);
  const goodThisWeek=thisWeek.filter(c=>c.type==='good').length;
  const badThisWeek=thisWeek.filter(c=>c.type==='bad').length;
  const total=thisWeek.length||1;
  const score=Math.round((goodThisWeek/total)*100);

  let grade, color;
  if(score>=80){grade='A+';color='var(--gold)';}
  else if(score>=65){grade='B';color='var(--green-light)';}
  else if(score>=50){grade='C';color='var(--blue)';}
  else{grade='D';color='var(--red)';}

  const improved=goodThisWeek>0?`Made ${goodThisWeek} great choices`:'Keep practicing good choices';
  const struggled=badThisWeek>0?`${badThisWeek} missteps to learn from`:'Clean week with no bad choices!';

  return `<div class="analytics-section">
    <div class="analytics-title">üìã Weekly Report Card</div>
    <div class="report-card">
      <div class="report-grade" style="color:${color}">${grade}</div>
      <div style="color:rgba(255,255,255,.5);font-size:11px;text-align:center;margin-bottom:12px">Days ${Math.max(1,day-7)}‚Äì${day} Performance</div>
      <div class="report-row"><span class="report-label">Score</span><span class="report-val">${score}%</span></div>
      <div class="report-row"><span class="report-label">Interactions</span><span class="report-val">${thisWeek.length}</span></div>
      <div class="report-row" style="color:var(--green-light)"><span>‚úÖ You improved:</span><span style="font-weight:800">${improved}</span></div>
      <div class="report-row" style="color:#ff6b6b"><span>‚ö†Ô∏è Struggled:</span><span style="font-weight:800">${struggled}</span></div>
    </div>
  </div>`;
}

// ---- TIMELINE HELPER ----
function addToTimeline(text,color){
  G.timeline=G.timeline||[];
  G.timeline.push({text,color:color||'var(--gold)',day:G.day,time:G.timeOfDay});
  if(G.timeline.length>50) G.timeline.shift();
}

// ---- LOG CHOICES ----
const _origMakeChoice=window.makeChoice;

// ---- LEADERBOARD ----
const LEADERBOARD_RIVALS=[
  {name:'Babatunde O.',score:94,flag:'üá≥üá¨'},
  {name:'Chukwuemeka N.',score:87,flag:'üá≥üá¨'},
  {name:'Oluwaseun A.',score:82,flag:'üá≥üá¨'},
  {name:'Kelechi I.',score:79,flag:'üá≥üá¨'},
  {name:'Adewale F.',score:71,flag:'üá≥üá¨'},
  {name:'Musa D.',score:68,flag:'üá≥üá¨'},
  {name:'Segun B.',score:55,flag:'üá≥üá¨'},
];

function showLeaderboard(){
  if(!gameIsActive()) { showScreen('title-screen'); return; }
  _origShowScreen('leaderboard-screen');
  buildLeaderboard();
}

function buildLeaderboard(){
  const rels=Object.values(G.relationships||{});
  const met=rels.filter(r=>r.met);
  const avgScore=met.length?Math.round(met.reduce((s,r)=>s+(r.interest||0),0)/met.length):0;
  const myEntry={name:`You (${G.player.name||'Player'})`,score:avgScore,flag:'‚≠ê',isYou:true};

  let list=[...LEADERBOARD_RIVALS,myEntry].sort((a,b)=>b.score-a.score);
  
  document.getElementById('leaderboard-list').innerHTML=list.map((e,i)=>`
    <div class="lb-entry${e.isYou?' lb-you':''}">
      <div class="lb-rank">${i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':'#'+(i+1)}</div>
      <div style="font-size:20px">${e.flag}</div>
      <div class="lb-name">${e.name}${e.isYou?' üëà':''}</div>
      <div class="lb-score">${e.score}%</div>
    </div>`).join('');

  // Daily challenge in leaderboard
  buildDailyChallengeDisplay();
}

// ---- DAILY CHALLENGE ----
const DAILY_CHALLENGES=[
  {id:'laugh',text:'Make Amaka laugh 3 times',npc:'amaka',goal:3,type:'good',reward:{charm:15},emoji:'üòÇ'},
  {id:'charm_chiamaka',text:'Make 2 great choices with Chiamaka',npc:'chiamaka',goal:2,type:'good',reward:{charm:10},emoji:'‚ú®'},
  {id:'be_kind',text:'Choose the kind option 4 times today',npc:null,goal:4,type:'good',reward:{confidence:15},emoji:'üïäÔ∏è'},
  {id:'visit_all',text:'Visit 3 different locations today',npc:null,goal:3,type:'visit',reward:{charm:10,confidence:10},emoji:'üó∫Ô∏è'},
  {id:'gift',text:'Buy a gift for someone today',npc:null,goal:1,type:'gift',reward:{wallet:200},emoji:'üéÅ'},
  {id:'chess',text:'Play chess with Ngozi today',npc:'ngozi',goal:1,type:'minigame',reward:{intelligence:20},emoji:'‚ôüÔ∏è'},
  {id:'night_visit',text:'Visit a location at night',npc:null,goal:1,type:'night',reward:{charm:10},emoji:'üåô'},
];

function generateDailyChallenge(){
  const c=DAILY_CHALLENGES[Math.floor(Math.random()*DAILY_CHALLENGES.length)];
  return {...c,dayGenerated:G&&G.day||1};
}

function buildDailyChallengeDisplay(){
  const ch=G.dailyChallenge||generateDailyChallenge();
  const prog=G.challengeProgress[ch.id]||0;
  const done=prog>=ch.goal;
  const el=document.getElementById('daily-challenge-display');
  if(!el) return;
  el.innerHTML=`
    <div class="daily-ch-title">${ch.emoji} Today's Challenge!</div>
    <div class="daily-ch-desc">${ch.text}</div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px">
      <div class="daily-ch-progress" style="flex:1;margin-right:8px"><div class="daily-ch-fill" style="width:${Math.min(100,(prog/ch.goal)*100)}%"></div></div>
      <span style="font-size:11px;color:white;font-weight:800">${prog}/${ch.goal} ${done?'‚úÖ':''}</span>
    </div>`;
}

function showDailyChallenge(){
  const ch=G.dailyChallenge||generateDailyChallenge();
  const prog=G.challengeProgress[ch.id]||0;
  const done=prog>=ch.goal;
  const rewardText=Object.entries(ch.reward).map(([k,v])=>k==='wallet'?`+‚Ç¶${v}`:'+'+v+' '+k).join(', ');

  document.getElementById('daily-challenge-content').innerHTML=`
    <div style="text-align:center;margin-bottom:14px">
      <div style="font-size:36px;margin-bottom:8px">${ch.emoji}</div>
      <div style="font-size:14px;color:white;font-weight:700;margin-bottom:6px">${ch.text}</div>
      <div style="font-size:12px;color:rgba(255,255,255,.5)">Reward: ${rewardText}</div>
    </div>
    <div style="background:rgba(255,255,255,.06);border-radius:12px;padding:12px;text-align:center;margin-bottom:12px">
      <div style="font-size:13px;color:rgba(255,255,255,.7);margin-bottom:6px">Progress: ${prog}/${ch.goal}</div>
      <div style="height:8px;background:rgba(255,255,255,.1);border-radius:8px;overflow:hidden">
        <div style="height:100%;background:linear-gradient(90deg,var(--pink),var(--orange));border-radius:8px;width:${Math.min(100,(prog/ch.goal)*100)}%;transition:width .5s"></div>
      </div>
      ${done?'<div style="color:var(--green-light);font-weight:800;margin-top:8px">‚úÖ Challenge Complete!</div>':''}
    </div>
    ${done?`<div style="background:rgba(0,135,81,.15);border:1px solid rgba(0,135,81,.3);border-radius:12px;padding:10px;text-align:center;font-size:13px;color:var(--green-light);font-weight:800">üéâ Reward Earned: ${rewardText}</div>`:''}`;
  document.getElementById('daily-challenge-modal').classList.add('show');
}

function closeDailyChallengeModal(){
  document.getElementById('daily-challenge-modal').classList.remove('show');
}

function updateChallengeProgress(type,npcId){
  const ch=G.dailyChallenge;
  if(!ch) return;
  const prog=G.challengeProgress||{};
  const cur=prog[ch.id]||0;
  if(cur>=ch.goal) return; // already done
  let increment=false;
  if(ch.type==='good'&&type==='good'&&(!ch.npc||ch.npc===npcId)) increment=true;
  if(ch.type==='visit'&&type==='visit') increment=true;
  if(ch.type==='gift'&&type==='gift') increment=true;
  if(ch.type==='minigame'&&type==='minigame'&&(!ch.npc||ch.npc===npcId)) increment=true;
  if(ch.type==='night'&&type==='night') increment=true;
  if(increment){
    prog[ch.id]=(cur+1);
    G.challengeProgress=prog;
    showToast(`üéØ Challenge Progress: ${prog[ch.id]}/${ch.goal}!`);
    if(prog[ch.id]>=ch.goal){
      // Apply rewards
      Object.entries(ch.reward).forEach(([k,v])=>{
        if(k==='wallet') G.wallet+=v;
        else if(G.stats[k]!==undefined) G.stats[k]=Math.min(100,G.stats[k]+v);
      });
      updateStats();
      showToast(`üéâ Daily Challenge Complete! Rewards earned! üèÜ`,4000);
      spawnParticles('confetti',50,40);
    }
    saveGame();
  }
}

// ---- SHAREABLE REPORT CARD ----
function showShareCard(){
  buildShareCard();
  document.getElementById('share-modal').classList.add('show');
}

function closeShareModal(){
  document.getElementById('share-modal').classList.remove('show');
}

function downloadShareCard(){
  buildShareCard();
  const card=document.getElementById('share-card-preview');
  if(!card){showToast('Share card not available');return;}
  // Copy text content as fallback
  const txt=`üá≥üá¨ Naija Love Quest ‚Äî My Results!\n`+card.innerText;
  if(navigator.clipboard){navigator.clipboard.writeText(txt).then(()=>showToast('üìã Report copied to clipboard!')).catch(()=>showToast('üìã Select text to copy manually'));}
  else{showToast('üìã Select and copy the share card text');}
}

function buildShareCard(){
  const rels=Object.values(G.relationships||{}).filter(r=>r.met);
  const avgScore=rels.length?Math.round(rels.reduce((s,r)=>s+(r.interest||0),0)/rels.length):0;
  const log=G.choiceLog||[];
  const good=log.filter(c=>c.type==='good').length;
  const total=Math.max(1,log.length);
  const pct=Math.round((good/total)*100);
  let grade=pct>=80?'A+':pct>=65?'B':pct>=50?'C':'D';

  const metNPCs=Object.values(NPCS).filter(n=>G.relationships[n.id]&&G.relationships[n.id].met);

  document.getElementById('share-card-preview').innerHTML=`
    <div class="share-card" id="share-card-inner">
      <div style="font-size:10px;color:rgba(255,215,0,.6);letter-spacing:2px;margin-bottom:8px">NAIJA LOVE QUEST üíö</div>
      <div style="font-family:'Baloo 2',cursive;font-size:22px;color:var(--gold);font-weight:800;margin-bottom:4px">${G.player.name||'Player'}'s Report</div>
      <div style="font-size:11px;color:rgba(255,255,255,.5);margin-bottom:14px">Day ${G.day} | Lagos, Nigeria üá≥üá¨</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;text-align:left">
        <div style="background:rgba(255,255,255,.07);border-radius:10px;padding:10px">
          <div style="font-size:9px;color:rgba(255,255,255,.5);font-weight:800;margin-bottom:2px">GRADE</div>
          <div style="font-family:'Baloo 2',cursive;font-size:28px;font-weight:800;color:${grade==='A+'?'var(--gold)':grade==='B'?'var(--green-light)':'var(--blue)'}">${grade}</div>
        </div>
        <div style="background:rgba(255,255,255,.07);border-radius:10px;padding:10px">
          <div style="font-size:9px;color:rgba(255,255,255,.5);font-weight:800;margin-bottom:2px">AVG COMPAT</div>
          <div style="font-family:'Baloo 2',cursive;font-size:28px;font-weight:800;color:var(--pink)">${avgScore}%</div>
        </div>
      </div>
      <div style="display:flex;justify-content:center;gap:6px;margin-bottom:10px">
        ${metNPCs.slice(0,5).map(n=>`<div style="text-align:center"><div style="width:32px;height:32px;border-radius:50%;overflow:hidden;border:2px solid ${G.relationships[n.id].interest>=60?'var(--gold)':'rgba(255,255,255,.2)'}">${npcSVG(n)}</div><div style="font-size:8px;color:rgba(255,255,255,.5);margin-top:2px">${G.relationships[n.id].interest}%</div></div>`).join('')}
      </div>
      <div style="font-size:11px;color:rgba(255,255,255,.6)">Level ${G.player.level} ‚Ä¢ ${log.length} Interactions</div>
      <div class="share-watermark">naija-love-quest.game</div>
    </div>
    <div style="font-size:11px;color:rgba(255,255,255,.4);text-align:center;margin-top:8px">Screenshot this to share with friends! üì±</div>`;
}

// ---- PATCH CHOICE LOGGING & CHALLENGE TRACKING ----
// We hook into the choices rendering to log choices
function logChoice(type,npcId,dialogueText,choiceText){
  G.choiceLog=G.choiceLog||[];
  G.choiceLog.push({type,npcId,day:G.day,time:G.timeOfDay,dialogueText:dialogueText||'',choiceText:choiceText||''});
  if(G.choiceLog.length>200) G.choiceLog.shift();
  
  // Add to timeline
  const npc=NPCS[npcId];
  if(type==='good') addToTimeline(`‚úÖ Great choice with ${npc?.name||npcId}!`,'var(--green-light)');
  else if(type==='bad') addToTimeline(`‚ùå Misstep with ${npc?.name||npcId}`,'#ff6b6b');
  
  // Update challenge
  updateChallengeProgress(type,npcId);
  
  // Show NPC expression
  const charStage=document.getElementById('char-stage');
  if(charStage&&type==='good') setTimeout(()=>{spawnParticles('hearts',70,40);},300);
  if(charStage&&type==='bad') setTimeout(()=>{},100);
}

// ---- VISIT TRACKING FOR CHALLENGE ----
const _origVisitLocation=window.visitLocation;

// ---- INIT NEW FEATURES ----
function initV5Features(){
  if(!G.choiceLog) G.choiceLog=[];
  if(!G.timeline) G.timeline=[];
  if(!G.challengeProgress) G.challengeProgress={};
  if(!G.gossipHeard) G.gossipHeard={};
  if(!G.dailyChallenge) G.dailyChallenge=generateDailyChallenge();
  if(G.ambientOn===undefined) G.ambientOn=false;
  applyDayNightFilter();
}

// ============================================================
// V6 FEATURES
// ============================================================

// ---- SETTINGS STATE ----
const SETTINGS = {
  soundOn: true,
  ambientOn: false,
  largeText: false,
  highContrast: false,
  reduceMotion: false,
  language: 'english',
  notifications: true,
  difficulty: 'realistic', // casual | realistic | hard | ngplus
};

function loadSettings() {
  try {
    const raw = localStorage.getItem('nlq_settings');
    if (raw) Object.assign(SETTINGS, JSON.parse(raw));
  } catch(e) {}
  applyAccessibility();
}

function saveSettings() {
  try { localStorage.setItem('nlq_settings', JSON.stringify(SETTINGS)); } catch(e) {}
}

function applyAccessibility() {
  document.body.classList.toggle('large-text', SETTINGS.largeText);
  document.body.classList.toggle('high-contrast', SETTINGS.highContrast);
  document.body.classList.toggle('reduce-motion', SETTINGS.reduceMotion);
}

// ---- SETTINGS SCREEN ----
function closeSettings() {
  if(gameIsActive()) {
    backToMap();
  } else {
    showScreen('title-screen');
  }
}

function showSettings() {
  // Settings screen is NOT a game screen ‚Äî accessible from title too
  // Use _origShowScreen to bypass the game guard
  window._settingsFrom = gameIsActive() ? 'map-screen' : 'title-screen';
  if(typeof _origShowScreen === 'function') _origShowScreen('settings-screen');
  else { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById('settings-screen').classList.add('active'); }
  buildSettingsScreen();
}

function buildSettingsScreen() {
  const diffOptions = [
    { id:'casual', emoji:'üòå', name:'Casual', desc:'Forgiving choices. Great for learning and story focus.' },
    { id:'realistic', emoji:'‚öñÔ∏è', name:'Realistic', desc:'Balanced challenge. Mistakes cost, good choices shine.' },
    { id:'hard', emoji:'üî•', name:'Hard Mode', desc:'Smart NPCs, half charm gains, context matters more.' },
    { id:'ngplus', emoji:'üåÄ', name:'New Game+', desc:'Unlocked after completing 3 stories. Deeper dialogue trees, hidden betrayal paths.' },
  ];

  document.getElementById('settings-content').innerHTML = `
    <div class="settings-section">
      <div class="settings-section-title">üéÆ Difficulty</div>
      <div class="difficulty-grid">
        ${diffOptions.map(d => `
          <div class="diff-card ${SETTINGS.difficulty===d.id?'selected':''}" onclick="setDifficulty('${d.id}')">
            <div class="diff-card-emoji">${d.emoji}</div>
            <div class="diff-card-name">${d.name}</div>
            <div class="diff-card-desc">${d.desc}</div>
          </div>`).join('')}
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">üîä Audio</div>
      <div class="settings-row">
        <div><div class="settings-label">Sound Effects</div><div class="settings-sublabel">Choice feedback, success sounds</div></div>
        <div class="toggle-switch ${SETTINGS.soundOn?'on':''}" onclick="toggleSetting('soundOn',this)"><div class="toggle-knob"></div></div>
      </div>
      <div class="settings-row">
        <div><div class="settings-label">Ambient Sounds</div><div class="settings-sublabel">Market noise, church bells, mall music</div></div>
        <div class="toggle-switch ${SETTINGS.ambientOn?'on':''}" onclick="toggleSetting('ambientOn',this)"><div class="toggle-knob"></div></div>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">‚ôø Accessibility</div>
      <div class="settings-row">
        <div><div class="settings-label">Large Text</div><div class="settings-sublabel">Increases dialogue and menu font size</div></div>
        <div class="toggle-switch ${SETTINGS.largeText?'on':''}" onclick="toggleSetting('largeText',this)"><div class="toggle-knob"></div></div>
      </div>
      <div class="settings-row">
        <div><div class="settings-label">High Contrast</div><div class="settings-sublabel">Enhances color contrast for readability</div></div>
        <div class="toggle-switch ${SETTINGS.highContrast?'on':''}" onclick="toggleSetting('highContrast',this)"><div class="toggle-knob"></div></div>
      </div>
      <div class="settings-row">
        <div><div class="settings-label">Reduce Animation</div><div class="settings-sublabel">Disables transitions and particle effects</div></div>
        <div class="toggle-switch ${SETTINGS.reduceMotion?'on':''}" onclick="toggleSetting('reduceMotion',this)"><div class="toggle-knob"></div></div>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">‚òÅÔ∏è Cloud Save / Share Code</div>
      <div style="font-size:12px;color:rgba(255,255,255,.5);margin-bottom:8px">Copy this code to restore your save on any device</div>
      <div class="save-code-box" id="cloud-save-code">${generateSaveCode()}</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="settings-btn" onclick="copySaveCode()">üìã Copy Code</button>
        <button class="settings-btn" onclick="promptRestoreCode()">üì• Restore from Code</button>
        <button class="settings-btn" onclick="refreshSaveCode()">üîÑ Refresh</button>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">üóëÔ∏è Danger Zone</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="settings-btn danger" onclick="confirmResetGame()">‚ö†Ô∏è Reset Game</button>
        <button class="settings-btn danger" onclick="backToMap()">‚úï Close Settings</button>
      </div>
    </div>`;
}

function toggleSetting(key, el) {
  SETTINGS[key] = !SETTINGS[key];
  el.classList.toggle('on', SETTINGS[key]);
  saveSettings();
  applyAccessibility();
  if(key === 'ambientOn') {
    if(SETTINGS.ambientOn) startAmbientSound && startAmbientSound();
    else stopAmbientSound && stopAmbientSound();
  }
  if(key === 'largeText') showToast(SETTINGS.largeText ? 'üî° Large text ON' : 'üî° Large text OFF');
}

function setDifficulty(id) {
  const completed = Object.values(G.relationships||{}).filter(r=>r.met && r.status!=='Stranger').length;
  if(id==='ngplus' && completed < 3) { showToast('üåÄ Complete 3 stories to unlock New Game+!',3000); buildSettingsScreen(); return; }
  SETTINGS.difficulty = id;
  saveSettings();
  buildSettingsScreen();
  const labels = {casual:'üòå Casual Mode',realistic:'‚öñÔ∏è Realistic Mode',hard:'üî• Hard Mode',ngplus:'üåÄ New Game+ Activated!'};
  showToast(labels[id], 2500);
  if(id==='ngplus') document.getElementById('ng-plus-bar').style.display='flex';
  else document.getElementById('ng-plus-bar').style.display='none';
}

// ---- DIFFICULTY MODIFIERS ----
function getDifficultyMultiplier(type) {
  const mults = {
    casual:   {good:1.4, bad:0.4, neutral:1.1},
    realistic:{good:1.0, bad:1.0, neutral:1.0},
    hard:     {good:0.7, bad:1.4, neutral:0.8},
    ngplus:   {good:0.6, bad:1.6, neutral:0.7},
  };
  return (mults[SETTINGS.difficulty||'realistic'])[type] || 1.0;
}

// ---- CLOUD SAVE CODE ----
function generateSaveCode() {
  try {
    const raw = localStorage.getItem('naija_love_quest_v3');
    if(!raw) return 'NO-SAVE-YET';
    const compressed = btoa(encodeURIComponent(raw)).slice(0,80);
    return 'NLQ6-' + compressed.replace(/[^A-Z0-9]/gi,'').slice(0,40).toUpperCase();
  } catch(e) { return 'ERROR-GENERATING'; }
}

function copySaveCode() {
  const code = document.getElementById('cloud-save-code')?.textContent || '';
  if(navigator.clipboard) navigator.clipboard.writeText(code).then(()=>showToast('üìã Code copied!')).catch(()=>showToast('Copy the code manually'));
  else showToast('Select the code box and copy manually');
}

function promptRestoreCode() {
  const code = prompt('Paste your Naija Love Quest save code:');
  if(!code) return;
  try {
    const stripped = code.replace('NLQ6-','');
    const decoded = decodeURIComponent(atob(stripped));
    const save = JSON.parse(decoded);
    localStorage.setItem('naija_love_quest_v3', JSON.stringify(save));
    showToast('‚úÖ Save restored! Reloading...', 2000);
    setTimeout(()=>location.reload(), 2200);
  } catch(e) {
    showToast('‚ùå Invalid code. Check and try again.',3000);
  }
}

function refreshSaveCode() {
  const el = document.getElementById('cloud-save-code');
  if(el) el.textContent = generateSaveCode();
}

function confirmResetGame() {
  if(confirm('Reset ALL game data? This cannot be undone.')) {
    localStorage.removeItem('naija_love_quest_v3');
    G.gameStarted = false;
    G.player.name = '';
    showToast('üóëÔ∏è Game reset. Returning to title...',2500);
    setTimeout(()=>{
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
      document.getElementById('title-screen').classList.add('active');
    },2600);
  }
}

// ---- TUTORIAL ----
const TUTORIAL_STEPS = [
  { emoji:'üá≥üá¨', title:'Welcome to Lagos!', body:'Naija Love Quest is a story-driven dating adventure set in Lagos, Nigeria. Your goal: build genuine connections with 5 (+ 1 secret!) remarkable women by making meaningful choices.' },
  { emoji:'üó∫Ô∏è', title:'Explore the City', body:'Tap location pins on the map to visit each character. Each NPC is available at specific times of day ‚Äî morning, afternoon, evening, or night. Manage your energy wisely!' },
  { emoji:'üí¨', title:'Dialogue Choices', body:'Every conversation has three types of choices:\n‚úÖ Good ‚Äî thoughtful, genuine, respectful\n~ Neutral ‚Äî safe but forgettable\n‚úó Bad ‚Äî dismissive, arrogant, or rude\n\nYour choices affect her Interest level and your Charm stat.' },
  { emoji:'üß†', title:'Practice Scene', body:"Let's try a practice conversation with Kolade, a fictional guide character. No stakes ‚Äî just feel how choices work." },
  { emoji:'üìä', title:'Stats & Systems', body:'Track your progress in the Analytics tab. Check compatibility scores, your playstyle analysis, and your weekly report card. Use the Wingman and Bestie for coaching between scenes.' },
  { emoji:'üìñ', title:'Narrative Depth', body:'Each NPC has a full backstory to unlock. Find hidden Lore Items during conversations. Look for the üîÆ What If button to replay past moments with different choices.' },
  { emoji:'üöÄ', title:"You're Ready!", body:"Remember: respect, genuine curiosity, and consistency win in Lagos ‚Äî just like in real life. Good luck, and enjoy the story. üíöüá≥üá¨" },
];

let tutStep = 0;
function startTutorial() {
  window._tutorialFrom = (G.player && G.player.name) ? 'map-screen' : 'title-screen';
  tutStep = 0;
  _origShowScreen('tutorial-screen');
  renderTutorialStep();
}

function renderTutorialStep() {
  const wrap = document.getElementById('tutorial-steps-wrap');
  const step = TUTORIAL_STEPS[tutStep];
  const isPractice = tutStep === 3;

  const dots = TUTORIAL_STEPS.map((_,i)=>`<div class="tutorial-dot${i===tutStep?' active':''}"></div>`).join('');

  wrap.innerHTML = `
    <div class="tutorial-step active">
      <div class="tutorial-dots">${dots}</div>
      <div class="tutorial-emoji">${step.emoji}</div>
      <div class="tutorial-title">${step.title}</div>
      <div class="tutorial-body" style="white-space:pre-line">${step.body}</div>
      ${isPractice ? buildPracticeScene() : ''}
    </div>`;

  document.getElementById('tut-prev-btn').style.opacity = tutStep===0?'0.3':'1';
  document.getElementById('tut-next-btn').textContent = tutStep===TUTORIAL_STEPS.length-1?'Start Game! üöÄ':'Next ‚Ä∫';
}

function buildPracticeScene() {
  return `<div class="practice-npc">
    <div class="practice-npc-name">üßëüèæ Kolade (Practice Guide)</div>
    <div style="font-size:12px;color:rgba(255,255,255,.7);margin-bottom:10px">"Hey! You look new around here. Welcome to Lagos. What brings you to this area?"</div>
    <button class="practice-choice" onclick="practiceAnswer(this,'good')">‚úÖ "I'm exploring ‚Äî trying to really understand this city."</button>
    <button class="practice-choice" onclick="practiceAnswer(this,'neutral')">~ "Just passing through."</button>
    <button class="practice-choice" onclick="practiceAnswer(this,'bad')">‚úó "Mind your business."</button>
    <div class="practice-feedback" id="practice-feedback"></div>
  </div>`;
}

function practiceAnswer(btn, type) {
  document.querySelectorAll('.practice-choice').forEach(b=>b.disabled=true);
  const fb = document.getElementById('practice-feedback');
  if(!fb) return;
  const msgs = {
    good:'‚úÖ Great! Showing genuine curiosity is one of the most attractive traits. Kolade opens up. +8 Charm!',
    neutral:'~ Safe answer. He moves on. You neither impressed nor lost points. Neutral choices are sometimes fine ‚Äî but rarely memorable.',
    bad:'‚úó Ouch. Even a stranger on the street doesn\'t deserve that. Lagos is a community. Rudeness travels fast. ‚àí12 Charm.',
  };
  fb.className = 'practice-feedback ' + (type==='good'?'good':'bad');
  fb.style.display='block';
  fb.textContent = msgs[type];
}

function tutNext() {
  if(tutStep >= TUTORIAL_STEPS.length-1) { skipTutorial(); return; }
  tutStep++;
  renderTutorialStep();
}

function tutPrev() {
  if(tutStep > 0) { tutStep--; renderTutorialStep(); }
}

function skipTutorial() {
  G.tutorialDone = true;
  if(gameIsActive()) {
    // Has a character ‚Äî go to map
    _origShowScreen('map-screen');
  } else {
    // No character yet ‚Äî back to title
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    document.getElementById('title-screen').classList.add('active');
  }
}

// ---- BACKSTORY / LORE ----
function openBackstory(npcId) {
  const npc = NPCS[npcId];
  const bs = NPC_BACKSTORIES[npcId];
  if(!npc || !bs) return;
  const rel = G.relationships[npcId];
  const interest = rel ? rel.interest : 0;

  document.getElementById('backstory-npc-name').textContent = `${npc.name}'s Story`;
  document.getElementById('backstory-unlock-hint').textContent = `Interest: ${interest}%`;

  // Chapters
  const chapHTML = bs.chapters.map((ch,i)=>{
    const locked = interest < ch.unlockAt;
    return `<div class="backstory-chapter${locked?' backstory-ch-locked':''}">
      <div class="backstory-ch-title">${locked?'üîí Chapter '+(i+1)+' ‚Äî Unlock at '+ ch.unlockAt+'% interest':ch.title}</div>
      ${locked?'<div class="backstory-ch-text" style="filter:blur(4px)">Lorem ipsum dolor sit amet, this chapter is locked until you build more connection...</div>':`<div class="backstory-ch-text">${ch.text}</div>`}
    </div>`;
  }).join('');
  document.getElementById('backstory-chapters').innerHTML = chapHTML;

  // Lore items
  G.foundLore = G.foundLore || {};
  const loreHTML = bs.lore.map(l=>{
    const found = G.foundLore[l.id];
    return `<div class="lore-item${found?' lore-item-found':''}" onclick="findLore('${npcId}','${l.id}')">
      <div class="lore-item-icon">${l.icon}</div>
      <div>
        <div style="font-size:11px;color:var(--gold);font-weight:800;margin-bottom:3px">${found?l.hint:'???  Hidden lore item ‚Äî interact more with '+npc.name+' to discover'}</div>
        <div class="lore-item-text">${found?l.text:'This context clue is hidden. Build connection to reveal it.'}</div>
      </div>
    </div>`;
  }).join('');
  document.getElementById('backstory-lore').innerHTML = loreHTML;

  document.getElementById('backstory-screen').classList.add('show');
  addToTimeline && addToTimeline(`üìñ Read ${npc.name}'s backstory`,'var(--gold)');
}

function closeBackstory() {
  document.getElementById('backstory-screen').classList.remove('show');
}

function findLore(npcId, loreId) {
  G.foundLore = G.foundLore || {};
  const rel = G.relationships[npcId];
  const interest = rel ? rel.interest : 0;
  const bs = NPC_BACKSTORIES[npcId];
  const loreItem = bs?.lore.find(l=>l.id===loreId);
  if(!loreItem) return;
  if(interest < 30) { showToast('üí° Build more connection with '+NPCS[npcId].name+' to unlock this lore!',3000); return; }
  if(G.foundLore[loreId]) { showToast('Already discovered this clue!'); return; }
  G.foundLore[loreId] = true;
  showToast(`üîç Lore discovered: "${loreItem.hint}"`,3500);
  spawnParticles && spawnParticles('stars',50,40);
  openBackstory(npcId); // refresh
  saveGame();
}

// Unlock lore automatically at certain interest thresholds
function autoUnlockLore(npcId) {
  const rel = G.relationships[npcId];
  if(!rel) return;
  const bs = NPC_BACKSTORIES[npcId];
  if(!bs) return;
  G.foundLore = G.foundLore || {};
  bs.lore.forEach((l,i)=>{
    const thresholds = [25,50,70];
    if(rel.interest >= (thresholds[i]||50) && !G.foundLore[l.id]) {
      G.foundLore[l.id] = true;
      setTimeout(()=>showToast(`üîç Lore unlocked for ${NPCS[npcId]?.name||npcId}: "${l.hint}"`,4000), i*500);
    }
  });
}

// ---- NARRATOR ----
let narratorShown = {};
function showNarrator(npcId) {
  const lines = NARRATOR_LINES[npcId];
  if(!lines) return;
  const key = npcId + '_' + (G.dialogueStep||0);
  if(narratorShown[key]) return;
  narratorShown[key] = true;
  const line = lines[Math.floor(Math.random() * lines.length)];
  const slot = document.getElementById('narrator-slot');
  if(!slot) return;
  slot.innerHTML = `<div class="narrator-bubble"><div class="narrator-label">üìñ Narrator</div>${line}</div>`;
  setTimeout(()=>{ if(slot) slot.innerHTML=''; }, 6000);
}

// ---- INNER THOUGHTS ----
let innerThoughtsLastType = 'neutral';
function showInnerThoughts() {
  const btn = document.getElementById('inner-thoughts-btn');
  const hasInsight = G.player && G.player.level >= 3;
  if(!hasInsight) {
    showToast('üß† Reach Level 3 to unlock Insight Mode!', 3000);
    btn && btn.classList.add('locked');
    return;
  }
  const npcId = G.currentNPC;
  const thoughts = INNER_THOUGHTS[npcId];
  if(!thoughts) return;
  const pool = thoughts[innerThoughtsLastType] || thoughts.neutral;
  const thought = pool[Math.floor(Math.random()*pool.length)];
  const slot = document.getElementById('inner-thoughts-slot');
  if(!slot) return;
  slot.innerHTML = `<div class="inner-thoughts-bubble"><div class="inner-thoughts-label">üß† What she's really thinking...</div>${thought}</div>`;
  setTimeout(()=>{ if(slot) slot.innerHTML=''; }, 5000);
  updateInnerThoughtsBtn();
}

function updateInnerThoughtsBtn() {
  const btn = document.getElementById('inner-thoughts-btn');
  if(!btn) return;
  const hasInsight = G.player && G.player.level >= 3;
  btn.classList.toggle('locked', !hasInsight);
  btn.title = hasInsight ? "What is she really thinking?" : "Reach Level 3 to unlock";
}

// ---- CROSSOVER SCENES ----
let activeCrossover = null;
function checkCrossoverScene() {
  if(G.crossoverUsed && G.crossoverUsed.length >= CROSSOVER_SCENES.length) return;
  G.crossoverUsed = G.crossoverUsed || [];
  for(const scene of CROSSOVER_SCENES) {
    if(G.crossoverUsed.includes(scene.id)) continue;
    const t = scene.trigger;
    const rel1 = G.relationships[t.npc1];
    const rel2 = G.relationships[t.npc2];
    if(rel1 && rel2 && rel1.met && rel2.met && rel1.interest >= t.minInterest && rel2.interest >= t.minInterest) {
      if(Math.random() < 0.3) { triggerCrossover(scene); return; }
    }
  }
}

function triggerCrossover(scene) {
  activeCrossover = scene;
  G.crossoverUsed = G.crossoverUsed || [];
  G.crossoverUsed.push(scene.id);
  document.getElementById('crossover-emoji').textContent = scene.emoji;
  document.getElementById('crossover-title').textContent = scene.title;
  document.getElementById('crossover-text').textContent = scene.text;
  document.getElementById('crossover-choices').innerHTML = scene.choices.map((c,i)=>`
    <button class="btn-secondary" style="text-align:left;font-size:12px;padding:10px 12px" onclick="pickCrossoverChoice(${i})">${c.text}</button>`).join('');
  document.getElementById('crossover-overlay').classList.add('show');
  addToTimeline && addToTimeline(`‚ö° Crossover scene: ${scene.title}`,'var(--pink)');
}

function pickCrossoverChoice(idx) {
  if(!activeCrossover) return;
  const choice = activeCrossover.choices[idx];
  Object.entries(choice.boost||{}).forEach(([npcId,val])=>{
    const rel = G.relationships[npcId];
    if(rel) rel.interest = Math.min(100, rel.interest + val);
  });
  updateStats && updateStats();
  showToast(choice.toast || 'Interesting!', 3000);
  spawnParticles && spawnParticles('stars', 50, 40);
  closeCrossover();
  saveGame && saveGame();
}

function closeCrossover() {
  document.getElementById('crossover-overlay').classList.remove('show');
  activeCrossover = null;
}

// ---- SECRET NPC UNLOCK ----
function checkSecretNpcUnlock() {
  const completed = Object.keys(G.relationships||{}).filter(id=>{
    if(id==='adaeze') return false;
    const rel = G.relationships[id];
    return rel && rel.met && (rel.interest >= 60 || G.completedLocations?.has(id));
  });
  if(completed.length >= 3 && !G.adaezeUnlocked) {
    G.adaezeUnlocked = true;
    G.relationships['adaeze'] = { interest:10, met:false, status:'Stranger', dated:false, memories:[], phoneStep:0, broken:false };
    showToast('üé® A new location appeared on the map ‚Äî Art Gallery! Who could be there? üñºÔ∏è', 5000);
    spawnParticles && spawnParticles('confetti', 50, 30);
    addToTimeline && addToTimeline('üé® Secret NPC Adaeze unlocked!','#6D28D9');
    buildMapScreen();
    saveGame && saveGame();
  }
}

// ---- NEW GAME+ MODIFICATIONS ----
function applyNGPlusToChoices(choices) {
  if(SETTINGS.difficulty !== 'ngplus') return choices;
  // Add harder versions and extra ambiguous choices
  return choices.map(c => {
    if(c.type === 'good') {
      return { ...c, cd: Math.round(c.cd * 0.7), text: c.text + ' [NG+: She\'s harder to impress]' };
    }
    if(c.type === 'bad') return { ...c, cd: Math.round(c.cd * 1.5) };
    return c;
  }).concat([{
    text: 'üåÄ [NG+] The bold gamble ‚Äî high risk, high reward...',
    type: 'neutral',
    cd: Math.random() > 0.5 ? 20 : -20,
    st: 1,
    ngplus: true,
    lesson: 'New Game+ gamble: outcomes are unpredictable.'
  }]);
}

// ---- BUILD MAP WITH SECRET NPC ----
const _origBuildMapScreen = window.buildMapScreen;

// ---- PATCH visitLocation FOR SECRET NPC + CROSSOVERS ----
const _origVisitLocationV6 = window.visitLocation;
function visitLocation(npcId) {
  // Check if secret NPC is locked
  if(npcId === 'adaeze' && !G.adaezeUnlocked) {
    showToast('üîí Complete 3 story paths to unlock this location...', 3000);
    return;
  }
  _origVisitLocationV6 && _origVisitLocationV6(npcId);
  // After visiting, show narrator
  setTimeout(()=>showNarrator(npcId), 800);
  // Check for crossover scenes
  if(G.day > 4) setTimeout(()=>checkCrossoverScene(), 3000);
  // Auto-unlock lore
  setTimeout(()=>autoUnlockLore(npcId), 500);
  // Check secret NPC
  setTimeout(()=>checkSecretNpcUnlock(), 200);
}

// ---- PATCH showDialogue FOR INNER THOUGHTS + NG+ + NARRATOR ----
const _origShowDialogueV6 = window.showDialogue;
function showDialogue(step) {
  _origShowDialogueV6 && _origShowDialogueV6(step);
  // Clear inner thoughts slot
  const its = document.getElementById('inner-thoughts-slot');
  if(its) its.innerHTML = '';
  // Update inner thoughts button state
  updateInnerThoughtsBtn();
  // Show narrator (30% chance after step 0)
  if(step > 0 && Math.random() < 0.3) setTimeout(()=>showNarrator(G.currentNPC), 1500);
}

// ---- PATCH renderChoices FOR NG+ AND DIFFICULTY ----
const _origRenderChoices = window.renderChoices;
function renderChoices(choices) {
  let finalChoices = choices;
  if(SETTINGS.difficulty === 'ngplus') finalChoices = applyNGPlusToChoices(choices);
  _origRenderChoices && _origRenderChoices.call(window, finalChoices);
}

// ---- PATCH makeChoice FOR DIFFICULTY MULTIPLIER + INNER THOUGHTS UPDATE ----
const _origMakeChoiceV6 = window.makeChoice;
function makeChoice(idx, hasExtra) {
  // Get choice type before calling original
  const npc = NPCS[G.currentNPC];
  const lang = G.player?.lang || 'english';
  const dialogues = npc?.dialogue[lang] || npc?.dialogue?.english;
  const d = dialogues?.[G.dialogueStep];
  let choices = d?.choices || [];
  if(hasExtra && G.skills?.smooth_talker && G.dialogueStep===0) choices=[...choices,{text:'I\'ve been looking forward to meeting you!',type:'good',cd:15,st:1}];
  if(SETTINGS.difficulty==='ngplus') choices=applyNGPlusToChoices(choices);
  const choice = choices[idx];
  const choiceType = choice?.type || 'neutral';
  innerThoughtsLastType = choiceType === 'pidgin' ? 'good' : choiceType;

  _origMakeChoiceV6 && _origMakeChoiceV6(idx, hasExtra);

  // Apply difficulty multiplier note (delta already applied in original, show toast addition)
  if(SETTINGS.difficulty === 'hard' && choiceType === 'good') showToast('üî• Hard Mode: gains reduced',1500);
  if(SETTINGS.difficulty === 'casual' && choiceType === 'bad') showToast('üòå Casual Mode: softened the blow',1500);

  // Check milestone for secret NPC unlock
  setTimeout(()=>checkSecretNpcUnlock(), 100);
  // Auto unlock lore
  setTimeout(()=>autoUnlockLore(G.currentNPC), 200);
}

// ---- JOURNAL: backstory buttons are inline in buildJournal (V6) ----

// ---- BUILDMAPSCREEN: SECRET NPC PIN ----
const _origBuildMapV6 = window.buildMapScreen;
function buildMapScreen() {
  _origBuildMapV6 && _origBuildMapV6();
  // Add secret NPC pin if unlocked
  if(G.adaezeUnlocked) {
    const container = document.getElementById('map-container');
    if(!container) return;
    const existing = container.querySelector('.adaeze-pin');
    if(existing) return;
    const pin = document.createElement('div');
    pin.className='location-pin adaeze-pin';
    pin.style.cssText='left:38%;top:48%;animation:pin-bounce 2s ease-in-out infinite;';
    pin.innerHTML=`<div class="pin-icon" style="background:#6D28D9">üñºÔ∏è</div><div class="pin-label">Art Gallery</div><div style="font-size:8px;background:linear-gradient(135deg,#7c3aed,#db2777);color:white;padding:1px 6px;border-radius:5px;text-align:center;margin-top:2px">SECRET üîì</div>`;
    pin.onclick=()=>visitLocation('adaeze');
    container.appendChild(pin);
  }
}

// ---- INIT V6 ----
function initV6Features() {
  loadSettings();
  if(!G.foundLore) G.foundLore = {};
  if(!G.crossoverUsed) G.crossoverUsed = [];
  if(!G.tutorialDone) G.tutorialDone = false;
  if(SETTINGS.difficulty === 'ngplus') {
    const bar = document.getElementById('ng-plus-bar');
    if(bar) bar.style.display='flex';
  }
  // Ensure adaeze relationship exists if unlocked
  if(G.adaezeUnlocked && !G.relationships?.adaeze) {
    G.relationships['adaeze'] = { interest:10, met:false, status:'Stranger', dated:false, memories:[], phoneStep:0, broken:false };
  }
}

// ============================================================
// STARS
// ============================================================
function createStars() {
  const c=document.getElementById('stars');
  for(let i=0;i<70;i++){
    const s=document.createElement('div');
    s.className='star';
    s.style.cssText=`left:${Math.random()*100}%;top:${Math.random()*100}%;animation-delay:${Math.random()*3}s;animation-duration:${1.5+Math.random()*2}s;opacity:${Math.random()*0.5};width:${1+Math.random()*3}px;height:${1+Math.random()*3}px;`;
    c.appendChild(s);
  }
}

// ============================================================
// INIT
// ============================================================
createStars();
buildTips();
initV5Features();
initV6Features();
</script>
</body>
</html>
